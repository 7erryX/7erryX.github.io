<!DOCTYPE html><html lang="en, zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="Blog, Security, Vulnerability, Flaw, Life, Software, Research, Tech"><meta name="author" content="7erry"><script>!function(){const e="dark";function t(t){const o=t===e,c=document.documentElement;c.setAttribute("data-theme",t),c.classList.add(t),c.classList.remove(o?"light":e),c.style.colorScheme=t}const o=function(){try{const t=localStorage.getItem("REDEFINE-THEME-STATUS");if(t){const{isDark:o}=JSON.parse(t);return o?e:"light"}}catch(e){}return matchMedia("(prefers-color-scheme: dark)").matches?e:"light"}();t(o),matchMedia("(prefers-color-scheme: dark)").addEventListener("change",({matches:o})=>{localStorage.getItem("REDEFINE-THEME-STATUS")||t(o?e:"light")}),"loading"!==document.readyState?document.body.classList.add(o+"-mode"):document.addEventListener("DOMContentLoaded",()=>{document.body.classList.add(o+"-mode"),document.body.classList.remove((o===e?"light":e)+"-mode")})}()</script><style>:root[data-theme=dark]{--background-color:#202124;--background-color-transparent:rgba(32, 33, 36, 0.6);--second-background-color:#2d2e32;--third-background-color:#34353a;--third-background-color-transparent:rgba(32, 33, 36, 0.6);--primary-color:#0066CC;--first-text-color:#ffffff;--second-text-color:#eeeeee;--third-text-color:#bebec6;--fourth-text-color:#999999;--default-text-color:#bebec6;--invert-text-color:#373D3F;--border-color:rgba(255, 255, 255, 0.08);--selection-color:#0066CC;--shadow-color-1:rgba(255, 255, 255, 0.08);--shadow-color-2:rgba(255, 255, 255, 0.05)}:root[data-theme=light]{--background-color:#fff;--background-color-transparent:rgba(255, 255, 255, 0.6);--second-background-color:#f8f8f8;--third-background-color:#f2f2f2;--third-background-color-transparent:rgba(241, 241, 241, 0.6);--primary-color:#0066CC;--first-text-color:#16171a;--second-text-color:#2f3037;--third-text-color:#5e5e5e;--fourth-text-color:#eeeeee;--default-text-color:#373D3F;--invert-text-color:#bebec6;--border-color:rgba(0, 0, 0, 0.08);--selection-color:#0066CC;--shadow-color-1:rgba(0, 0, 0, 0.08);--shadow-color-2:rgba(0, 0, 0, 0.05)}body{background-color:var(--background-color);color:var(--default-text-color)}:root[data-theme=dark] body{background-color:var(--background-color);color:var(--default-text-color)}</style><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="canonical" href="https://7erryX.github.io/2024/05/10/tech blog/re-从0开始阅读flask源码-ⅳ/"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><meta name="revisit-after" content="1 days"><meta name="description" content="(v50) 経験に3を加えて,失礼します [中国翻訳] [無修正]"><meta property="og:type" content="article"><meta property="og:title" content="RE:从0开始阅读Flask源码 Ⅳ"><meta property="og:url" content="https://7erryx.github.io/2024/05/10/Tech%20Blog/RE-%E4%BB%8E0%E5%BC%80%E5%A7%8B%E9%98%85%E8%AF%BBFlask%E6%BA%90%E7%A0%81-%E2%85%A3/index.html"><meta property="og:site_name" content="7erry&#39;s Website"><meta property="og:description" content="(v50) 経験に3を加えて,失礼します [中国翻訳] [無修正]"><meta property="og:locale"><meta property="og:image" content="https://7erryx.github.io/images/default_avatar.png"><meta property="article:published_time" content="2024-05-10T14:26:02.000Z"><meta property="article:modified_time" content="2024-05-10T14:26:02.000Z"><meta property="article:author" content="7erry"><meta property="article:tag" content="Blog, Security, Vulnerability, Flaw, Life, Software, Research, Tech"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://7erryx.github.io/images/default_avatar.png"><link rel="icon" type="image/png" href="/images/favicon.ico" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico"><meta name="theme-color" content="#A31F34"><link rel="shortcut icon" href="/images/favicon.ico"><title>RE:从0开始阅读Flask源码 Ⅳ | 7erry&#39;s Website</title><link rel="stylesheet" href="/fonts/Chillax/chillax.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/build/tailwind.css"><link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css"><link rel="stylesheet" href="/fonts/Geist/geist.css"><script src="/js/build/libs/anime.min.js"></script><script id="hexo-configurations">window.config={hostname:"7erryx.github.io",root:"/",language:"en, zh-CN",path:"search.json"},window.theme={articles:{style:{font_size:"16px",line_height:1.5,image_border_radius:"14px",image_alignment:"center",image_caption:!1,link_icon:!0,delete_mask:!1,title_alignment:"left",headings_top_spacing:{h1:"5rem",h2:"4rem",h3:"2.8rem",h4:"2.5rem",h5:"2.2rem",h6:"2rem"}},word_count:{enable:!0,count:!0,min2read:!0},author_label:{enable:!1,auto:!1,list:[]},code_block:{copy:!0,style:"simple",highlight_theme:{light:"github",dark:"github-dark"},font:{enable:!1,family:null,url:null}},toc:{enable:!0,max_depth:3,number:!1,expand:!0,init_open:!0},copyright:{enable:!0,default:"cc_by_nc_sa"},lazyload:!0,pangu_js:!1,recommendation:{enable:!1,title:"推荐阅读",limit:3,mobile_limit:2,placeholder:"/images/wallhaven-wqery6-light.webp",skip_dirs:[]}},colors:{primary:"#A31F34",secondary:null,default_mode:"light"},global:{fonts:{chinese:{enable:!1,family:null,url:null},english:{enable:!1,family:null,url:null},title:{enable:!1,family:null,url:null}},content_max_width:"1000px",sidebar_width:"210px",hover:{shadow:!0,scale:!1},scroll_progress:{bar:!1,percentage:!0},website_counter:{url:"https://cn.vercount.one/js",enable:!0,site_pv:!0,site_uv:!0,post_pv:!0},single_page:!0,preloader:{enable:!0,custom_message:null},side_tools:{gear_rotation:!0,auto_expand:!1},open_graph:{enable:!0,image:"/images/default_avatar.png",description:"(v50) 経験に3を加えて,失礼します [中国翻訳] [無修正]"},google_analytics:{enable:!1,id:null}},home_banner:{enable:!0,style:"fixed",image:{light:"/images/background_light.jpg",dark:"/images/background_dark.jpg"},title:"7erry's Website",subtitle:{text:["君子慎独","君子不器","我的人生烷基八氮了","Fall in Love with the Problem, Not the Solution","Do The Right Thing，Do The Thing Right","Lux et veritas","Mens et Manus","Per Aspera Ad Astra","(v50) 経験に3を加えて，失礼します [中国翻訳] [無修正]","呐呐呐，你听说过二刺螈吗?","取势，明道，优术","做难而正确的事"],hitokoto:{enable:!1,show_author:!1,api:"https://v1.hitokoto.cn"},typing_speed:100,backing_speed:80,starting_delay:500,backing_delay:1500,loop:!0,smart_backspace:!0},text_color:{light:"#000",dark:"#fff"},text_style:{title_size:"5.7rem",subtitle_size:"1.9rem",line_height:1.1},custom_font:{enable:!1,family:null,url:null},social_links:{enable:!0,style:"default",links:{github:"https://github.com/7erryX",instagram:null,zhihu:null,twitter:null,email:"w.7erry@qq.com",bilibili:"https://space.bilibili.com/25689965"},qrs:null}},plugins:{feed:{enable:!1},aplayer:{enable:!1,type:"fixed",audios:[{name:null,artist:null,url:null,cover:null,lrc:null}]},mermaid:{enable:!0,version:"9.3.0"}},version:"2.8.4",navbar:{auto_hide:!0,color:{left:"#7ab8cc",right:"#367df7",transparency:35},width:{home:"1200px",pages:"1000px"},links:{Home:{path:"/",icon:"fa-regular fa-house"},Archives:{path:"/archives",icon:"fa-regular fa-archive"},Anime:{path:"/bangumis",icon:"fa-brands fa-youtube"},Cinema:{path:"/cinemas",icon:"fa-solid fa-film"},About:{path:"/about",icon:"fa-regular fa-user"}},search:{enable:!0,preload:!0}},page_templates:{friends_column:2,tags_style:"blur"},home:{sidebar:{enable:!0,position:"left",first_item:"info",announcement:null,show_on_mobile:!0,links:{Archives:{path:"/archives",icon:"fa-regular fa-archive"},Categories:{path:"/categories",icon:"fa-regular fa-folder"}}},article_date_format:"auto",excerpt_length:200,categories:{enable:!0,limit:1},tags:{enable:!1,limit:3}},footerStart:"2020/2/2 20:20:22"},window.lang_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"},window.data={masonry:!1}</script><link rel="stylesheet" href="/fontawesome/fontawesome.min.css"><link rel="stylesheet" href="/fontawesome/brands.min.css"><link rel="stylesheet" href="/fontawesome/solid.min.css"><link rel="stylesheet" href="/fontawesome/regular.min.css"><meta name="generator" content="Hexo 8.0.0"></head><body><div class="progress-bar-container"><span class="pjax-progress-bar"></span></div><style>:root{--preloader-background-color:#fff;--preloader-text-color:#000}@media (prefers-color-scheme:dark){:root{--preloader-background-color:#202124;--preloader-text-color:#fff}}@media (prefers-color-scheme:light){:root{--preloader-background-color:#fff;--preloader-text-color:#000}}@media (max-width:600px){.ml13{font-size:2.6rem!important}}.preloader{display:flex;flex-direction:column;gap:1rem;align-items:center;justify-content:center;position:fixed;padding:12px;top:0;right:0;bottom:0;left:0;width:100vw;height:100vh;background-color:var(--preloader-background-color);z-index:1100;transition:opacity .2s ease-in-out}.ml13{font-size:3.2rem;color:var(--preloader-text-color);letter-spacing:-1px;font-weight:500;font-family:Chillax-Variable,sans-serif;text-align:center}.ml13 .word{display:inline-flex;flex-wrap:wrap;white-space:nowrap}.ml13 .letter{display:inline-block;line-height:1em}</style><div class="preloader"><h2 class="ml13">7erry&#39;s Website</h2><script>var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });

        var animation = anime.timeline({ loop: true })
            .add({
                targets: '.ml13 .letter',
                translateY: [20, 0],
                translateZ: 0,
                opacity: [0, 1],
                filter: ['blur(5px)', 'blur(0px)'],
                easing: "easeOutExpo",
                duration: 1200,
                delay: (el, i) => 300 + 20 * i,
            })
            .add({
                targets: '.ml13 .letter',
                translateY: [0, -20],
                opacity: [1, 0],
                filter: ['blur(0px)', 'blur(5px)'],
                easing: "easeInExpo",
                duration: 1000,
                delay: (el, i) => 15 * i,
                complete: function() {
                    hidePreloader();
                }
            }, '-=700');


        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            setTimeout(hidePreloader, 5000); // Call hidePreloader after 5000 milliseconds if not already called by animation
        });

        function hidePreloader() {
            var preloader = document.querySelector('.preloader');
            preloader.style.opacity = '0';
            setTimeout(function () {
                preloader.style.display = 'none';
            }, 200);
        }</script></div><main class="page-container" id="swup"><div class="main-content-container flex flex-col justify-between min-h-dvh"><div class="main-content-header"><header class="navbar-container px-6 md:px-12"><div class="navbar-content transition-navbar"><div class="left"><a class="logo-image h-8 w-8 sm:w-10 sm:h-10 mr-3" href="/"><img src="/images/favicon.ico" class="w-full h-full rounded-xs"> </a><a class="logo-title" href="/">7erry&#39;s Website</a></div><div class="right"><div class="desktop"><ul class="navbar-list"><li class="navbar-item"><a href="/"><i class="fa-regular fa-house fa-fw"></i> HOME</a></li><li class="navbar-item"><a href="/archives"><i class="fa-regular fa-archive fa-fw"></i> ARCHIVES</a></li><li class="navbar-item"><a href="/bangumis"><i class="fa-brands fa-youtube fa-fw"></i> ANIME</a></li><li class="navbar-item"><a href="/cinemas"><i class="fa-solid fa-film fa-fw"></i> CINEMA</a></li><li class="navbar-item"><a href="/about"><i class="fa-regular fa-user fa-fw"></i> ABOUT</a></li><li class="navbar-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div><div class="icon-item navbar-bar"><div class="navbar-bar-middle"></div></div></div></div></div><div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between"><ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start"><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/"><span>HOME </span><i class="fa-regular fa-house fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/archives"><span>ARCHIVES </span><i class="fa-regular fa-archive fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/bangumis"><span>ANIME </span><i class="fa-brands fa-youtube fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/cinemas"><span>CINEMA </span><i class="fa-solid fa-film fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/about"><span>ABOUT </span><i class="fa-regular fa-user fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active" href="/categories"><span>Categories</span> <i class="fa-regular fa-folder fa-sm fa-fw"></i></a></li></ul><div class="statistics flex justify-around my-2.5"><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div><div class="label text-third-text-color text-sm">Tags</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">4</div><div class="label text-third-text-color text-sm">Categories</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">72</div><div class="label text-third-text-color text-sm">Posts</div></a></div></div><div class="window-mask"></div></header></div><div class="main-content-body transition-fade-up"><div class="main-content"><div class="post-page-container flex relative justify-between box-border w-full h-full"><div class="article-content-container"><div class="article-title relative w-full"><div class="w-full flex items-center pt-6 justify-start"><h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">RE:从0开始阅读Flask源码 Ⅳ</h1></div></div><div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8"><div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]"><img src="/images/default_avatar.png"></div><div class="info flex flex-col justify-between"><div class="author flex items-center"><span class="name text-default-text-color text-lg font-semibold">7erry</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-pen-fancy"></i>&nbsp; <span class="desktop">2024-05-10 22:26:02</span> <span class="mobile">2024-05-10 22:26:02</span> <span class="hover-info">Created</span> </span><span class="article-date article-meta-item"><i class="fa-regular fa-wrench"></i>&nbsp; <span class="desktop">2024-05-10 22:26:02</span> <span class="mobile">2024-05-10 22:26:02</span> <span class="hover-info">Updated</span> </span><span class="article-categories article-meta-item"><i class="fa-regular fa-folders"></i>&nbsp;<ul><li><a href="/categories/Tech-Blog/">Tech Blog</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fa-regular fa-typewriter"></i>&nbsp;<span>3.6k Words</span> </span><span class="article-min2read article-meta-item"><i class="fa-regular fa-clock"></i>&nbsp;<span>16 Mins</span> </span><span class="article-pv article-meta-item"><i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8"><p>程序的本质就是指令+上下文。</p><p>作为一个 Web Application ，Flask 也必然有着自己的上下文。例如视图函数需要知道包括请求的方法，路径，参数等请求信息的上下文才能够正常的工作。如果你有过其它语言的编程经验，就会很容易想到通过在调用这些函数时在参数中传递相关的数据或这些数据的指针来为函数提供这些必要的上下文信息。如果这门语言支持 OOP ，那么这些请求相关的信息还可以被封装到请求的抽象类中。事实上，确实有不少框架是这样做的，例如 <a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://sanic.dev/en/">sanic<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 。但这样设计上下文的话，视图函数应该会长成这样</p><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># demo.py</span></span><br><span class="line"><span class="meta">@app.route(<span class="params">path</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">view_function</span>(<span class="params">request</span>):</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></div><p>也就是说，视图函数应该有 <code>request</code> 这么一个参数才对，但从 Flask Demo 中我们并没有发现这样一个参数。显然，Flask 采用了另外一种不同的实现方式。</p><span id="more"></span><h2 id="Flask-上下文的实现"><a href="#Flask-上下文的实现" class="headerlink" title="Flask 上下文的实现"></a>Flask 上下文的实现</h2><p>Flask 的上下文由类似于全局变量的方式实现，这些全局变量可以通过导入对应模块进行访问。</p><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># demo.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>,endpoint=<span class="string">&quot;root&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(request)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello！&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>显然，这个全局变量必然需要进行某些设计，例如不同线程或协程之间的上下文应该各自保持独立以避免脏读脏写或竞争。同时这样的全局变量应当有多个，因为 Flask 的不同模块都有着自己不同用途的上下文需要处理。通过阅读源码可以发现这些全局变量都在 globals.py 中被定义，它的内容非常简单，具体如下</p><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># globals.py</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> typing <span class="keyword">as</span> t</span><br><span class="line"><span class="keyword">from</span> contextvars <span class="keyword">import</span> ContextVar</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> werkzeug.local <span class="keyword">import</span> LocalProxy</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> t.TYPE_CHECKING:  <span class="comment"># pragma: no cover</span></span><br><span class="line">    <span class="keyword">from</span> .app <span class="keyword">import</span> Flask</span><br><span class="line">    <span class="keyword">from</span> .ctx <span class="keyword">import</span> _AppCtxGlobals</span><br><span class="line">    <span class="keyword">from</span> .ctx <span class="keyword">import</span> AppContext</span><br><span class="line">    <span class="keyword">from</span> .ctx <span class="keyword">import</span> RequestContext</span><br><span class="line">    <span class="keyword">from</span> .sessions <span class="keyword">import</span> SessionMixin</span><br><span class="line">    <span class="keyword">from</span> .wrappers <span class="keyword">import</span> Request</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_no_app_msg = <span class="string">&quot;&quot;&quot;\</span></span><br><span class="line"><span class="string">Working outside of application context.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This typically means that you attempted to use functionality that needed</span></span><br><span class="line"><span class="string">the current application. To solve this, set up an application context</span></span><br><span class="line"><span class="string">with app.app_context(). See the documentation for more information.\</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">_cv_app: ContextVar[AppContext] = ContextVar(<span class="string">&quot;flask.app_ctx&quot;</span>)</span><br><span class="line">app_ctx: AppContext = LocalProxy(  <span class="comment"># type: ignore[assignment]</span></span><br><span class="line">    _cv_app, unbound_message=_no_app_msg</span><br><span class="line">)</span><br><span class="line">current_app: Flask = LocalProxy(  <span class="comment"># type: ignore[assignment]</span></span><br><span class="line">    _cv_app, <span class="string">&quot;app&quot;</span>, unbound_message=_no_app_msg</span><br><span class="line">)</span><br><span class="line">g: _AppCtxGlobals = LocalProxy(  <span class="comment"># type: ignore[assignment]</span></span><br><span class="line">    _cv_app, <span class="string">&quot;g&quot;</span>, unbound_message=_no_app_msg</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">_no_req_msg = <span class="string">&quot;&quot;&quot;\</span></span><br><span class="line"><span class="string">Working outside of request context.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This typically means that you attempted to use functionality that needed</span></span><br><span class="line"><span class="string">an active HTTP request. Consult the documentation on testing for</span></span><br><span class="line"><span class="string">information about how to avoid this problem.\</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">_cv_request: ContextVar[RequestContext] = ContextVar(<span class="string">&quot;flask.request_ctx&quot;</span>)</span><br><span class="line">request_ctx: RequestContext = LocalProxy(  <span class="comment"># type: ignore[assignment]</span></span><br><span class="line">    _cv_request, unbound_message=_no_req_msg</span><br><span class="line">)</span><br><span class="line">request: Request = LocalProxy(  <span class="comment"># type: ignore[assignment]</span></span><br><span class="line">    _cv_request, <span class="string">&quot;request&quot;</span>, unbound_message=_no_req_msg</span><br><span class="line">)</span><br><span class="line">session: SessionMixin = LocalProxy(  <span class="comment"># type: ignore[assignment]</span></span><br><span class="line">    _cv_request, <span class="string">&quot;session&quot;</span>, unbound_message=_no_req_msg</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div><p>我们能够从源代码中看出，globals.py 首先创建了两个与上下文有关的错误信息与变量，<code>_cv_app</code> 与 <code>_cv_request</code>，随后通过它们创建了另外六个变量，即 <code>app_ctx</code>, <code>current_app</code>, <code>g</code>, <code>request_ctx</code>, <code>request</code> 和 <code>session</code>。这些全局变量尽管类型有所区别，但都由 LocalProxy 这个代理所操作的对象产生，查看其对应的签名可以发现其操作的对象所属的类分别与 <code>_cv_app</code> 和 <code>_cv_request</code> 一致</p><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># local.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LocalProxy</span>(</span><br><span class="line">    local: ContextVar[AppContext] | Local | LocalStack[AppContext] | (() -&gt; AppContext),</span><br><span class="line">    name: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span>,</span><br><span class="line">    *,</span><br><span class="line">    unbound_message: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LocalProxy</span>(</span><br><span class="line">    local: ContextVar[RequestContext] | Local | LocalStack[RequestContext] | (() -&gt; RequestContext),</span><br><span class="line">    name: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span>,</span><br><span class="line">    *,</span><br><span class="line">    unbound_message: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></div><p>分别阅读这两个类的注释</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># ctx.py</span><br><span class="line">AppContext</span><br><span class="line">The app context contains application-specific information. An app context is created and pushed at the beginning of each request if one is not already active. An app context is also pushed when running CLI commands.</span><br><span class="line"></span><br><span class="line">RequestContext</span><br><span class="line">The request context contains per-request information. The Flask app creates and pushes it at the beginning of the request, then pops it at the end of the request. It will create the URL adapter and request object for the WSGI environment provided.</span><br><span class="line"></span><br><span class="line">Do not attempt to use this class directly, instead use ~flask.Flask.test_request_context and ~flask.Flask.request_context to create this object.</span><br><span class="line"></span><br><span class="line">When the request context is popped, it will evaluate all the functions registered on the application for teardown execution (~flask.Flask.teardown_request).</span><br><span class="line"></span><br><span class="line">The request context is automatically popped at the end of the request. When using the interactive debugger, the context will be restored so request is still accessible. Similarly, the test client can preserve the context after the request ends. However, teardown functions may already have closed some resources such as database connections.</span><br></pre></td></tr></table></figure></div><p>也就是说，Flask 中的上下文主要分为两类，<code>AppContext</code> 和 <code>RequestContext</code>，其中前者代表了应用级别的上下文，后者代表了请求级别的上下文。这两类上下文包含了六个全局变量，尽管我们目前还不理解这六个全局变量的具体功能（其实看变量名也能大概理解），但能够确定它们的实质是来自 WerkZeug 的 <code>LocalProxy</code> 类（见第 6 行）的实例。这是非常合理的，因为尽管 Flask 已经支持使用其它的 WSGI Server，但 Flask 仍是基于一个 WerkZeug 的 WSGI Application，直接使用 WerkZeug 提供的上下文实现作为自己的上下文实现确实是一件非常自然的事</p><blockquote><p>这两级上下文的概念在 <a href="#reference">Flask 的文档说明</a> 中有着详细的解释，在此就不过多赘述。</p></blockquote><h2 id="线程上下文与-WerkZeug-上下文的实现"><a href="#线程上下文与-WerkZeug-上下文的实现" class="headerlink" title="线程上下文与 WerkZeug 上下文的实现"></a>线程上下文与 WerkZeug 上下文的实现</h2><p>阅读了 globals.py 中的代码后不难看出，为了理解 Flask 上下文的实现，我们的下一个目标就是探索 <code>LocalProxy</code> 这个类。但在此之前，我们需要先从线程上下文的实现方式谈起。为了避免不同线程共用同一上下文时产生竞争或未定义行为，程序往往需要实现一个能够线程隔离的上下文。一个容易想到的实现方式是，使用一个字典存储本线程的上下文，再使用一个以各个线程的线程 ID 为键，以该线程 ID 对应的线程的上下文作为值的字典来存储所有线程的上下文。这样，每个线程只需要以自己的线程 ID 为索引，便可以分别从同一全局变量中访问自己的上下文，且不同线程的上下文彼此隔离。</p><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadLocal</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># self.storage = &#123;&#125;</span></span><br><span class="line">        <span class="built_in">object</span>.__setattr__(<span class="variable language_">self</span>,<span class="string">&quot;storage&quot;</span>,&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setattr__</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        ident = threading.get_ident()</span><br><span class="line">        <span class="variable language_">self</span>.storage.setdefault(ident,&#123;&#125;)[key] = value</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self,item</span>):</span><br><span class="line">        ident = threading.get_ident()</span><br><span class="line">        <span class="keyword">if</span> ident <span class="keyword">not</span> <span class="keyword">in</span> <span class="variable language_">self</span>.storage:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.storage[ident].get(item)        </span><br></pre></td></tr></table></figure></div><p>这是一个较为简单的基于嵌套线程上下文的实现，其中每一个线程的上下文都是独立的。这一点可以借由下列 POC 验证</p><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">local = ThreadLocal()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task</span>(<span class="params">arg</span>):</span><br><span class="line">    local.key = arg</span><br><span class="line">    <span class="built_in">print</span>(local.key)</span><br><span class="line"></span><br><span class="line">task_list = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    t = threading.Thread(target=task(i))</span><br><span class="line">    t.start()</span><br><span class="line">    task_list.append(t)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> task_list:</span><br><span class="line">    t.join()</span><br></pre></td></tr></table></figure></div><p>它的输出应该是</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td></tr></table></figure></div><p>实际上，Python 内置的 <code>ThreadLocal</code> 就是以类似的方式实现的，它可以通过 <code>threading.local()</code> 获取。而 WerkZeug 并没有直接使用 <code>threading.local</code>，而是自行实现了略有区别的 <code>werkzeug.local.Local</code> 类，还实现了 <code>LocalStack</code> 和 <code>LocalProxy</code> 这两种新的数据结构。<code>Local</code> 类与我们的 <code>ThreadLocal</code> 一样使用了一个字典来保存本线程的上下文以提供属性访问，而 <code>LocalStack</code> 则是使用了一个栈来保存本线程上下文以提供栈访问，除此以外大同小异。<code>LocalProxy</code> 类主要用于代理它的 <code>Local</code> 对象或 <code>LocalStack</code> 对象，负责把所有对自己的操作转发给内部的 <code>Local</code> 对象或 <code>LocalStack</code> 对象。其实现方式不在本文的讨论范围之内，故在此不再深究。</p><p>Flask 主要通过 <code>LocalProxy</code> 来操作 <code>LocalStack</code> 以存储上下文对象，其目的在于兼容多 application 的使用情况。当多个 Flask Application 同时运行时，当前应用的上下文需要动态更新，而使用栈存储上下文可以确保当前运行的上下文的准确</p><h2 id="Flask-上下文的管理"><a href="#Flask-上下文的管理" class="headerlink" title="Flask 上下文的管理"></a>Flask 上下文的管理</h2><p>在 <a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="http://7erry.com/2024/04/11/RE-%E4%BB%8E0%E5%BC%80%E5%A7%8B%E9%98%85%E8%AF%BBFlask%E6%BA%90%E7%A0%81-%E2%85%A1/#%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86">RE: 从 0 开始阅读 Flask 源码 Ⅱ<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 中我们已经了解了 Flask 请求-响应循环的工作流程，而在这一流程的第一步，WSGI Server 调用 WSGI Application 时，我们便已经能够看到上下文的身影</p><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app.py</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">request_context</span>(<span class="params">self, environ: WSGIEnvironment</span>) -&gt; RequestContext:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Create a :class:`~flask.ctx.RequestContext` representing a</span></span><br><span class="line"><span class="string">    WSGI environment. Use a ``with`` block to push the context,</span></span><br><span class="line"><span class="string">    which will make :data:`request` point at this request.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    See :doc:`/reqcontext`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Typically you should not call this from your own code. A request</span></span><br><span class="line"><span class="string">    context is automatically pushed by the :meth:`wsgi_app` when</span></span><br><span class="line"><span class="string">    handling a request. Use :meth:`test_request_context` to create</span></span><br><span class="line"><span class="string">    an environment and context instead of this method.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param environ: a WSGI environment</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> RequestContext(<span class="variable language_">self</span>, environ)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">wsgi_app</span>(<span class="params"></span></span><br><span class="line"><span class="params">    self, environ: WSGIEnvironment, start_response: StartResponse</span></span><br><span class="line"><span class="params"></span>) -&gt; cabc.Iterable[<span class="built_in">bytes</span>]:</span><br><span class="line">    ctx = <span class="variable language_">self</span>.request_context(environ)</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ctx.push()</span><br><span class="line">            ...</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            ...</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        ...</span><br><span class="line">        ctx.pop(error)</span><br></pre></td></tr></table></figure></div><p>WSGI Server 每次在调用 Flask 对象的 <code>__call__</code> 方法时，都会将对应的请求信息入栈，并在请求处理完毕后将其出栈。入栈时，这一请求信息通过 <code>request_context</code> 方法，即通过 <code>RequestContext</code> 的构造方法被封装为一个 <code>RequestContext</code> 对象</p><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ctx.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RequestContext</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;The request context contains per-request information. The Flask</span></span><br><span class="line"><span class="string">    app creates and pushes it at the beginning of the request, then pops</span></span><br><span class="line"><span class="string">    it at the end of the request. It will create the URL adapter and</span></span><br><span class="line"><span class="string">    request object for the WSGI environment provided.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Do not attempt to use this class directly, instead use</span></span><br><span class="line"><span class="string">    :meth:`~flask.Flask.test_request_context` and</span></span><br><span class="line"><span class="string">    :meth:`~flask.Flask.request_context` to create this object.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    When the request context is popped, it will evaluate all the</span></span><br><span class="line"><span class="string">    functions registered on the application for teardown execution</span></span><br><span class="line"><span class="string">    (:meth:`~flask.Flask.teardown_request`).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The request context is automatically popped at the end of the</span></span><br><span class="line"><span class="string">    request. When using the interactive debugger, the context will be</span></span><br><span class="line"><span class="string">    restored so ``request`` is still accessible. Similarly, the test</span></span><br><span class="line"><span class="string">    client can preserve the context after the request ends. However,</span></span><br><span class="line"><span class="string">    teardown functions may already have closed some resources such as</span></span><br><span class="line"><span class="string">    database connections.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        app: Flask,</span></span><br><span class="line"><span class="params">        environ: WSGIEnvironment,</span></span><br><span class="line"><span class="params">        request: Request | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        session: SessionMixin | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="variable language_">self</span>.app = app</span><br><span class="line">        <span class="keyword">if</span> request <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            request = app.request_class(environ)</span><br><span class="line">            request.json_module = app.json</span><br><span class="line">        <span class="variable language_">self</span>.request: Request = request</span><br><span class="line">        <span class="variable language_">self</span>.url_adapter = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.url_adapter = app.create_url_adapter(<span class="variable language_">self</span>.request)</span><br><span class="line">        <span class="keyword">except</span> HTTPException <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>.request.routing_exception = e</span><br><span class="line">        <span class="variable language_">self</span>.flashes: <span class="built_in">list</span>[<span class="built_in">tuple</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]] | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.session: SessionMixin | <span class="literal">None</span> = session</span><br><span class="line">        <span class="comment"># Functions that should be executed after the request on the response</span></span><br><span class="line">        <span class="comment"># object.  These will be called before the regular &quot;after_request&quot;</span></span><br><span class="line">        <span class="comment"># functions.</span></span><br><span class="line">        <span class="variable language_">self</span>._after_request_functions: <span class="built_in">list</span>[ft.AfterRequestCallable[t.<span class="type">Any</span>]] = []</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>._cv_tokens: <span class="built_in">list</span>[</span><br><span class="line">            <span class="built_in">tuple</span>[contextvars.Token[RequestContext], AppContext | <span class="literal">None</span>]</span><br><span class="line">        ] = []</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">match_request</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Can be overridden by a subclass to hook into the matching</span></span><br><span class="line"><span class="string">        of the request.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = <span class="variable language_">self</span>.url_adapter.<span class="keyword">match</span>(return_rule=<span class="literal">True</span>)  <span class="comment"># type: ignore</span></span><br><span class="line">            <span class="variable language_">self</span>.request.url_rule, <span class="variable language_">self</span>.request.view_args = result  <span class="comment"># type: ignore</span></span><br><span class="line">        <span class="keyword">except</span> HTTPException <span class="keyword">as</span> e:</span><br><span class="line">            <span class="variable language_">self</span>.request.routing_exception = e</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">push</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># Before we push the request context we have to ensure that there</span></span><br><span class="line">        <span class="comment"># is an application context.</span></span><br><span class="line">        app_ctx = _cv_app.get(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> app_ctx <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> app_ctx.app <span class="keyword">is</span> <span class="keyword">not</span> <span class="variable language_">self</span>.app:</span><br><span class="line">            app_ctx = <span class="variable language_">self</span>.app.app_context()</span><br><span class="line">            app_ctx.push()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            app_ctx = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>._cv_tokens.append((_cv_request.<span class="built_in">set</span>(<span class="variable language_">self</span>), app_ctx))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Open the session at the moment that the request context is available.</span></span><br><span class="line">        <span class="comment"># This allows a custom open_session method to use the request context.</span></span><br><span class="line">        <span class="comment"># Only open a new session if this is the first time the request was</span></span><br><span class="line">        <span class="comment"># pushed, otherwise stream_with_context loses the session.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            session_interface = <span class="variable language_">self</span>.app.session_interface</span><br><span class="line">            <span class="variable language_">self</span>.session = session_interface.open_session(<span class="variable language_">self</span>.app, <span class="variable language_">self</span>.request)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="variable language_">self</span>.session = session_interface.make_null_session(<span class="variable language_">self</span>.app)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Match the request URL after loading the session, so that the</span></span><br><span class="line">        <span class="comment"># session is available in custom URL converters.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.url_adapter <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="variable language_">self</span>.match_request()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pop</span>(<span class="params">self, exc: BaseException | <span class="literal">None</span> = _sentinel</span>) -&gt; <span class="literal">None</span>:  <span class="comment"># type: ignore</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Pops the request context and unbinds it by doing that.  This will</span></span><br><span class="line"><span class="string">        also trigger the execution of functions registered by the</span></span><br><span class="line"><span class="string">        :meth:`~flask.Flask.teardown_request` decorator.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .. versionchanged:: 0.9</span></span><br><span class="line"><span class="string">           Added the `exc` argument.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        clear_request = <span class="built_in">len</span>(<span class="variable language_">self</span>._cv_tokens) == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> clear_request:</span><br><span class="line">                <span class="keyword">if</span> exc <span class="keyword">is</span> _sentinel:</span><br><span class="line">                    exc = sys.exc_info()[<span class="number">1</span>]</span><br><span class="line">                <span class="variable language_">self</span>.app.do_teardown_request(exc)</span><br><span class="line"></span><br><span class="line">                request_close = <span class="built_in">getattr</span>(<span class="variable language_">self</span>.request, <span class="string">&quot;close&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">                <span class="keyword">if</span> request_close <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    request_close()</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            ctx = _cv_request.get()</span><br><span class="line">            token, app_ctx = <span class="variable language_">self</span>._cv_tokens.pop()</span><br><span class="line">            _cv_request.reset(token)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># get rid of circular dependencies at the end of the request</span></span><br><span class="line">            <span class="comment"># so that we don&#x27;t require the GC to be active.</span></span><br><span class="line">            <span class="keyword">if</span> clear_request:</span><br><span class="line">                ctx.request.environ[<span class="string">&quot;werkzeug.request&quot;</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> app_ctx <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                app_ctx.pop(exc)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ctx <span class="keyword">is</span> <span class="keyword">not</span> <span class="variable language_">self</span>:</span><br><span class="line">                <span class="keyword">raise</span> AssertionError(</span><br><span class="line">                    <span class="string">f&quot;Popped wrong request context. (<span class="subst">&#123;ctx!r&#125;</span> instead of <span class="subst">&#123;self!r&#125;</span>)&quot;</span></span><br><span class="line">                )</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><p>因此，Flask 上下文的管理逻辑实际上为，当收到请求时，创建当前进程&#x2F;线程的上下文对象（<code>RequestContext</code> 对象），上下文对象在被创建时，会将 WSGI Server 传递的 <code>environ</code> 参数封装为一个 <code>Request</code> 对象并存储到上下文对象的 <code>request</code> 成员中。然后，Flask 将调用上下文对象的 <code>push</code> 方法，将自身压入到请求上下文的堆栈中</p><blockquote><p>上下文对象除了保存了 <code>request</code> 外，还保存了另外一个重要的上下文 <code>session</code> 。与 <code>request</code> 不同的是，在请求上下文对象创建时会被设置为 <code>None</code>，在请求上下文被推入到请求上下文堆栈时才会被创建</p></blockquote><p>进一步观察 Flask 在创建上下文时的行为，尤其是这几行代码</p><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app.py</span></span><br><span class="line">    app_ctx = _cv_app.get(<span class="literal">None</span>)</span><br><span class="line">    <span class="variable language_">self</span>._cv_tokens.append((_cv_request.<span class="built_in">set</span>(<span class="variable language_">self</span>), app_ctx))</span><br><span class="line">    ctx = _cv_request.get()</span><br></pre></td></tr></table></figure></div><p>我们能从这些感到熟悉的行为中联想到线程上下文中类似的操作方式。结合 globals.py 中创建变量时的类型注解，会发现，<code>_cv_app</code> 和 <code>_cv_request</code> 实际上就是存储各线程的线程上下文的 <code>LocalStack</code>。而 <code>app_ctx</code>, <code>current_app</code>, <code>g</code>, <code>request_ctx</code>, <code>request</code> 和 <code>session</code> 这六个由 <code>LocalProxy</code> 的构造方法所创建的全局变量，实际上是类似于某种动态指针。它们所引用的对象由 <code>LocalProxy</code> 自动获取，当它们被使用时则是通过触发 <code>LocalProxy</code> 的魔术方法自行查找并返回</p><p>因此，在理解了这些全局变量的实际作用后，Flask 的上下文管理方式就更加清晰了。在每次从 WSGI Server 接收请求时，Flask 创建当前进程&#x2F;线程需要处理的两个包含了对应上下文具体信息的上下文对象，并将它们 push 到线程隔离的栈中。当视图函数需要读取上下文进行响应处理时，则通过 <code>LocalProxy</code> 代理从栈中动态地获取上下文对象中保存的包含了对应信息的具体对象，并在处理结束后将上下文对象 pop 出栈清理内存</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>让我引用一下 <a href="#reference">flask 工作原理与机制解析</a> 中的一段话作为这篇博客的结尾</p><blockquote><p>Flask 中的上下文由表示请求上下文的 RequestContext 类实例和表示程序上下文的 AppContext 类实例组成。请求上下文对象存储在请求上下文堆栈中，程序上下文对象存储在程序上下文堆栈中。<br>当一个请求发来的时候：<br>1）需要保存请求相关的信息——有了请求上下文<br>2）为了更好地分离程序的状态，应用起来更加灵活——有了程序上下文<br>3）为了让上下文对象可以在全局动态访问，而不用显式地传入视图函数，同时确保线程安全——有了 Local（本地线程）<br>4）为了支持多个程序——有了 LocalStack（本地堆栈）<br>5）为了支持动态获取上下文对象——有了 LocalProxy（本地代理）<br>6）……<br>7）为了让这一切愉快的工作在一起——有了 Flask</p></blockquote><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/pallets/flask">Flask Repo<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://flask.palletsprojects.com/en/2.0.x/">Flask<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/pallets/werkzeug">WerkZeug<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.tonyseek.com/post/the-context-mechanism-of-flask/">Flask 的 Context 机制<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/baidu_33387365/article/details/108339983">flask 工作原理与机制解析<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="http://flask.pocoo.org/docs/appcontext/">Flask Document about Application Context<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="http://flask.pocoo.org/docs/reqcontext/">Flask Document about Request Context<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p></div><div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8"><div class="article-copyright-info-container"><ul><li><strong>Title:</strong> RE:从0开始阅读Flask源码 Ⅳ</li><li><strong>Author:</strong> 7erry</li><li><strong>Created at :</strong> 2024-05-10 22:26:02</li><li><strong>Updated at :</strong> 2024-05-10 22:26:02</li><li><strong>Link:</strong> https://7erryx.github.io/2024/05/10/Tech Blog/RE-从0开始阅读Flask源码-Ⅳ/</li><li><strong>License: </strong>This work is licensed under <a class="license" target="_blank" rel="noopener external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.</li></ul></div></div><div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8"><div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="prev" rel="prev" href="/2024/07/07/Vulnerability%20Investigation/CVE-2010-2883-Investigation/"><span class="left arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-left"></i> </span><span class="title flex justify-center items-center"><span class="post-nav-title-item truncate max-w-48">CVE-2010-2883 Investigation</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="next" rel="next" href="/2024/04/24/Tech%20Blog/RE-%E4%BB%8E0%E5%BC%80%E5%A7%8B%E9%98%85%E8%AF%BBFlask%E6%BA%90%E7%A0%81-%E2%85%A2/"><span class="title flex justify-center items-center"><span class="post-nav-title-item truncate max-w-48">RE:从0开始阅读Flask源码 Ⅲ</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-right"></i></span></a></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><div class="toc-title">On this page</div><div class="page-title">RE:从0开始阅读Flask源码 Ⅳ</div><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Flask-%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-text">Flask 上下文的实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E4%B8%8E-WerkZeug-%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-text">线程上下文与 WerkZeug 上下文的实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Flask-%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E7%AE%A1%E7%90%86"><span class="nav-text">Flask 上下文的管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-text">Reference</span></a></li></ol></div></div></div></div></div></div><div class="main-content-footer"><footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color"><div class="info-container py-3 text-center"><div class="text-center">&copy; <span>2020</span> - 2025&nbsp;&nbsp;<i class="fa-regular fa-computer-classic"></i>&nbsp;&nbsp;<a href="/">7erry</a><p class="post-count space-x-0.5"><span>72 posts in total </span><span>219.3k words in total</span></p></div><script data-swup-reload-script src="https://cn.vercount.one/js"></script><div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right"><span id="busuanzi_container_site_uv" class="lg:!block"><span class="text-sm">VISITOR COUNT</span> <span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" class="lg:!block"><span class="text-sm">TOTAL PAGE VIEWS</span> <span id="busuanzi_value_site_pv"></span></span></div><div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left"><span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io" rel="external nofollow noreferrer">Hexo</a></span> <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine" rel="external nofollow noreferrer">Redefine v2.8.4</a></span></div><div>Blog up for <span class="odometer" id="runtime_days"></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec</div><script data-swup-reload-script>try{function odometer_init(){document.querySelectorAll(".odometer").forEach(e=>{new Odometer({el:e,format:"( ddd).dd",duration:200})})}odometer_init()}catch(e){}</script></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="article-tools-list"><li class="right-bottom-tools page-aside-toggle"><i class="fa-regular fa-outdent"></i></li></ul></div></div><div class="right-side-tools-container"><div class="side-tools-container"><ul class="hidden-tools-list"><li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-plus"></i></li><li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-minus"></i></li><li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center"><i class="fa-regular fa-moon"></i></li><li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center"><i class="fa-regular fa-arrow-down"></i></li></ul><ul class="visible-tools-list"><li class="right-bottom-tools toggle-tools-list flex justify-center items-center"><i class="fa-regular fa-cog fa-spin"></i></li><li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fa-solid fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa-solid fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="/js/build/libs/Swup.min.js"></script><script src="/js/build/libs/SwupSlideTheme.min.js"></script><script src="/js/build/libs/SwupScriptsPlugin.min.js"></script><script src="/js/build/libs/SwupProgressPlugin.min.js"></script><script src="/js/build/libs/SwupScrollPlugin.min.js"></script><script src="/js/build/libs/SwupPreloadPlugin.min.js"></script><script>const swup=new Swup({plugins:[new SwupScriptsPlugin({optin:!0}),new SwupProgressPlugin,new SwupScrollPlugin({offset:80}),new SwupSlideTheme({mainElement:".main-content-body"}),new SwupPreloadPlugin],containers:["#swup"]})</script><script src="/js/build/tools/imageViewer.js" type="module"></script><script src="/js/build/utils.js" type="module"></script><script src="/js/build/main.js" type="module"></script><script src="/js/build/layouts/navbarShrink.js" type="module"></script><script src="/js/build/tools/scrollTopBottom.js" type="module"></script><script src="/js/build/tools/lightDarkSwitch.js" type="module"></script><script src="/js/build/layouts/categoryList.js" type="module"></script><script src="/js/build/tools/localSearch.js" type="module"></script><script src="/js/build/tools/codeBlock.js" type="module"></script><script src="/js/build/layouts/lazyload.js" type="module"></script><script src="/js/build/tools/runtime.js"></script><script src="/js/build/libs/odometer.min.js"></script><link rel="stylesheet" href="/assets/odometer-theme-minimal.css"><script src="/js/build/libs/Typed.min.js"></script><script src="/js/build/plugins/typed.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js"></script><script src="/js/build/plugins/mermaid.js"></script><script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script><script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script><script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script><script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script><script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script></body></html>